<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no,viewport-fit=cover">
<title>–Ø–Ω–¥–µ–∫—Å –ï–¥–∞</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<style>
:root {
  --red: #FC3F1D;
  --red-d: #E8331A;
  --bg: #F5F4F2;
  --white: #fff;
  --text: #21201F;
  --sec: #9E9B98;
  --border: #E0DEDA;
  --green: #1E8B24;
  --blue: #0F7DE8;
  --r: 16px;
  --rs: 10px;
  --bh: 52px;
  --safe-b: env(safe-area-inset-bottom, 0px);
}
*{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent}
html,body{height:100%;overscroll-behavior:none}
body{font-family:-apple-system,'SF Pro Text','Helvetica Neue',sans-serif;background:var(--bg);color:var(--text);overflow-x:hidden}

.scr{display:none;min-height:100vh;animation:fadeIn .2s ease}
.scr.on{display:block}
@keyframes fadeIn{from{opacity:.6;transform:translateY(4px)}to{opacity:1;transform:none}}

.hdr{position:sticky;top:0;z-index:100;background:var(--white);border-bottom:1px solid var(--border);display:flex;align-items:center;gap:10px;padding:11px 16px;min-height:52px}
.hdr-title{font-size:17px;font-weight:600;flex:1}
.hdr-sub{font-size:12px;color:var(--sec)}
.back{width:36px;height:36px;border-radius:50%;background:var(--bg);border:none;cursor:pointer;display:flex;align-items:center;justify-content:center;flex-shrink:0}

.bnav{position:fixed;bottom:0;left:0;right:0;z-index:200;background:var(--white);border-top:1px solid var(--border);display:flex;padding-bottom:var(--safe-b)}
.bn{flex:1;display:flex;flex-direction:column;align-items:center;gap:3px;padding:10px 0;border:none;background:none;cursor:pointer;color:var(--sec);font-size:10px;font-weight:500;transition:color .15s}
.bn.on{color:var(--red)}
.bn svg{transition:transform .15s}
.bn.on svg{transform:scale(1.1)}

.page{padding-bottom:calc(62px + var(--safe-b))}

.loader{display:flex;flex-direction:column;align-items:center;gap:12px;padding:60px 20px}
.spin{width:34px;height:34px;border:3px solid var(--border);border-top-color:var(--red);border-radius:50%;animation:sp .7s linear infinite}
@keyframes sp{to{transform:rotate(360deg)}}
.loader-t{font-size:14px;color:var(--sec)}

.err-box{margin:16px;padding:14px;border-radius:var(--r);background:#FFF3F0;border:1px solid #FFCDC5;font-size:14px;color:#C0392B;line-height:1.5}

.search-wrap{padding:10px 16px;background:var(--white);border-bottom:1px solid var(--border)}
.search{width:100%;height:40px;padding:0 12px 0 38px;border:none;border-radius:var(--rs);background:var(--bg);font-size:15px;outline:none;
  background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='none'%3E%3Ccircle cx='7' cy='7' r='5.5' stroke='%239E9B98' stroke-width='1.5'/%3E%3Cpath d='m13 13-2.5-2.5' stroke='%239E9B98' stroke-width='1.5' stroke-linecap='round'/%3E%3C/svg%3E");
  background-repeat:no-repeat;background-position:12px center}

.addr-bar{background:var(--white);padding:11px 16px;display:flex;align-items:center;gap:10px;border-bottom:1px solid var(--border);cursor:pointer}
.addr-bar .av{flex:1;min-width:0}
.addr-bar .al{font-size:11px;color:var(--sec)}
.addr-bar .at{font-size:15px;font-weight:500;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}

.sec-t{padding:18px 16px 10px;font-size:20px;font-weight:700}
.sec-t2{font-size:16px;font-weight:600;padding:16px 16px 8px}

.r-list{padding:0 16px 16px;display:flex;flex-direction:column;gap:12px}
.r-card{background:var(--white);border-radius:var(--r);overflow:hidden;cursor:pointer;box-shadow:0 1px 4px rgba(0,0,0,.07);transition:transform .12s,box-shadow .12s}
.r-card:active{transform:scale(.98);box-shadow:0 1px 2px rgba(0,0,0,.05)}
.r-img{width:100%;height:156px;object-fit:cover;background:var(--bg)}
.r-img-ph{width:100%;height:156px;background:linear-gradient(135deg,#f0ede8,#e0dbd3);display:flex;align-items:center;justify-content:center;font-size:50px}
.r-body{padding:12px 14px 14px}
.r-name{font-size:16px;font-weight:600;margin-bottom:4px}
.r-meta{display:flex;align-items:center;gap:7px;font-size:13px;color:var(--sec)}
.dot{width:3px;height:3px;border-radius:50%;background:var(--sec)}
.r-tags{display:flex;gap:5px;flex-wrap:wrap;margin-top:7px}
.tag{padding:3px 8px;border-radius:6px;background:var(--bg);font-size:12px;color:var(--sec)}
.tag.g{background:#EDFBEE;color:var(--green)}
.tag.r{background:#FFF0ED;color:var(--red)}

.menu-hero{width:100%;height:190px;object-fit:cover;display:block}
.menu-hero-ph{width:100%;height:190px;background:linear-gradient(135deg,#f0ede8,#e0dbd3);display:flex;align-items:center;justify-content:center;font-size:60px}
.menu-info{background:var(--white);padding:14px 16px}
.menu-info h1{font-size:21px;font-weight:700}
.menu-info .mm{font-size:13px;color:var(--sec);margin-top:4px;display:flex;gap:10px;align-items:center;flex-wrap:wrap}

.cats{display:flex;gap:8px;padding:11px 16px;overflow-x:auto;scrollbar-width:none;background:var(--white);border-bottom:1px solid var(--border);position:sticky;top:52px;z-index:50}
.cats::-webkit-scrollbar{display:none}
.cat{padding:7px 14px;border-radius:20px;border:none;background:var(--bg);font-size:14px;font-weight:500;cursor:pointer;white-space:nowrap;color:var(--sec);transition:background .15s,color .15s}
.cat.on{background:var(--text);color:#fff}

.menu-sec{padding:0 16px}
.menu-sec-t{font-size:18px;font-weight:700;padding:18px 0 10px}
.m-items{display:flex;flex-direction:column;gap:1px;margin-bottom:16px}
.m-item{background:var(--white);display:flex;align-items:center;gap:11px;padding:13px;cursor:pointer}
.m-item:first-child{border-radius:var(--r) var(--r) 0 0}
.m-item:last-child{border-radius:0 0 var(--r) var(--r)}
.m-item:only-child{border-radius:var(--r)}
.m-item:active{background:var(--bg)}
.m-img{width:78px;height:78px;border-radius:11px;object-fit:cover;background:var(--bg);flex-shrink:0}
.m-img-ph{width:78px;height:78px;border-radius:11px;background:var(--bg);display:flex;align-items:center;justify-content:center;font-size:30px;flex-shrink:0}
.m-info{flex:1;min-width:0}
.m-name{font-size:15px;font-weight:500;margin-bottom:3px}
.m-desc{font-size:13px;color:var(--sec);line-height:1.35;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden;margin-bottom:5px}
.m-price{font-size:15px;font-weight:600}
.add-btn{width:36px;height:36px;border-radius:50%;background:var(--red);color:#fff;border:none;font-size:22px;cursor:pointer;flex-shrink:0;display:flex;align-items:center;justify-content:center;transition:transform .1s,background .1s}
.add-btn:active{transform:scale(.88);background:var(--red-d)}
.qty{display:flex;align-items:center;gap:7px;flex-shrink:0}
.qb{width:30px;height:30px;border-radius:50%;background:var(--bg);border:none;cursor:pointer;font-size:17px;font-weight:700;display:flex;align-items:center;justify-content:center;color:var(--text)}
.qn{font-size:15px;font-weight:600;min-width:18px;text-align:center}

.cart-fab{position:fixed;bottom:calc(62px + var(--safe-b) + 12px);left:16px;right:16px;z-index:150}
.cart-fab-btn{width:100%;height:var(--bh);background:var(--red);color:#fff;border:none;border-radius:var(--r);font-size:16px;font-weight:600;cursor:pointer;display:flex;align-items:center;justify-content:space-between;padding:0 20px;box-shadow:0 4px 20px rgba(252,63,29,.4);transition:background .15s,transform .1s}
.cart-fab-btn:active{background:var(--red-d);transform:scale(.98)}
.cfb-c{background:rgba(255,255,255,.25);border-radius:8px;padding:4px 10px;font-size:14px}

.cart-list{padding:10px 16px;display:flex;flex-direction:column;gap:1px}
.ci{background:var(--white);display:flex;align-items:center;gap:11px;padding:13px}
.ci:first-child{border-radius:var(--r) var(--r) 0 0}
.ci:last-child{border-radius:0 0 var(--r) var(--r)}
.ci:only-child{border-radius:var(--r)}
.ci-img{width:54px;height:54px;border-radius:9px;object-fit:cover;background:var(--bg);flex-shrink:0}
.ci-name{flex:1;font-size:15px}
.ci-p{font-size:13px;color:var(--sec);margin-top:2px}

.card{background:var(--white);border-radius:var(--r);overflow:hidden;margin:0 16px 12px}
.card-row{display:flex;align-items:center;justify-content:space-between;padding:13px 16px;border-bottom:1px solid var(--border)}
.card-row:last-child{border-bottom:none}
.card-row-lbl{font-size:15px}
.card-row-val{font-size:15px;font-weight:500}
.card-row-val.g{color:var(--green)}
.card-row-val.total{font-size:17px;font-weight:700}
.card-row-val.s{color:var(--sec)}
.card-btn{display:flex;align-items:center;justify-content:space-between;padding:13px 16px;border-bottom:1px solid var(--border);cursor:pointer;background:none;border-top:none;border-left:none;border-right:none;width:100%;text-align:left}
.card-btn:last-child{border-bottom:none}
.card-btn:active{background:var(--bg)}
.cb-l{font-size:15px;color:var(--text)}
.cb-v{font-size:14px;color:var(--sec);display:flex;align-items:center;gap:5px}

.promo-wrap{display:flex;gap:9px;padding:10px 16px 0}
.promo-in{flex:1;height:44px;padding:0 13px;border:1.5px solid var(--border);border-radius:var(--rs);font-size:15px;outline:none;background:var(--white);transition:border-color .2s}
.promo-in:focus{border-color:var(--red)}
.promo-btn{height:44px;padding:0 16px;background:var(--text);color:#fff;border:none;border-radius:var(--rs);font-size:14px;font-weight:600;cursor:pointer;white-space:nowrap}
.promo-btn:active{background:#3a3a3a}
.promo-msg{padding:7px 16px 0;font-size:13px}
.promo-msg.ok{color:var(--green)}
.promo-msg.er{color:var(--red)}

.pay-m{background:var(--white);display:flex;align-items:center;gap:13px;padding:13px 16px;cursor:pointer;transition:background .1s;border-bottom:1px solid var(--border)}
.pay-m:last-child{border-bottom:none}
.pay-m:first-child{border-radius:var(--r) var(--r) 0 0}
.pay-m:last-child{border-radius:0 0 var(--r) var(--r)}
.pay-m:active{background:var(--bg)}
.pay-ico{width:42px;height:30px;border-radius:5px;background:var(--bg);display:flex;align-items:center;justify-content:center;font-size:17px;flex-shrink:0}
.pay-nm{flex:1;font-size:15px}
.pay-sub{font-size:12px;color:var(--sec);margin-top:2px}
.pay-chk{width:22px;height:22px;border-radius:50%;border:2px solid var(--border);display:flex;align-items:center;justify-content:center;flex-shrink:0;transition:background .15s,border-color .15s}
.pay-m.sel .pay-chk{background:var(--red);border-color:var(--red)}

.pers{display:flex;align-items:center;gap:11px}
.pb{width:32px;height:32px;border-radius:50%;background:var(--bg);border:none;cursor:pointer;font-size:18px;font-weight:700;display:flex;align-items:center;justify-content:center;color:var(--text)}
.pb:active{background:var(--border)}
.pn{font-size:16px;font-weight:600;min-width:22px;text-align:center}

.cmt-ta{width:100%;min-height:72px;padding:10px 12px;border:1.5px solid var(--border);border-radius:var(--rs);font-size:15px;resize:none;outline:none;background:var(--white);font-family:inherit;line-height:1.5;transition:border-color .2s}
.cmt-ta:focus{border-color:var(--red)}
.chips{display:flex;gap:7px;flex-wrap:wrap;padding:6px 0 0}
.chip{padding:5px 12px;border-radius:20px;border:1.5px solid var(--border);background:var(--white);font-size:13px;cursor:pointer;font-weight:500;transition:all .15s}
.chip.on{background:var(--text);color:#fff;border-color:var(--text)}

/* ‚îÄ‚îÄ ADDRESS ‚îÄ‚îÄ */
.addr-in{width:100%;height:44px;padding:0 12px 0 36px;border:1.5px solid var(--border);border-radius:var(--rs);font-size:15px;outline:none;background:var(--bg);transition:border-color .2s;
  background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='20' fill='none'%3E%3Cpath d='M8 0C4.7 0 2 2.7 2 6c0 4.5 6 11 6 11S14 10.5 14 6C14 2.7 11.3 0 8 0zm0 8.5A2.5 2.5 0 1 1 8 3.5a2.5 2.5 0 0 1 0 5z' fill='%23FC3F1D'/%3E%3C/svg%3E");
  background-repeat:no-repeat;background-position:10px center}
.addr-in:focus{border-color:var(--red);background-color:var(--white)}
.sug-list{background:var(--white)}
.sug{padding:13px 16px;border-bottom:1px solid var(--border);cursor:pointer;display:flex;align-items:flex-start;gap:11px}
.sug:last-child{border-bottom:none}
.sug:active{background:var(--bg)}
.sug-t{font-size:15px;font-weight:500}
.sug-s{font-size:13px;color:var(--sec);margin-top:2px}
.map-wrap{height:200px;background:#e8e4dc;position:relative}
#ymap{width:100%;height:100%}
.addr-flds{padding:14px 16px;display:flex;flex-direction:column;gap:9px}
.fld{display:flex;flex-direction:column;gap:3px}
.fld label{font-size:11px;color:var(--sec);font-weight:500;text-transform:uppercase;letter-spacing:.3px}
.fld input{height:42px;padding:0 11px;border:1.5px solid var(--border);border-radius:var(--rs);font-size:15px;outline:none;background:var(--white);transition:border-color .2s}
.fld input:focus{border-color:var(--red)}
.fld-row{display:flex;gap:9px}
.fld-row .fld{flex:1}

.status-wrap{display:flex;flex-direction:column;align-items:center;padding:36px 20px;gap:0}
.s-icon{width:80px;height:80px;border-radius:50%;background:var(--bg);display:flex;align-items:center;justify-content:center;font-size:38px;margin-bottom:18px}
.s-icon.pulse{animation:pulse 1.5s ease-in-out infinite}
@keyframes pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.06)}}
.s-title{font-size:22px;font-weight:700;text-align:center;margin-bottom:8px}
.s-desc{font-size:15px;color:var(--sec);text-align:center;line-height:1.5;margin-bottom:6px}
.s-oid{font-size:13px;color:var(--sec)}
.sbp-card{width:100%;background:var(--white);border-radius:var(--r);padding:18px;margin-top:20px;text-align:center}
.sbp-title{font-size:16px;font-weight:600;margin-bottom:4px}
.sbp-desc{font-size:13px;color:var(--sec);line-height:1.5;margin-bottom:14px}
.sbp-btn{width:100%;height:48px;background:var(--blue);color:#fff;border:none;border-radius:var(--r);font-size:16px;font-weight:600;cursor:pointer;transition:background .15s}
.sbp-btn:active{background:#0c5fc4}

/* ‚îÄ‚îÄ PROFILE ‚îÄ‚îÄ */
.profile-head{background:var(--white);padding:20px 16px;display:flex;align-items:center;gap:14px;border-bottom:1px solid var(--border)}
.avatar{width:62px;height:62px;border-radius:50%;background:linear-gradient(135deg,var(--red),#ff6b4a);display:flex;align-items:center;justify-content:center;font-size:26px;color:#fff;font-weight:700;flex-shrink:0}
.prf-name{font-size:19px;font-weight:700}
.prf-uid{font-size:13px;color:var(--sec);margin-top:2px}
.prf-status{display:flex;gap:8px;margin-top:6px;flex-wrap:wrap}
.prf-badge{padding:3px 10px;border-radius:12px;font-size:12px;font-weight:600}
.prf-badge.g{background:#EDFBEE;color:var(--green)}
.prf-badge.r{background:#FFF0ED;color:var(--red)}
.prf-badge.b{background:#EFF6FF;color:var(--blue)}
.menu-list{margin:12px 16px;background:var(--white);border-radius:var(--r);overflow:hidden}
.ml-item{display:flex;align-items:center;gap:13px;padding:14px 16px;border-bottom:1px solid var(--border);cursor:pointer;transition:background .1s}
.ml-item:last-child{border-bottom:none}
.ml-item:active{background:var(--bg)}
.ml-ico{width:38px;height:38px;border-radius:10px;background:var(--bg);display:flex;align-items:center;justify-content:center;font-size:18px;flex-shrink:0}
.ml-txt{flex:1;font-size:15px;font-weight:500}
.ml-arr{color:var(--sec)}

/* ‚îÄ‚îÄ ORDERS ‚îÄ‚îÄ */
.ord-list{padding:10px 16px;display:flex;flex-direction:column;gap:10px}
.ord-card{background:var(--white);border-radius:var(--r);overflow:hidden;cursor:pointer;box-shadow:0 1px 3px rgba(0,0,0,.06)}
.ord-card:active{transform:scale(.99)}
.ord-head{padding:14px 16px;display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid var(--border)}
.ord-rest{font-size:15px;font-weight:600}
.ord-date{font-size:13px;color:var(--sec)}
.ord-body{padding:12px 16px}
.ord-items{font-size:14px;color:var(--sec);margin-bottom:6px;line-height:1.4}
.ord-footer{display:flex;align-items:center;justify-content:space-between}
.ord-price{font-size:16px;font-weight:700}
.ord-status{font-size:13px;padding:3px 10px;border-radius:10px;font-weight:500}
.ord-status.done{background:#EDFBEE;color:var(--green)}
.ord-status.wait{background:#FFF0ED;color:var(--red)}
.ord-status.del{background:#EFF6FF;color:var(--blue)}
.ord-repeat{width:100%;height:42px;background:var(--bg);color:var(--text);border:none;border-radius:var(--rs);font-size:14px;font-weight:600;cursor:pointer;margin-top:10px;transition:background .15s}
.ord-repeat:active{background:var(--border)}

/* ‚îÄ‚îÄ PAYMENT METHODS SCREEN ‚îÄ‚îÄ */
.pay-screen-item{background:var(--white);display:flex;align-items:center;gap:13px;padding:15px 16px;border-bottom:1px solid var(--border);cursor:pointer}
.pay-screen-item:first-child{border-radius:var(--r) var(--r) 0 0}
.pay-screen-item:last-child{border-bottom:none;border-radius:0 0 var(--r) var(--r)}
.pay-screen-item:active{background:var(--bg)}
.pay-screen-ico{width:48px;height:34px;border-radius:8px;background:var(--bg);display:flex;align-items:center;justify-content:center;font-size:20px;flex-shrink:0}
.pay-screen-name{flex:1}
.pay-screen-title{font-size:16px;font-weight:500}
.pay-screen-sub{font-size:13px;color:var(--sec);margin-top:2px}
.pay-screen-chk{width:22px;height:22px;border-radius:50%;border:2px solid var(--border);flex-shrink:0}
.pay-screen-item.sel .pay-screen-chk{background:var(--red);border-color:var(--red)}

.bot-wrap{padding:12px 16px calc(12px + var(--safe-b))}
.btn{width:100%;height:var(--bh);background:var(--red);color:#fff;border:none;border-radius:var(--r);font-size:16px;font-weight:600;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:8px;transition:background .15s,transform .1s}
.btn:active{background:var(--red-d);transform:scale(.98)}
.btn:disabled{background:var(--border);color:var(--sec);transform:none;cursor:default}
.btn.sec{background:var(--bg);color:var(--text)}
.btn.sec:active{background:var(--border)}

.gap{height:14px}

.toast{position:fixed;bottom:calc(70px + var(--safe-b));left:50%;transform:translateX(-50%);background:rgba(33,32,31,.92);color:#fff;padding:10px 20px;border-radius:22px;font-size:14px;z-index:9999;pointer-events:none;opacity:0;transition:opacity .3s;white-space:nowrap;max-width:calc(100vw - 40px);text-align:center}
.toast.on{opacity:1}

.empty{text-align:center;padding:50px 20px;color:var(--sec);font-size:15px}
.empty-ico{font-size:48px;margin-bottom:12px}

/* item detail modal */
.modal-bg{position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:500;display:none;align-items:flex-end}
.modal-bg.on{display:flex}
.modal{background:var(--white);border-radius:20px 20px 0 0;width:100%;max-height:85vh;overflow-y:auto;padding-bottom:calc(16px + var(--safe-b));animation:slideUp .25s ease}
@keyframes slideUp{from{transform:translateY(100%)}to{transform:none}}
.modal-img{width:100%;height:220px;object-fit:cover}
.modal-img-ph{width:100%;height:220px;background:linear-gradient(135deg,#f0ede8,#e0dbd3);display:flex;align-items:center;justify-content:center;font-size:70px}
.modal-body{padding:16px}
.modal-name{font-size:20px;font-weight:700;margin-bottom:6px}
.modal-desc{font-size:14px;color:var(--sec);line-height:1.5;margin-bottom:12px}
.modal-price{font-size:22px;font-weight:700;color:var(--red);margin-bottom:16px}
.modal-close{position:absolute;top:14px;right:14px;width:32px;height:32px;border-radius:50%;background:rgba(0,0,0,.4);border:none;color:#fff;font-size:18px;cursor:pointer;display:flex;align-items:center;justify-content:center}
.modal-footer{display:flex;align-items:center;gap:12px;padding:0 16px}
.modal-qty{display:flex;align-items:center;gap:12px;background:var(--bg);border-radius:var(--rs);padding:8px 12px}
.modal-add{flex:1;height:48px;background:var(--red);color:#fff;border:none;border-radius:var(--rs);font-size:16px;font-weight:600;cursor:pointer}
</style>
</head>
<body>

<div class="toast" id="toast"></div>

<!-- item modal -->
<div class="modal-bg" id="item-modal" onclick="closeModal(event)">
  <div class="modal" style="position:relative">
    <div id="modal-hero"></div>
    <button class="modal-close" onclick="$('item-modal').classList.remove('on')">‚úï</button>
    <div class="modal-body">
      <div class="modal-name" id="modal-name"></div>
      <div class="modal-desc" id="modal-desc"></div>
      <div class="modal-price" id="modal-price"></div>
    </div>
    <div class="modal-footer">
      <div class="modal-qty">
        <button class="qb" onclick="modalQty(-1)">‚àí</button>
        <span class="qn" id="modal-qty-n">1</span>
        <button class="qb" onclick="modalQty(1)">+</button>
      </div>
      <button class="modal-add" id="modal-add-btn" onclick="modalAdd()">–í –∫–æ—Ä–∑–∏–Ω—É</button>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê CATALOG ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="scr on" id="s-catalog">
  <div class="hdr" style="justify-content:space-between">
    <div><div class="hdr-title">–Ø–Ω–¥–µ–∫—Å –ï–¥–∞</div></div>
    <div id="hdr-name" style="font-size:14px;color:var(--sec)"></div>
  </div>
  <div class="addr-bar" onclick="nav('address','catalog')">
    <svg width="16" height="20" fill="none"><path d="M8 0C4.7 0 2 2.7 2 6c0 4.5 6 11 6 11S14 10.5 14 6C14 2.7 11.3 0 8 0zm0 8.5A2.5 2.5 0 1 1 8 3.5a2.5 2.5 0 0 1 0 5z" fill="#FC3F1D"/></svg>
    <div class="av"><div class="al">–î–æ—Å—Ç–∞–≤–∏—Ç—å –ø–æ –∞–¥—Ä–µ—Å—É</div><div class="at" id="addr-top">–£–∫–∞–∂–∏—Ç–µ –∞–¥—Ä–µ—Å –¥–æ—Å—Ç–∞–≤–∫–∏</div></div>
    <svg width="7" height="12" fill="none"><path d="M1 1l5 5-5 5" stroke="#9E9B98" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
  </div>
  <div class="search-wrap">
    <input class="search" id="search" type="text" placeholder="–†–µ—Å—Ç–æ—Ä–∞–Ω—ã –∏ –º–∞–≥–∞–∑–∏–Ω—ã" oninput="filterR(this.value)">
  </div>
  <div class="sec-t">–†—è–¥–æ–º —Å –≤–∞–º–∏</div>
  <div class="r-list page" id="r-list">
    <div class="loader"><div class="spin"></div><div class="loader-t">–ó–∞–≥—Ä—É–∂–∞–µ–º —Ä–µ—Å—Ç–æ—Ä–∞–Ω—ã...</div></div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê MENU ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="scr" id="s-menu">
  <div class="hdr">
    <button class="back" onclick="nav('catalog')">
      <svg width="9" height="16" fill="none"><path d="M8 1L1 8l7 7" stroke="#21201F" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
    </button>
    <div class="hdr-title" id="menu-hdr-name">–ú–µ–Ω—é</div>
  </div>
  <div id="menu-hero-wrap"></div>
  <div class="menu-info">
    <h1 id="menu-name">–†–µ—Å—Ç–æ—Ä–∞–Ω</h1>
    <div class="mm">
      <span id="menu-rating"></span>
      <span id="menu-time"></span>
      <span id="menu-deliv"></span>
    </div>
  </div>
  <div class="cats" id="menu-cats"></div>
  <div class="page" id="menu-content">
    <div class="loader"><div class="spin"></div><div class="loader-t">–ó–∞–≥—Ä—É–∂–∞–µ–º –º–µ–Ω—é...</div></div>
  </div>
  <div class="cart-fab" id="cart-fab" style="display:none">
    <button class="cart-fab-btn" onclick="nav('cart')">
      <span id="fab-cnt" class="cfb-c">0</span>
      <span>–ö–æ—Ä–∑–∏–Ω–∞</span>
      <span id="fab-price">0 ‚ÇΩ</span>
    </button>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê CART ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="scr" id="s-cart">
  <div class="hdr">
    <button class="back" id="cart-back"></button>
    <div><div class="hdr-title">–ö–æ—Ä–∑–∏–Ω–∞</div></div>
  </div>
  <div class="addr-bar" onclick="nav('address','cart')">
    <svg width="16" height="18" fill="none"><path d="M8 0C5.2 0 3 2.2 3 5c0 3.7 5 9 5 9s5-5.3 5-9c0-2.8-2.2-5-5-5zm0 6.5a1.5 1.5 0 1 1 0-3 1.5 1.5 0 0 1 0 3z" fill="#9E9B98"/></svg>
    <div class="av"><div class="al">–ê–¥—Ä–µ—Å –¥–æ—Å—Ç–∞–≤–∫–∏</div><div class="at" id="addr-cart">–£–∫–∞–∂–∏—Ç–µ –∞–¥—Ä–µ—Å</div></div>
    <svg width="7" height="12" fill="none"><path d="M1 1l5 5-5 5" stroke="#9E9B98" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
  </div>
  <div class="cart-list" id="cart-list"></div>

  <!-- –ø—Ä–æ–º–æ–∫–æ–¥ -->
  <div id="promo-section" style="margin:0 16px 12px">
    <div class="card" style="margin:0">
      <button class="card-btn" onclick="togglePromo()">
        <span class="cb-l">–ü—Ä–æ–º–æ–∫–æ–¥</span>
        <span class="cb-v" id="promo-display">–î–æ–±–∞–≤–∏—Ç—å <svg width="7" height="12" fill="none"><path d="M1 1l5 5-5 5" stroke="#9E9B98" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg></span>
      </button>
    </div>
    <div id="promo-block" style="display:none;background:var(--white);border-radius:0 0 var(--r) var(--r);border:1px solid var(--border);border-top:none;padding-bottom:12px">
      <div class="promo-wrap">
        <input class="promo-in" id="promo-in" type="text" placeholder="–í–≤–µ–¥–∏—Ç–µ –ø—Ä–æ–º–æ–∫–æ–¥" autocomplete="off" autocapitalize="characters">
        <button class="promo-btn" onclick="applyPromo()">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
      </div>
      <div class="promo-msg" id="promo-msg"></div>
    </div>
  </div>

  <div class="gap"></div>

  <!-- –æ–ø–ª–∞—Ç–∞ -->
  <div class="sec-t2">–°–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã</div>
  <div id="pay-methods" style="margin:0 16px 12px;border-radius:var(--r);overflow:hidden">
  </div>

  <div class="gap"></div>

  <!-- –ø—Ä–∏–±–æ—Ä—ã + –∫–æ–º–º–µ–Ω—Ç -->
  <div class="card" style="margin:0 16px 12px">
    <div class="card-row">
      <span class="card-row-lbl">–ü—Ä–∏–±–æ—Ä—ã</span>
      <div class="pers">
        <button class="pb" onclick="cPers(-1)">‚àí</button>
        <span class="pn" id="pers-n">2</span>
        <button class="pb" onclick="cPers(1)">+</button>
      </div>
    </div>
    <div style="padding:12px 16px">
      <div style="font-size:13px;color:var(--sec);margin-bottom:7px">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</div>
      <textarea class="cmt-ta" id="cmt" placeholder="–ü–æ–∂–µ–ª–∞–Ω–∏—è –∫ –∑–∞–∫–∞–∑—É..."></textarea>
      <div class="chips">
        <div class="chip" onclick="addCmt('–ü–æ–±–æ–ª—å—à–µ —Å–æ—É—Å–∞')">–ü–æ–±–æ–ª—å—à–µ —Å–æ—É—Å–∞</div>
        <div class="chip" onclick="addCmt('–ë–µ–∑ –ª—É–∫–∞')">–ë–µ–∑ –ª—É–∫–∞</div>
        <div class="chip" onclick="addCmt('–ü–æ–∑–≤–æ–Ω–∏—Ç–µ –≤ –¥–≤–µ—Ä—å')">–ü–æ–∑–≤–æ–Ω–∏—Ç—å –≤ –¥–≤–µ—Ä—å</div>
        <div class="chip" onclick="addCmt('–ù–µ –∑–≤–æ–Ω–∏—Ç—å')">–ù–µ –∑–≤–æ–Ω–∏—Ç—å</div>
      </div>
    </div>
  </div>

  <!-- –∏—Ç–æ–≥–æ -->
  <div class="card" style="margin:0 16px 12px">
    <div class="card-row">
      <span class="card-row-lbl">–¢–æ–≤–∞—Ä—ã</span>
      <span class="card-row-val" id="sum-items">0 ‚ÇΩ</span>
    </div>
    <div class="card-row">
      <span class="card-row-lbl">–î–æ—Å—Ç–∞–≤–∫–∞</span>
      <span class="card-row-val g" id="sum-deliv">–ë–µ—Å–ø–ª–∞—Ç–Ω–æ</span>
    </div>
    <div class="card-row" id="disc-row" style="display:none">
      <span class="card-row-lbl">–ü—Ä–æ–º–æ–∫–æ–¥</span>
      <span class="card-row-val g" id="sum-disc">‚àí0 ‚ÇΩ</span>
    </div>
    <div class="card-row" style="border-bottom:none">
      <span class="card-row-lbl" style="font-size:17px;font-weight:700">–ò—Ç–æ–≥–æ</span>
      <span class="card-row-val total" id="sum-total">0 ‚ÇΩ</span>
    </div>
  </div>

  <div class="bot-wrap page">
    <button class="btn" id="order-btn" onclick="placeOrder()">–û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑</button>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê ADDRESS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="scr" id="s-address">
  <div class="hdr">
    <button class="back" id="addr-back"></button>
    <div><div class="hdr-title">–ê–¥—Ä–µ—Å –¥–æ—Å—Ç–∞–≤–∫–∏</div></div>
  </div>
  <div style="padding:10px 16px;background:var(--white);border-bottom:1px solid var(--border)">
    <input class="addr-in" id="addr-in" type="text" placeholder="–í–≤–µ–¥–∏—Ç–µ –∞–¥—Ä–µ—Å..." oninput="onAddrInput(this.value)" autocomplete="off">
  </div>
  <div id="sug-list" class="sug-list"></div>
  <div class="map-wrap"><div id="ymap"></div></div>
  <div class="addr-flds">
    <div class="fld-row">
      <div class="fld"><label>–ü–æ–¥—ä–µ–∑–¥</label><input id="f-entr" type="text" placeholder="1"></div>
      <div class="fld"><label>–≠—Ç–∞–∂</label><input id="f-floor" type="text" placeholder="3"></div>
      <div class="fld"><label>–ö–≤–∞—Ä—Ç–∏—Ä–∞</label><input id="f-flat" type="text" placeholder="77"></div>
    </div>
    <div class="fld"><label>–î–æ–º–æ—Ñ–æ–Ω</label><input id="f-door" type="text" placeholder="1234#"></div>
    <div class="fld"><label>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∫—É—Ä—å–µ—Ä—É</label><input id="f-acmt" type="text" placeholder="–î–æ–º–æ—Ñ–æ–Ω –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç, –∑–≤–æ–Ω–∏—Ç–µ"></div>
  </div>
  <div class="bot-wrap">
    <button class="btn" onclick="confirmAddr()">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –∞–¥—Ä–µ—Å</button>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê STATUS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="scr" id="s-status">
  <div class="hdr">
    <button class="back" onclick="nav('catalog')">
      <svg width="9" height="16" fill="none"><path d="M8 1L1 8l7 7" stroke="#21201F" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
    </button>
    <div><div class="hdr-title">–ó–∞–∫–∞–∑</div></div>
  </div>
  <div class="status-wrap page">
    <div class="s-icon" id="s-ico">‚è≥</div>
    <div class="s-title" id="s-title">–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º</div>
    <div class="s-desc" id="s-desc">–ñ–¥—ë–º –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞</div>
    <div class="s-oid" id="s-oid"></div>
    <div class="sbp-card" id="sbp-card" style="display:none">
      <div class="sbp-title">–û–ø–ª–∞—Ç–∞ –°–ë–ü</div>
      <div class="sbp-desc" id="sbp-desc">–ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –±–∞–Ω–∫–∞ –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –æ–ø–ª–∞—Ç—ã</div>
      <button class="sbp-btn" onclick="openSBP()">–ü–µ—Ä–µ–π—Ç–∏ –≤ –±–∞–Ω–∫ ‚Üí</button>
    </div>
    <div style="width:100%;margin-top:20px;display:flex;flex-direction:column;gap:10px">
      <button class="btn sec" onclick="nav('orders')">–ò—Å—Ç–æ—Ä–∏—è –∑–∞–∫–∞–∑–æ–≤</button>
      <button class="btn sec" onclick="nav('catalog')">–ù–∞ –≥–ª–∞–≤–Ω—É—é</button>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê ORDERS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="scr" id="s-orders">
  <div class="hdr">
    <button class="back" id="orders-back"></button>
    <div><div class="hdr-title">–ú–æ–∏ –∑–∞–∫–∞–∑—ã</div></div>
  </div>
  <div class="page" id="orders-content">
    <div class="loader"><div class="spin"></div><div class="loader-t">–ó–∞–≥—Ä—É–∂–∞–µ–º –∑–∞–∫–∞–∑—ã...</div></div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê PROFILE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="scr" id="s-profile">
  <div class="hdr"><div class="hdr-title">–ü—Ä–æ—Ñ–∏–ª—å</div></div>
  <div class="profile-head">
    <div class="avatar" id="prf-ava">?</div>
    <div>
      <div class="prf-name" id="prf-name">–ó–∞–≥—Ä—É–∂–∞–µ–º...</div>
      <div class="prf-uid" id="prf-uid"></div>
      <div class="prf-status" id="prf-badges"></div>
    </div>
  </div>
  <div class="menu-list">
    <div class="ml-item" onclick="nav('orders')">
      <div class="ml-ico">üì¶</div>
      <div class="ml-txt">–ú–æ–∏ –∑–∞–∫–∞–∑—ã</div>
      <svg class="ml-arr" width="7" height="12" fill="none"><path d="M1 1l5 5-5 5" stroke="#9E9B98" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
    </div>
    <div class="ml-item" onclick="nav('addresses')">
      <div class="ml-ico">üìç</div>
      <div class="ml-txt">–ú–æ–∏ –∞–¥—Ä–µ—Å–∞</div>
      <svg class="ml-arr" width="7" height="12" fill="none"><path d="M1 1l5 5-5 5" stroke="#9E9B98" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
    </div>
    <div class="ml-item" onclick="nav('payment')">
      <div class="ml-ico">üí≥</div>
      <div class="ml-txt">–°–ø–æ—Å–æ–±—ã –æ–ø–ª–∞—Ç—ã</div>
      <svg class="ml-arr" width="7" height="12" fill="none"><path d="M1 1l5 5-5 5" stroke="#9E9B98" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê ADDRESSES ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="scr" id="s-addresses">
  <div class="hdr">
    <button class="back" onclick="nav('profile')">
      <svg width="9" height="16" fill="none"><path d="M8 1L1 8l7 7" stroke="#21201F" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
    </button>
    <div><div class="hdr-title">–ú–æ–∏ –∞–¥—Ä–µ—Å–∞</div></div>
  </div>
  <div class="page" id="addresses-content">
    <div class="loader"><div class="spin"></div><div class="loader-t">–ó–∞–≥—Ä—É–∂–∞–µ–º –∞–¥—Ä–µ—Å–∞...</div></div>
  </div>
  <div class="bot-wrap">
    <button class="btn" onclick="nav('address','addresses')">+ –î–æ–±–∞–≤–∏—Ç—å –∞–¥—Ä–µ—Å</button>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê PAYMENT METHODS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="scr" id="s-payment">
  <div class="hdr">
    <button class="back" onclick="nav('profile')">
      <svg width="9" height="16" fill="none"><path d="M8 1L1 8l7 7" stroke="#21201F" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
    </button>
    <div><div class="hdr-title">–°–ø–æ—Å–æ–±—ã –æ–ø–ª–∞—Ç—ã</div></div>
  </div>
  <div class="page">
    <div style="height:12px"></div>
    <div id="pay-screen-list" style="margin:0 16px;border-radius:var(--r);overflow:hidden">
    </div>
    <div style="padding:12px 16px;font-size:13px;color:var(--sec)">
      –í—ã–±—Ä–∞–Ω–Ω—ã–π —Å–ø–æ—Å–æ–± –±—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –ø—Ä–∏ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–∏ –∑–∞–∫–∞–∑–∞.
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê BOTTOM NAV ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<nav class="bnav" id="bnav">
  <button class="bn on" id="bn-catalog" onclick="nav('catalog')">
    <svg width="22" height="22" fill="none" viewBox="0 0 24 24"><rect x="3" y="3" width="7" height="7" rx="1.5" stroke="currentColor" stroke-width="1.8"/><rect x="14" y="3" width="7" height="7" rx="1.5" stroke="currentColor" stroke-width="1.8"/><rect x="3" y="14" width="7" height="7" rx="1.5" stroke="currentColor" stroke-width="1.8"/><rect x="14" y="14" width="7" height="7" rx="1.5" stroke="currentColor" stroke-width="1.8"/></svg>
    –†–µ—Å—Ç–æ—Ä–∞–Ω—ã
  </button>
  <button class="bn" id="bn-cart" onclick="nav('cart')">
    <svg width="22" height="22" fill="none" viewBox="0 0 24 24"><path d="M6 2L3 6v14a2 2 0 002 2h14a2 2 0 002-2V6l-3-4z" stroke="currentColor" stroke-width="1.8" stroke-linejoin="round"/><path d="M3 6h18" stroke="currentColor" stroke-width="1.8"/><path d="M16 10a4 4 0 01-8 0" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/></svg>
    –ö–æ—Ä–∑–∏–Ω–∞
    <span id="bn-cart-cnt" style="display:none;background:var(--red);color:#fff;border-radius:10px;padding:1px 6px;font-size:10px;font-weight:700"></span>
  </button>
  <button class="bn" id="bn-orders" onclick="nav('orders')">
    <svg width="22" height="22" fill="none" viewBox="0 0 24 24"><path d="M9 12l2 2 4-4" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/><path d="M5 7H4a2 2 0 00-2 2v11a2 2 0 002 2h16a2 2 0 002-2V9a2 2 0 00-2-2h-1" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/><rect x="7" y="3" width="10" height="6" rx="1" stroke="currentColor" stroke-width="1.8"/></svg>
    –ó–∞–∫–∞–∑—ã
  </button>
  <button class="bn" id="bn-profile" onclick="nav('profile')">
    <svg width="22" height="22" fill="none" viewBox="0 0 24 24"><circle cx="12" cy="8" r="4" stroke="currentColor" stroke-width="1.8"/><path d="M4 20c0-4 3.6-7 8-7s8 3 8 7" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/></svg>
    –ü—Ä–æ—Ñ–∏–ª—å
  </button>
</nav>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// INIT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const tg = window.Telegram?.WebApp;
if (tg) { tg.ready(); tg.expand(); tg.setHeaderColor('#FFFFFF'); }

const P           = new URLSearchParams(location.search);
const CHAT_ID     = P.get('chat_id')         || '';
const TOKEN       = P.get('token')           || '';
const DEVICE_ID   = P.get('device_id')       || '';
const AM_UUID     = P.get('appmetrica_uuid') || '';
const PROXY       = (P.get('proxy') || '').replace(/\/$/, '');
const BANK_TOKEN  = P.get('bank_token')      || '';
const PLUS_TOKEN  = P.get('plus_token')      || '';
const MAPS_KEY    = '84a7e8e1-6a86-4b9d-b6db-b7c0dcb9c8e1';

// –ú–æ–±–∏–ª—å–Ω—ã–µ User-Agent –∫–∞–∫ –≤ –±–æ—Ç–µ
const EATS_UA   = 'Edaeda/8.94.0 (com.yandex.red; build:10003; iOS 17.5.0) Alamofire/5.6.4';
const APP_ID    = 'ru.foodfox.courier';
const APP_VER   = '8.94.0';
const CODE_VER  = '10003';
const SDK_VER   = '6.32.0.10003';

const $ = id => document.getElementById(id);

const S = {
  screen: 'catalog', prevScreen: 'catalog',
  cart: [], restaurant: null, address: null,
  payMethod: 'sbp', payMethodId: 5,
  payMethods: [],   // —Å–ø–∏—Å–æ–∫ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –º–µ—Ç–æ–¥–æ–≤ –∏–∑ API
  savedCards: [],   // –ø—Ä–∏–≤—è–∑–∞–Ω–Ω—ã–µ –∫–∞—Ä—Ç—ã
  persons: 2, promo: '', promoDisc: 0, promoOk: false,
  orderId: null, sbpUrl: null, pollTimer: null,
  lat: null, lon: null,
  ymapReady: false, ymapInited: false, ymapObj: null, ymapPin: null,
  cartId: null,     // UUID –∫–æ—Ä–∑–∏–Ω—ã –¥–ª—è Lavka API
  cartVersion: 0,   // –≤–µ—Ä—Å–∏—è –∫–æ—Ä–∑–∏–Ω—ã
};

$('cart-back').onclick   = () => nav(S.prevScreen === 'cart' ? 'menu' : 'menu');
$('addr-back').onclick   = () => nav(S.prevScreen === 'address' ? 'catalog' : S.prevScreen);
$('orders-back').onclick = () => nav(S.prevScreen === 'orders' ? 'catalog' : S.prevScreen);

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// UTILS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function fmtR(rub) {
  if (rub === null || rub === undefined) return '‚Äî';
  return parseFloat(rub).toLocaleString('ru-RU',{maximumFractionDigits:2}) + ' ‚ÇΩ';
}
function fmtK(kop) { return fmtR(kop / 100); }
function uid4() {
  return ([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g, c =>
    (c ^ crypto.getRandomValues(new Uint8Array(1))[0] & 15 >> c/4).toString(16));
}
function showToast(msg, d=2500) {
  const t = $('toast'); t.textContent = msg; t.classList.add('on');
  setTimeout(() => t.classList.remove('on'), d);
}
function setBtn(id, loading, txt) {
  const b = $(id); if (!b) return;
  b.disabled = loading; b.textContent = loading ? '...' : txt;
}
function emoji(cats=[]) {
  const s = (Array.isArray(cats) ? cats.join(' ') : String(cats)).toLowerCase();
  if (s.includes('–ø–∏—Ü—Ü')||s.includes('pizza'))    return 'üçï';
  if (s.includes('–±—É—Ä–≥–µ—Ä')||s.includes('burger')) return 'üçî';
  if (s.includes('—Å—É—à–∏')||s.includes('—Ä–æ–ª'))      return 'üç£';
  if (s.includes('—à–∞—É—Ä–º'))                        return 'üåØ';
  if (s.includes('–ø–∞—Å—Ç')||s.includes('–∏—Ç–∞–ª—å—è–Ω'))  return 'üçù';
  if (s.includes('–∫–∏—Ç–∞–π')||s.includes('–ª–∞–ø—à'))    return 'üçú';
  if (s.includes('–¥–µ—Å–µ—Ä—Ç')||s.includes('—Ç–æ—Ä—Ç'))   return 'üç∞';
  if (s.includes('–∫–æ—Ñ–µ')||s.includes('–Ω–∞–ø–∏—Ç'))    return '‚òï';
  if (s.includes('—Å—É–ø')||s.includes('–±–æ—Ä—â'))      return 'üç≤';
  if (s.includes('—Å–∞–ª–∞—Ç'))                        return 'ü•ó';
  return 'üçΩÔ∏è';
}
function priceR(raw) {
  // –Ø–Ω–¥–µ–∫—Å –æ—Ç–¥–∞—ë—Ç –≤ –∫–æ–ø–µ–π–∫–∞—Ö –∫–æ–≥–¥–∞ > 500
  const n = parseFloat(raw) || 0;
  return n > 500 ? n / 100 : n;
}
function priceKop(r) { return Math.round(r * 100); }

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// API ‚Äî –±–∞–∑–æ–≤—ã–µ –∑–∞–≥–æ–ª–æ–≤–∫–∏ –∫–∞–∫ –≤ –ø–∏—Ç–æ–Ω-–±–æ—Ç–µ
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function edaHeaders(extra = {}) {
  const lat = S.lat || 55.7558;
  const lon = S.lon || 37.6176;
  const sess = uid4().toUpperCase();
  const h = {
    'user-agent':             EATS_UA,
    'x-app-version':          APP_VER,
    'x-code-version':         CODE_VER,
    'x-platform':             'ios_app',
    'x-app-id':               APP_ID,
    'x-device-id':            DEVICE_ID || uid4(),
    'x-device-model':         'iPhone17,1',
    'x-device-manufacturer':  'Apple',
    'x-os-version':           '17.5.0',
    'x-appmetrica-deviceid':  DEVICE_ID || uid4(),
    'x-appmetrica-uuid':      AM_UUID || uid4(),
    'x-client-session':       sess,
    'x-request-id':           uid4(),
    'api_service':             'SDK',
    'accept':                 'application/json',
    'accept-language':        'ru-RU;q=1.0',
    'content-type':           'application/json',
    'accept-encoding':        'gzip, deflate, br',
    'x-eda-api-version':      '7',
    'x-city-id':              '1',
    'x-ya-coordinates':       `latitude=${lat.toFixed(8)},longitude=${lon.toFixed(8)}`,
    'ngrok-skip-browser-warning': '1',
  };
  if (TOKEN) h['authorization'] = `Bearer ${TOKEN}`;
  if (CHAT_ID) h['X-Chat-Id'] = CHAT_ID;
  if (S.lat && S.lon) h['X-User-Coords'] = `${S.lat},${S.lon}`;
  return { ...h, ...extra };
}

async function api(path, opts = {}) {
  if (!PROXY) return {};
  const url = PROXY + '/proxy/' + path.replace(/^\//, '');
  try {
    const res = await fetch(url, {
      method: opts.method || 'GET',
      headers: edaHeaders(opts.headers || {}),
      body: opts.body ? JSON.stringify(opts.body) : undefined,
    });
    return res.json().catch(() => ({}));
  } catch(e) {
    console.error('[API ERR]', path, e);
    return {};
  }
}

async function post(path, body = {}, extra = {}) {
  if (!PROXY) return {};
  const url = PROXY + '/proxy/' + path.replace(/^\//, '');
  const idem = uid4();
  try {
    const res = await fetch(url, {
      method: 'POST',
      headers: edaHeaders({ 'content-type': 'application/json', 'x-idempotency-token': idem, ...extra }),
      body: JSON.stringify(body),
    });
    return res.json().catch(() => ({}));
  } catch(e) {
    console.error('[POST ERR]', path, e);
    return {};
  }
}

// Suggest —á–µ—Ä–µ–∑ /proxy-suggest
async function proxySuggest(text) {
  if (!PROXY) return [];
  try {
    const r = await fetch(PROXY + '/proxy-suggest', {
      method: 'POST',
      headers: { 'content-type': 'application/json', 'ngrok-skip-browser-warning': '1' },
      body: JSON.stringify({ text, lat: S.lat || 55.7558, lon: S.lon || 37.6176 })
    });
    const d = await r.json().catch(() => ({}));
    return d?.results || d?.suggest || d?.items || (Array.isArray(d) ? d : []);
  } catch(e) { console.error('[SUG ERR]', e); return []; }
}

// Geocode —á–µ—Ä–µ–∑ /proxy-geocode
async function proxyGeocode(text) {
  if (!PROXY) return null;
  try {
    const r = await fetch(PROXY + '/proxy-geocode', {
      method: 'POST',
      headers: { 'content-type': 'application/json', 'ngrok-skip-browser-warning': '1' },
      body: JSON.stringify({ text })
    });
    const d = await r.json().catch(() => null);
    if (!d) return null;
    const go = d?.response?.GeoObjectCollection?.featureMember?.[0]?.GeoObject;
    if (!go) return null;
    const addr  = go.metaDataProperty?.GeocoderMetaData?.Address || {};
    const comps = addr.Components || [];
    const get   = kind => comps.find(c => c.kind === kind)?.name || '';
    const pos   = go.Point?.pos?.split(' ');
    const lon   = pos ? parseFloat(pos[0]) : (S.lon || 37.6176);
    const lat   = pos ? parseFloat(pos[1]) : (S.lat || 55.7558);
    const full  = go.metaDataProperty?.GeocoderMetaData?.text || text;
    const short = [get('street'), get('house')].filter(Boolean).join(', ') || full;
    return {
      lat, lon, full_text: full, short_text: short,
      city:   get('locality') || get('province'),
      street: get('street'), house: get('house'),
      areas:  [get('province') || get('country')].filter(Boolean),
      uri:    go.uri || ''
    };
  } catch(e) { console.error('[GEO ERR]', e); return null; }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// NAVIGATION
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const ALL_SCREENS = ['catalog','menu','cart','address','status','orders','profile','addresses','payment'];
const BN_MAP = {
  catalog:'catalog', menu:'catalog', cart:'cart',
  orders:'orders', profile:'profile', status:'catalog',
  address:null, addresses:'profile', payment:'profile'
};

function nav(screen, from) {
  if (from) S.prevScreen = from;
  else S.prevScreen = S.screen;
  S.screen = screen;

  ALL_SCREENS.forEach(s => $('s-'+s)?.classList.remove('on'));
  $('s-'+screen)?.classList.add('on');
  window.scrollTo(0,0);

  document.querySelectorAll('.bn').forEach(b => b.classList.remove('on'));
  const bnId = BN_MAP[screen];
  if (bnId) $('bn-'+bnId)?.classList.add('on');
  $('bnav').style.display = screen === 'address' ? 'none' : 'flex';

  if (screen === 'catalog')   loadCatalog();
  if (screen === 'cart')      renderCart();
  if (screen === 'profile')   loadProfile();
  if (screen === 'orders')    loadOrders();
  if (screen === 'address')   initAddr();
  if (screen === 'addresses') loadAddresses();
  if (screen === 'payment')   loadPayMethods();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// GEO
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function initGeo() {
  if (tg?.LocationManager?.isInited) {
    tg.LocationManager.getLocation(l => { if(l){S.lat=l.latitude;S.lon=l.longitude;} });
  } else if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(
      p => { S.lat=p.coords.latitude; S.lon=p.coords.longitude; },
      () => {}
    );
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CATALOG ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ–º layout-constructor
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let _rAll = [], _rLoaded = false;

async function loadCatalog() {
  if (_rLoaded && _rAll.length) { renderR(_rAll); return; }
  $('r-list').innerHTML = '<div class="loader"><div class="spin"></div><div class="loader-t">–ó–∞–≥—Ä—É–∂–∞–µ–º —Ä–µ—Å—Ç–æ—Ä–∞–Ω—ã...</div></div>';

  const lat = S.lat || 55.7558, lon = S.lon || 37.6176;
  let list = [];

  try {
    // –í–∞—Ä–∏–∞–Ω—Ç 1: layout-constructor (–æ—Å–Ω–æ–≤–Ω–æ–π –Ø–Ω–¥–µ–∫—Å –ï–¥–∞)
    const d1 = await api(`eats/v1/layout-constructor/v1/layout?latitude=${lat}&longitude=${lon}&region_id=1`);
    for (const blk of (d1?.payload?.blocks || d1?.blocks || [])) {
      for (const it of (blk?.payload?.places || blk?.places || blk?.items || [])) {
        const p = it?.place || it;
        if (p?.slug || p?.place_slug) list.push(p);
      }
    }
    if (d1?.payload?.places?.length) list = [...list, ...d1.payload.places];

    // –í–∞—Ä–∏–∞–Ω—Ç 2: –º–µ—Å—Ç–∞ —Ä—è–¥–æ–º
    if (!list.length) {
      const d2 = await api(`eats/v1/places/v1/nearby?latitude=${lat}&longitude=${lon}`);
      list = d2?.places || d2?.payload?.places || [];
    }

    // –í–∞—Ä–∏–∞–Ω—Ç 3: catalog
    if (!list.length) {
      const d3 = await api(`api/v2/catalog?latitude=${lat}&longitude=${lon}`);
      list = d3?.places || d3?.data || d3?.restaurants || [];
    }

    // –î–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è
    const seen = new Set();
    list = list.filter(r => {
      const k = r.slug || r.place_slug || r.id || '';
      if (!k || seen.has(k)) return false;
      seen.add(k); return true;
    });

    if (!list.length) {
      $('r-list').innerHTML = `<div class="err-box">–†–µ—Å—Ç–æ—Ä–∞–Ω—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã.<br><br>
        <a onclick="nav('address','catalog')" style="color:var(--red);cursor:pointer;text-decoration:underline">–£–∫–∞–∂–∏—Ç–µ –∞–¥—Ä–µ—Å –¥–æ—Å—Ç–∞–≤–∫–∏</a> ‚Äî —ç—Ç–æ –ø–æ–º–æ–∂–µ—Ç –Ω–∞–π—Ç–∏ —Ä–µ—Å—Ç–æ—Ä–∞–Ω—ã —Ä—è–¥–æ–º.</div>`;
      return;
    }
    _rAll = list; _rLoaded = true;
    renderR(list);
  } catch(e) {
    $('r-list').innerHTML = `<div class="err-box">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ${e.message}</div>`;
  }
}

function renderR(list) {
  if (!list.length) { $('r-list').innerHTML='<div class="empty"><div class="empty-ico">üîç</div>–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</div>'; return; }
  $('r-list').innerHTML = list.map(r => {
    const name = r.name || r.title || '‚Äî';
    const slug = r.slug || r.place_slug || r.id || '';
    const rating = r.rating?.value || r.rating || '';
    const mn = r.delivery?.min_time || r.min_time || '';
    const mx = r.delivery?.max_time || r.max_time || mn;
    const dp = r.delivery?.price ? fmtK(r.delivery.price) : '–ë–µ—Å–ø–ª–∞—Ç–Ω–æ';
    const free = !r.delivery?.price || r.delivery?.price === 0;
    const img = r.logo_url || r.image_url || r.logo || r.cover_url || '';
    const cats = (r.categories || r.tags || []).slice(0,3).map(c => c.name || c).filter(Boolean);
    const imgH = img
      ? `<img class="r-img" src="${img}" loading="lazy" onerror="this.parentNode.innerHTML='<div class=\\'r-img-ph\\'>${emoji(cats)}</div>'">`
      : `<div class="r-img-ph">${emoji(cats)}</div>`;
    return `<div class="r-card" onclick="openR('${slug}','${encodeURIComponent(name)}')">
      ${imgH}
      <div class="r-body">
        <div class="r-name">${name}</div>
        <div class="r-meta">
          ${rating?`<span>‚≠ê ${rating}</span><div class="dot"></div>`:''}
          ${mn?`<span>${mn}‚Äì${mx} –º–∏–Ω</span><div class="dot"></div>`:''}
          <span class="${free?'tag g':'tag'}" style="padding:2px 7px">${dp}</span>
        </div>
        ${cats.length?`<div class="r-tags">${cats.map(c=>`<span class="tag">${c}</span>`).join('')}</div>`:''}
      </div>
    </div>`;
  }).join('');
}

function filterR(q) {
  if (!q) { renderR(_rAll); return; }
  const f = q.toLowerCase();
  renderR(_rAll.filter(r =>
    (r.name||r.title||'').toLowerCase().includes(f) ||
    (r.categories||r.tags||[]).map(c=>(c.name||c).toLowerCase()).join(' ').includes(f)
  ));
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// MENU ‚Äî v2 endpoint
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function openR(slug, name) {
  S.restaurant = { slug, name: decodeURIComponent(name) };
  // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –∫–æ—Ä–∑–∏–Ω—É –ø—Ä–∏ —Å–º–µ–Ω–µ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞
  if (S.cart.length && S.restaurant.slug !== slug) {
    S.cart = []; S.cartId = null; S.cartVersion = 0; updateFab();
  }
  $('menu-hdr-name').textContent = decodeURIComponent(name);
  $('menu-name').textContent = decodeURIComponent(name);
  $('menu-content').innerHTML = '<div class="loader"><div class="spin"></div><div class="loader-t">–ó–∞–≥—Ä—É–∂–∞–µ–º –º–µ–Ω—é...</div></div>';
  $('menu-cats').innerHTML = '';
  $('menu-hero-wrap').innerHTML = `<div class="menu-hero-ph">üçΩÔ∏è</div>`;
  $('cart-fab').style.display = 'none';
  nav('menu');

  try {
    const lat = S.lat || 55.7558, lon = S.lon || 37.6176;

    // –ü—Ä–æ–±—É–µ–º v2, –ø–æ—Ç–æ–º v1
    let d = await api(`eats/v1/menu/v2/menu?placeSlug=${slug}&latitude=${lat}&longitude=${lon}`);
    let cats = d?.payload?.categories || d?.categories || d?.menu || [];
    if (!cats.length) {
      d = await api(`eats/v1/menu/v1/menu?placeSlug=${slug}&latitude=${lat}&longitude=${lon}`);
      cats = d?.payload?.categories || d?.categories || d?.menu || [];
    }

    if (!cats.length) { $('menu-content').innerHTML='<div class="err-box">–ú–µ–Ω—é –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ</div>'; return; }

    // –ò–Ω—Ñ–æ –æ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–µ
    const pl = d?.payload?.place || d?.place || {};
    if (pl.rating?.value) $('menu-rating').textContent = `‚≠ê ${pl.rating.value}`;
    if (pl.delivery?.min_time) {
      $('menu-time').textContent = `${pl.delivery.min_time}‚Äì${pl.delivery.max_time || pl.delivery.min_time} –º–∏–Ω`;
    }
    const delivText = pl.delivery?.price ? fmtK(pl.delivery.price) : '–ë–µ—Å–ø–ª–∞—Ç–Ω–æ';
    $('menu-deliv').innerHTML = `<span class="tag g" style="padding:2px 7px">${delivText}</span>`;

    // –ì–µ—Ä–æ–π
    const heroImg = pl.logo_url || pl.cover_url || pl.image_url || '';
    $('menu-hero-wrap').innerHTML = heroImg
      ? `<img class="menu-hero" src="${heroImg}" onerror="this.outerHTML='<div class=\\'menu-hero-ph\\'>üçΩÔ∏è</div>'">`
      : `<div class="menu-hero-ph">${emoji(pl.categories?.map(c=>c.name)||[])}</div>`;

    // –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ (sticky nav)
    $('menu-cats').innerHTML = cats.map((c,i) =>
      `<button class="cat ${i===0?'on':''}" onclick="scrollCat('cat${i}',this)">${c.name||c.category||''}</button>`
    ).join('');

    // –ü–æ–∑–∏—Ü–∏–∏ –º–µ–Ω—é
    $('menu-content').innerHTML = cats.map((c,i) => {
      const items = c.items || c.products || [];
      return `<div class="menu-sec" id="cat${i}">
        <div class="menu-sec-t">${c.name||c.category||''}</div>
        <div class="m-items">${items.map(it => menuItemHtml(it)).join('')}</div>
      </div>`;
    }).join('');

    updateFab();
  } catch(e) { $('menu-content').innerHTML=`<div class="err-box">–û—à–∏–±–∫–∞: ${e.message}</div>`; }
}

function menuItemHtml(it) {
  const id    = String(it.id || it.item_id || '');
  const name  = it.name || it.title || '‚Äî';
  const desc  = it.description || it.description_text || '';
  const raw   = it.price || it.price_info?.price || 0;
  const pR    = priceR(raw);
  const img   = it.picture_url || it.picture?.uri || it.image_url || '';
  const inC   = S.cart.find(c => c.item.id === id);

  const imgH = img
    ? `<img class="m-img" src="${img}" loading="lazy" onerror="this.style.display='none'">`
    : `<div class="m-img-ph">${emoji(name)}</div>`;

  // –°–µ—Ä–∏–∞–ª–∏–∑—É–µ–º –¥–∞–Ω–Ω—ã–µ —Ç–æ–≤–∞—Ä–∞
  const itemJson = JSON.stringify({ id, name, desc, raw, pR, img });
  const safeJson = itemJson.replace(/'/g, '&#39;');

  const ctrl = inC
    ? `<div class="qty" id="qc-${id}">
         <button class="qb" onclick="cQ('${id}',-1,event)">‚àí</button>
         <span class="qn">${inC.qty}</span>
         <button class="qb" onclick="cQ('${id}',1,event)">+</button>
       </div>`
    : `<button class="add-btn" id="qc-${id}" onclick="addToCart('${id}',event)">+</button>`;

  return `<div class="m-item" onclick="openItem('${safeJson.replace(/"/g,'&quot;')}')" data-id="${id}"
    data-item='${safeJson.replace(/'/g,"&#39;")}'>
    ${imgH}
    <div class="m-info">
      <div class="m-name">${name}</div>
      ${desc ? `<div class="m-desc">${desc}</div>` : ''}
      <div class="m-price">${fmtR(pR)}</div>
    </div>
    ${ctrl}
  </div>`;
}

function scrollCat(id, btn) {
  document.querySelectorAll('.cat').forEach(b => b.classList.remove('on'));
  btn.classList.add('on');
  $(id)?.scrollIntoView({ behavior:'smooth', block:'start' });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ITEM MODAL
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let _modalItem = null, _modalQty = 1;

function openItem(jsonStr) {
  try {
    const it = JSON.parse(jsonStr.replace(/&quot;/g,'"').replace(/&#39;/g,"'"));
    _modalItem = it; _modalQty = 1;
    const inC = S.cart.find(c => c.item.id === it.id);
    if (inC) _modalQty = inC.qty;

    $('modal-hero').innerHTML = it.img
      ? `<img class="modal-img" src="${it.img}" onerror="this.outerHTML='<div class=\\'modal-img-ph\\'>üçΩÔ∏è</div>'">`
      : `<div class="modal-img-ph">${emoji(it.name)}</div>`;
    $('modal-name').textContent  = it.name;
    $('modal-desc').textContent  = it.desc || '';
    $('modal-price').textContent = fmtR(it.pR);
    $('modal-qty-n').textContent = _modalQty;
    $('modal-add-btn').textContent = inC ? '–û–±–Ω–æ–≤–∏—Ç—å' : '–í –∫–æ—Ä–∑–∏–Ω—É';
    $('item-modal').classList.add('on');
  } catch(e) {}
}

function closeModal(e) {
  if (e.target === $('item-modal')) $('item-modal').classList.remove('on');
}

function modalQty(d) {
  _modalQty = Math.max(1, _modalQty + d);
  $('modal-qty-n').textContent = _modalQty;
}

function modalAdd() {
  if (!_modalItem) return;
  const id = _modalItem.id;
  const ex = S.cart.find(c => c.item.id === id);
  if (ex) ex.qty = _modalQty;
  else S.cart.push({ item: _modalItem, qty: _modalQty });
  refreshQC(id);
  updateFab();
  $('item-modal').classList.remove('on');
  showToast(`${_modalItem.name} ‚Üí –∫–æ—Ä–∑–∏–Ω–∞`);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CART LOGIC
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function addToCart(id, e) {
  e.stopPropagation();
  // –ù–∞–π–¥—ë–º item data –∏–∑ DOM
  const el = e.target.closest('.m-item');
  if (!el) return;
  const raw = el.getAttribute('data-item') || '';
  let it;
  try { it = JSON.parse(raw.replace(/&#39;/g,"'")); } catch(ex) { return; }
  const ex = S.cart.find(c => c.item.id === id);
  if (ex) ex.qty++;
  else S.cart.push({ item: it, qty: 1 });
  refreshQC(id);
  updateFab();
  showToast((it.name || '–¢–æ–≤–∞—Ä') + ' –¥–æ–±–∞–≤–ª–µ–Ω');
}

function cQ(id, d, e) {
  e.stopPropagation();
  const i = S.cart.findIndex(c => c.item.id === id);
  if (i < 0) return;
  S.cart[i].qty += d;
  if (S.cart[i].qty <= 0) S.cart.splice(i, 1);
  refreshQC(id);
  updateFab();
}

function refreshQC(id) {
  const el = $(`qc-${id}`);
  if (!el) return;
  const inC = S.cart.find(c => c.item.id === id);
  if (inC) {
    el.outerHTML = `<div class="qty" id="qc-${id}">
      <button class="qb" onclick="cQ('${id}',-1,event)">‚àí</button>
      <span class="qn">${inC.qty}</span>
      <button class="qb" onclick="cQ('${id}',1,event)">+</button>
    </div>`;
  } else {
    el.outerHTML = `<button class="add-btn" id="qc-${id}" onclick="addToCart('${id}',event)">+</button>`;
  }
}

function updateFab() {
  const cnt   = S.cart.reduce((s,c) => s+c.qty, 0);
  const total = cartTotal().items;
  const fab   = $('cart-fab');
  if (cnt > 0) {
    fab.style.display = 'block';
    $('fab-cnt').textContent   = cnt;
    $('fab-price').textContent = fmtR(total);
  } else { fab.style.display = 'none'; }
  const bc = $('bn-cart-cnt');
  if (cnt > 0) { bc.style.display='inline'; bc.textContent=cnt; }
  else bc.style.display='none';
}

function cartTotal() {
  const items = S.cart.reduce((s,c) => s + (c.item.pR || 0) * c.qty, 0);
  return { items, discount: S.promoDisc, total: Math.max(0, items - S.promoDisc) };
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CART RENDER + PAYMENT METHODS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function renderCart() {
  const el = $('cart-list');
  if (!S.cart.length) {
    el.innerHTML = '<div class="empty"><div class="empty-ico">üõí</div>–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞</div>';
  } else {
    el.innerHTML = S.cart.map((c,i) => {
      const it  = c.item;
      const img = it.img || '';
      const imgH = img
        ? `<img class="ci-img" src="${img}" onerror="this.style.display='none'">`
        : `<div class="ci-img" style="display:flex;align-items:center;justify-content:center;font-size:22px">üçΩÔ∏è</div>`;
      return `<div class="ci">${imgH}
        <div style="flex:1;min-width:0">
          <div class="ci-name">${it.name||'‚Äî'}</div>
          <div class="ci-p">${fmtR((it.pR||0)*c.qty)}</div>
        </div>
        <div class="qty">
          <button class="qb" onclick="cCart(${i},-1)">‚àí</button>
          <span class="qn">${c.qty}</span>
          <button class="qb" onclick="cCart(${i},1)">+</button>
        </div>
      </div>`;
    }).join('');
  }

  const t = cartTotal();
  $('sum-items').textContent = fmtR(t.items);
  $('sum-total').textContent = fmtR(t.total);
  $('disc-row').style.display = t.discount > 0 ? 'flex' : 'none';
  if (t.discount > 0) $('sum-disc').textContent = '‚àí' + fmtR(t.discount);

  const aT = S.address?.short_text || S.address?.full_text || '–£–∫–∞–∂–∏—Ç–µ –∞–¥—Ä–µ—Å';
  $('addr-cart').textContent = aT;
  $('addr-top').textContent  = aT;

  // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–æ—Å–æ–±—ã –æ–ø–ª–∞—Ç—ã
  await renderPayMethods();
}

function cCart(i, d) {
  S.cart[i].qty += d;
  if (S.cart[i].qty <= 0) S.cart.splice(i, 1);
  renderCart(); updateFab();
  if (!S.cart.length) nav('menu');
}

function cPers(d) { S.persons = Math.max(0, (S.persons || 2) + d); $('pers-n').textContent = S.persons; }
function addCmt(t) { const ta=$('cmt'); ta.value=ta.value?ta.value+', '+t:t; }

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PAYMENT METHODS ‚Äî –∑–∞–≥—Ä—É–∂–∞–µ–º –∏–∑ API
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function loadPayMethodsFromAPI() {
  // –ü—Ä–æ–±—É–µ–º –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–ø–æ—Å–æ–±—ã –æ–ø–ª–∞—Ç—ã —á–µ—Ä–µ–∑ –Ø–Ω–¥–µ–∫—Å –ï–¥–∞ API
  try {
    const lat = S.lat || 55.7558, lon = S.lon || 37.6176;
    // –ú–µ—Ç–æ–¥ 1: payment-methods
    const d = await api(`api/v1/payment-methods?latitude=${lat}&longitude=${lon}`);
    const methods = d?.payment_methods || d?.methods || d?.data || [];
    if (methods.length) return methods;

    // –ú–µ—Ç–æ–¥ 2: user/payment-methods
    const d2 = await api(`api/v2/user/payment-methods`);
    return d2?.payment_methods || d2?.methods || [];
  } catch(e) {
    return [];
  }
}

async function renderPayMethods() {
  const container = $('pay-methods');
  if (!container) return;

  // –ë–∞–∑–æ–≤—ã–µ –º–µ—Ç–æ–¥—ã (–≤—Å–µ–≥–¥–∞ –¥–æ—Å—Ç—É–ø–Ω—ã)
  const defaults = [
    { id: 'sbp', mid: 5, icon: 'üè¶', name: '–°–ë–ü', sub: '–°–∏—Å—Ç–µ–º–∞ –±—ã—Å—Ç—Ä—ã—Ö –ø–ª–∞—Ç–µ–∂–µ–π' },
    { id: 'cash', mid: 1, icon: 'üíµ', name: '–ù–∞–ª–∏—á–Ω—ã–º–∏ –∫—É—Ä—å–µ—Ä—É', sub: '' },
  ];

  // –ï—Å–ª–∏ –µ—Å—Ç—å –∫–∞—Ä—Ç—ã –∏–∑ —Å–Ω–∏—Ñ–∞
  const cardMethods = S.savedCards.map(card => ({
    id: 'card_' + (card.id || card.card_id || ''),
    mid: 2,
    icon: 'üí≥',
    name: card.masked_number || card.last4 ? `–ö–∞—Ä—Ç–∞ ‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ${card.last4 || card.masked_number?.slice(-4)}` : '–ë–∞–Ω–∫–æ–≤—Å–∫–∞—è –∫–∞—Ä—Ç–∞',
    sub: card.payment_system || card.card_type || ''
  }));

  const all = [...defaults, ...cardMethods];
  if (!cardMethods.length) {
    all.push({ id: 'card', mid: 2, icon: 'üí≥', name: '–î–æ–±–∞–≤–∏—Ç—å –∫–∞—Ä—Ç—É', sub: '–û–ø–ª–∞—Ç–∞ –æ–Ω–ª–∞–π–Ω' });
  }

  container.innerHTML = all.map(m => {
    const isSel = S.payMethod === m.id || (S.payMethod === 'sbp' && m.id === 'sbp') || (S.payMethod === 'cash' && m.id === 'cash');
    return `<div class="pay-m ${isSel?'sel':''}" onclick="selPay('${m.id}',${m.mid},this)">
      <div class="pay-ico">${m.icon}</div>
      <div style="flex:1">
        <div class="pay-nm">${m.name}</div>
        ${m.sub?`<div class="pay-sub">${m.sub}</div>`:''}
      </div>
      <div class="pay-chk">${isSel?'<svg width="10" height="8" fill="none"><path d="M1 4l3 3L9 1" stroke="white" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>':''}</div>
    </div>`;
  }).join('');
}

async function loadPayMethods() {
  // –î–ª—è —ç–∫—Ä–∞–Ω–∞ "–°–ø–æ—Å–æ–±—ã –æ–ø–ª–∞—Ç—ã" –≤ –ø—Ä–æ—Ñ–∏–ª–µ
  const container = $('pay-screen-list');
  if (!container) return;

  const defaults = [
    { id: 'sbp', mid: 5, icon: 'üè¶', title: '–°–ë–ü', sub: '–°–∏—Å—Ç–µ–º–∞ –±—ã—Å—Ç—Ä—ã—Ö –ø–ª–∞—Ç–µ–∂–µ–π' },
    { id: 'cash', mid: 1, icon: 'üíµ', title: '–ù–∞–ª–∏—á–Ω—ã–µ', sub: '–ö—É—Ä—å–µ—Ä—É –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏' },
  ];

  // –ü—Ä–æ–±—É–µ–º –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ä–µ–∞–ª—å–Ω—ã–µ –∫–∞—Ä—Ç—ã
  const apiMethods = await loadPayMethodsFromAPI();
  const cards = apiMethods.filter(m =>
    m.payment_type === 'card' || m.type === 'card' || m.payment_type === 'bank_card'
  );
  if (cards.length) {
    S.savedCards = cards;
    cards.forEach(c => {
      defaults.push({
        id: 'card_' + (c.id || c.card_id || uid4().slice(0,8)),
        mid: 2, icon: 'üí≥',
        title: c.masked_number || `–ö–∞—Ä—Ç–∞ ‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ${c.last4||''}`,
        sub: c.payment_system || c.card_type || ''
      });
    });
  } else {
    defaults.push({ id: 'card', mid: 2, icon: 'üí≥', title: '–ë–∞–Ω–∫–æ–≤—Å–∫–∞—è –∫–∞—Ä—Ç–∞', sub: '–î–æ–±–∞–≤–∏—Ç—å –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –Ø–Ω–¥–µ–∫—Å–∞' });
  }

  container.innerHTML = defaults.map(m => {
    const isSel = S.payMethod === m.id;
    return `<div class="pay-screen-item ${isSel?'sel':''}" onclick="setGlobalPay('${m.id}',${m.mid},this)">
      <div class="pay-screen-ico">${m.icon}</div>
      <div class="pay-screen-name">
        <div class="pay-screen-title">${m.title}</div>
        ${m.sub?`<div class="pay-screen-sub">${m.sub}</div>`:''}
      </div>
      <div class="pay-screen-chk"></div>
    </div>`;
  }).join('');
}

function selPay(id, mid, el) {
  document.querySelectorAll('.pay-m').forEach(m => {
    m.classList.remove('sel');
    m.querySelector('.pay-chk').innerHTML = '';
  });
  el.classList.add('sel');
  el.querySelector('.pay-chk').innerHTML = '<svg width="10" height="8" fill="none"><path d="M1 4l3 3L9 1" stroke="white" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>';
  S.payMethod = id; S.payMethodId = mid;
}

function setGlobalPay(id, mid, el) {
  S.payMethod = id; S.payMethodId = mid;
  document.querySelectorAll('.pay-screen-item').forEach(m => {
    m.classList.remove('sel');
  });
  el.classList.add('sel');
  const labels = { sbp:'–°–ë–ü –≤—ã–±—Ä–∞–Ω', cash:'–ù–∞–ª–∏—á–Ω—ã–µ –≤—ã–±—Ä–∞–Ω—ã', card:'–ö–∞—Ä—Ç–∞ –≤—ã–±—Ä–∞–Ω–∞' };
  showToast(labels[id.split('_')[0]] || '–í—ã–±—Ä–∞–Ω–æ');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PROMO ‚Äî —á–µ—Ä–µ–∑ –Ø–Ω–¥–µ–∫—Å –ï–¥–∞ API
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function togglePromo() {
  const b = $('promo-block');
  b.style.display = b.style.display === 'none' ? 'block' : 'none';
}

async function applyPromo() {
  const code = ($('promo-in').value || '').trim().toUpperCase();
  if (!code) return;
  const msg = $('promo-msg');
  msg.textContent = '–ü—Ä–æ–≤–µ—Ä—è–µ–º...'; msg.className = 'promo-msg';

  try {
    // –ò—Å–ø–æ–ª—å–∑—É–µ–º –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —ç–Ω–¥–ø–æ–∏–Ω—Ç –Ø–Ω–¥–µ–∫—Å –ï–¥—ã
    const r = await post('api/v2/apply-promocode', {
      promocode: code,
      place_slug: S.restaurant?.slug || '',
      cart: buildCartItems()
    });

    const disc = r?.discount_amount || r?.discount || 0;
    if (disc || r?.status === 'ok') {
      S.promo = code;
      S.promoDisc = disc > 1000 ? disc/100 : disc;
      S.promoOk = true;
      msg.textContent = `‚úì –°–∫–∏–¥–∫–∞ ${fmtR(S.promoDisc)}`; msg.className = 'promo-msg ok';
      $('promo-display').innerHTML = `<span style="color:var(--red)">${code}</span> ‚úì`;
      renderCart();
    } else {
      const errMsg = r?.message || r?.err || r?.error || '–ü—Ä–æ–º–æ–∫–æ–¥ –Ω–µ –Ω–∞–π–¥–µ–Ω';
      msg.textContent = '‚úó ' + errMsg; msg.className = 'promo-msg er';
    }
  } catch(e) { msg.textContent = '‚úó ' + e.message; msg.className = 'promo-msg er'; }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// BUILD CART ‚Äî —Ñ–æ—Ä–º–∞—Ç –Ø–Ω–¥–µ–∫—Å –ï–¥–∞ API
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function buildCartItems() {
  return S.cart.map(c => ({
    id:       c.item.id || '',
    quantity: c.qty,
    // –ü–µ—Ä–µ–¥–∞—ë–º —Ü–µ–Ω—É –≤ –∫–æ–ø–µ–π–∫–∞—Ö
    price:    priceKop(c.item.pR || 0)
  }));
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PLACE ORDER ‚Äî —á–µ—Ä–µ–∑ api/v2/place-order
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function placeOrder() {
  if (!S.address) { showToast('–£–∫–∞–∂–∏—Ç–µ –∞–¥—Ä–µ—Å –¥–æ—Å—Ç–∞–≤–∫–∏'); nav('address','cart'); return; }
  if (!S.cart.length) { showToast('–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞'); return; }

  setBtn('order-btn', true, '–û—Ñ–æ—Ä–º–ª—è–µ–º...');
  const t = cartTotal();
  const a = S.address;

  // –û–ø—Ä–µ–¥–µ–ª—è–µ–º payment_information –∏—Å—Ö–æ–¥—è –∏–∑ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –º–µ—Ç–æ–¥–∞
  let payInfo;
  if (S.payMethod === 'sbp') {
    payInfo = { type: 'sbp', id: 'sbp_qr', costForCustomer: t.total.toFixed(2) };
  } else if (S.payMethod === 'cash') {
    payInfo = { type: 'cash', id: 'cash', costForCustomer: t.total.toFixed(2) };
  } else {
    // –ö–∞—Ä—Ç–∞
    const cardId = S.payMethod.startsWith('card_') ? S.payMethod.replace('card_','') : 'card';
    payInfo = { type: 'card', id: cardId, costForCustomer: t.total.toFixed(2) };
  }

  const body = {
    courier_options:  [],
    persons_quantity: S.persons,
    location: { latitude: a.lat || S.lat || 55.7558, longitude: a.lon || S.lon || 37.6176 },
    comment: $('cmt')?.value || '',
    payment: { recently_link_cards: false },
    payment_method_id: S.payMethodId,
    place_slug: S.restaurant?.slug || '',
    extended_options: [{ type:'delivery_options' }],
    address: {
      office:     $('f-flat')?.value  || '',
      floor:      $('f-floor')?.value || '',
      entrance:   $('f-entr')?.value  || '',
      doorcode:   $('f-door')?.value  || '',
      comment:    $('f-acmt')?.value  || '',
      city:       a.city    || '',
      street:     a.street  || '',
      house:      a.house   || '',
      short_text: a.short_text || a.full_text || '',
      full_text:  a.full_text  || a.short_text || '',
      title:      a.short_text || a.full_text || '',
      country:    '–†–æ—Å—Å–∏—è',
      areas:      a.areas || [],
      type:       { id: 0 },
      location:   { latitude: a.lat || 55.7558, longitude: a.lon || 37.6176 },
      ...(a.uri ? { uri: a.uri } : {}),
    },
    payment_information: payInfo,
    without_callback: true,
    first_order: false,
    currency: 'RUB',
    country_code: 'RU',
    ...(S.promoOk ? { promo_code: S.promo } : {}),
    cart: buildCartItems()
  };

  try {
    const r = await post('api/v2/place-order', body);
    if (r?.status === 'error' || r?.domain || r?.code) {
      showToast(r?.err || r?.message || r?.description || '–û—à–∏–±–∫–∞ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è');
      setBtn('order-btn', false, '–û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑');
      return;
    }
    S.orderId = r?.order?.order?.order_id || r?.order_id || r?.id || '';
    nav('status');
    handleOrderResponse(r);
  } catch(e) {
    showToast('–û—à–∏–±–∫–∞: ' + e.message);
    setBtn('order-btn', false, '–û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑');
  }
}

function handleOrderResponse(r) {
  const oid = S.orderId;
  $('s-oid').textContent = oid ? `–ó–∞–∫–∞–∑ ‚Ññ${oid}` : '';
  const pay = r?.order?.payment || r?.payment;
  const tr  = r?.transparentPayment;

  if (pay?.status === 'sbp_required' || tr || S.payMethod === 'sbp') {
    const url = pay?.payload?.url || tr?.screen?.actions?.[0]?.url || '';
    S.sbpUrl  = url;
    $('s-ico').textContent = 'üí≥';
    $('s-ico').classList.add('pulse');
    $('s-title').textContent = '–û–∂–∏–¥–∞–µ–º –æ–ø–ª–∞—Ç—É';
    $('s-desc').textContent  = tr?.screen?.text?.text || '–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –ø–ª–∞—Ç—ë–∂ –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ –±–∞–Ω–∫–∞';
    if (url) { $('sbp-card').style.display = 'block'; $('sbp-desc').textContent = '–ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –±–∞–Ω–∫–∞ –¥–ª—è –æ–ø–ª–∞—Ç—ã'; }
    if (oid) startPoll(oid);
  } else {
    $('s-ico').textContent = '‚úÖ'; $('s-ico').classList.remove('pulse');
    $('s-title').textContent = '–ó–∞–∫–∞–∑ –ø—Ä–∏–Ω—è—Ç!';
    $('s-desc').textContent  = '–†–µ—Å—Ç–æ—Ä–∞–Ω —É–∂–µ –≥–æ—Ç–æ–≤–∏—Ç –≤–∞—à –∑–∞–∫–∞–∑';
    S.cart = []; updateFab();
  }
}

function openSBP() {
  if (!S.sbpUrl) { showToast('–°—Å—ã–ª–∫–∞ –¥–ª—è –æ–ø–ª–∞—Ç—ã –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞'); return; }
  tg ? tg.openLink(S.sbpUrl) : window.open(S.sbpUrl, '_blank');
}

function startPoll(oid) {
  if (S.pollTimer) clearInterval(S.pollTimer);
  S.pollTimer = setInterval(() => pollOrder(oid), 3000);
  setTimeout(() => { if(S.pollTimer) clearInterval(S.pollTimer); }, 600000);
}

async function pollOrder(oid) {
  try {
    const r  = await api(`api/v2/orders/${oid}/info`);
    const ps = r?.order?.payment?.status || r?.payment_status || '';
    const os = r?.order?.order?.status   || r?.order_status   || '';
    if (ps==='paid'||os==='confirmed'||os==='cooking'||os==='delivering') {
      clearInterval(S.pollTimer); S.pollTimer=null;
      $('s-ico').textContent='‚úÖ'; $('s-ico').classList.remove('pulse');
      $('s-title').textContent='–û–ø–ª–∞—Ç–∞ –ø—Ä–æ—à–ª–∞!'; $('s-desc').textContent='–†–µ—Å—Ç–æ—Ä–∞–Ω –ø—Ä–∏–Ω—è–ª –∑–∞–∫–∞–∑';
      $('sbp-card').style.display='none'; S.cart=[]; updateFab();
    } else if (ps==='failed'||os==='cancelled') {
      clearInterval(S.pollTimer); S.pollTimer=null;
      $('s-ico').textContent='‚ùå'; $('s-ico').classList.remove('pulse');
      $('s-title').textContent='–û–ø–ª–∞—Ç–∞ –Ω–µ –ø—Ä–æ—à–ª–∞'; $('s-desc').textContent='–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –¥—Ä—É–≥–æ–π —Å–ø–æ—Å–æ–±';
    }
  } catch(e) {}
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ORDERS HISTORY
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function loadOrders() {
  $('orders-content').innerHTML = '<div class="loader"><div class="spin"></div><div class="loader-t">–ó–∞–≥—Ä—É–∂–∞–µ–º –∑–∞–∫–∞–∑—ã...</div></div>';
  try {
    const d = await api('api/v2/orders/history?page=1&page_size=20');
    const orders = d?.orders || d?.data || d?.history || [];
    if (!orders.length) {
      $('orders-content').innerHTML = '<div class="empty"><div class="empty-ico">üì¶</div>–ó–∞–∫–∞–∑–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç</div>';
      return;
    }
    $('orders-content').innerHTML = `<div class="ord-list page">${orders.map(o => renderOrder(o)).join('')}</div>`;
  } catch(e) {
    $('orders-content').innerHTML = `<div class="err-box">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ${e.message}</div>`;
  }
}

function renderOrder(o) {
  const oid   = o.order_id || o.id || '';
  const rest  = o.place_name || o.restaurant_name || o.place?.name || '–†–µ—Å—Ç–æ—Ä–∞–Ω';
  const date  = o.created_at
    ? new Date(o.created_at).toLocaleString('ru-RU',{day:'numeric',month:'short',hour:'2-digit',minute:'2-digit'})
    : '';
  const items = (o.items || o.products || []).slice(0,3).map(i => i.name||i.title||'').filter(Boolean).join(', ');
  const total = o.total_cost || o.total || o.cost || 0;
  const totalR = total > 5000 ? total/100 : total;
  const status = o.status || o.order_status || '';
  const statMap = {
    delivered:['done','–î–æ—Å—Ç–∞–≤–ª–µ–Ω'], completed:['done','–í—ã–ø–æ–ª–Ω–µ–Ω'],
    cancelled:['wait','–û—Ç–º–µ–Ω—ë–Ω'], delivering:['del','–í–µ–∑—É—Ç'],
    cooking:['del','–ì–æ—Ç–æ–≤–∏—Ç—Å—è'], confirmed:['del','–ü—Ä–∏–Ω—è—Ç'],
  };
  const [cls, label] = statMap[status] || ['wait', status || '–í –æ–±—Ä–∞–±–æ—Ç–∫–µ'];
  const safeO = encodeURIComponent(JSON.stringify({
    place_slug: o.place_slug || o.place?.slug || '',
    place_name: rest,
    items: (o.items||[]).map(i => ({ id:i.id||i.item_id||'', name:i.name||'', raw:i.price||0, pR:priceR(i.price||0), qty:i.quantity||1 }))
  }));
  return `<div class="ord-card">
    <div class="ord-head">
      <div>
        <div class="ord-rest">${rest}</div>
        <div class="ord-date">${date}${oid?' ¬∑ ‚Ññ'+oid:''}</div>
      </div>
      <span class="ord-status ${cls}">${label}</span>
    </div>
    <div class="ord-body">
      ${items?`<div class="ord-items">${items}${(o.items||[]).length>3?` –∏ –µ—â—ë ${(o.items||[]).length-3}`:''}</div>`:''}
      <div class="ord-footer">
        <span class="ord-price">${fmtR(totalR)}</span>
      </div>
      <button class="ord-repeat" onclick="repeatOrder('${safeO}')">–ü–æ–≤—Ç–æ—Ä–∏—Ç—å –∑–∞–∫–∞–∑</button>
    </div>
  </div>`;
}

function repeatOrder(encoded) {
  try {
    const o = JSON.parse(decodeURIComponent(encoded));
    if (!o.place_slug) { showToast('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–µ'); return; }
    S.restaurant = { slug: o.place_slug, name: o.place_name||'–†–µ—Å—Ç–æ—Ä–∞–Ω' };
    S.cart = (o.items||[]).map(it => ({ item:it, qty:it.qty||1 }));
    updateFab(); nav('cart');
    showToast('–ó–∞–∫–∞–∑ –¥–æ–±–∞–≤–ª–µ–Ω –≤ –∫–æ—Ä–∑–∏–Ω—É');
  } catch(e) { showToast('–û—à–∏–±–∫–∞'); }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SAVED ADDRESSES
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function loadAddresses() {
  $('addresses-content').innerHTML = '<div class="loader"><div class="spin"></div><div class="loader-t">–ó–∞–≥—Ä—É–∂–∞–µ–º...</div></div>';
  try {
    const d = await api('api/v2/user/addresses');
    const addrs = d?.addresses || d?.data || [];
    if (!addrs.length && S.address) {
      $('addresses-content').innerHTML = `<div class="ord-list page">
        <div class="ord-card">
          <div class="ord-head"><div>
            <div class="ord-rest">–¢–µ–∫—É—â–∏–π –∞–¥—Ä–µ—Å</div>
            <div class="ord-date">${S.address.full_text||S.address.short_text||''}</div>
          </div></div>
          <div class="ord-body"><button class="ord-repeat" onclick="nav('address','addresses')">–ò–∑–º–µ–Ω–∏—Ç—å –∞–¥—Ä–µ—Å</button></div>
        </div>
      </div>`;
      return;
    }
    if (!addrs.length) {
      $('addresses-content').innerHTML = '<div class="empty"><div class="empty-ico">üìç</div>–ù–µ—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã—Ö –∞–¥—Ä–µ—Å–æ–≤</div>';
      return;
    }
    $('addresses-content').innerHTML = `<div class="ord-list page">${addrs.map(a => {
      const txt = a.full_text || a.short_text || a.name || a.address || '–ê–¥—Ä–µ—Å';
      const safe = encodeURIComponent(JSON.stringify(a));
      return `<div class="ord-card" onclick="useAddress('${safe}')">
        <div class="ord-head"><div>
          <div class="ord-rest">${txt}</div>
          ${a.entrance?`<div class="ord-date">–ü–æ–¥—ä–µ–∑–¥ ${a.entrance}${a.floor?`, —ç—Ç–∞–∂ ${a.floor}`:''}</div>`:''}
        </div>
        <svg width="7" height="12" fill="none"><path d="M1 1l5 5-5 5" stroke="#9E9B98" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
        </div>
      </div>`;
    }).join('')}</div>`;
  } catch(e) {
    $('addresses-content').innerHTML = '<div class="empty"><div class="empty-ico">üìç</div>–ù–µ—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã—Ö –∞–¥—Ä–µ—Å–æ–≤</div>';
  }
}

function useAddress(encoded) {
  try {
    const a = JSON.parse(decodeURIComponent(encoded));
    S.address = {
      full_text:  a.full_text  || a.name || '',
      short_text: a.short_text || a.name || '',
      city:    a.city    || '', street:  a.street  || '',
      house:   a.house   || '',
      lat:     a.lat || a.location?.latitude  || 55.7558,
      lon:     a.lon || a.location?.longitude || 37.6176,
      entrance: a.entrance || '', floor: a.floor || '',
      flat:    a.flat || a.office || '', doorcode: a.doorcode || '',
      areas:   a.areas || [], uri: a.uri || ''
    };
    const disp = S.address.short_text || S.address.full_text;
    $('addr-top').textContent  = disp;
    $('addr-cart').textContent = disp;
    showToast('–ê–¥—Ä–µ—Å –≤—ã–±—Ä–∞–Ω ‚úì');
    _rLoaded = false;
    nav('catalog');
  } catch(e) {}
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PROFILE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function loadProfile() {
  const urlName = decodeURIComponent(P.get('name') || '');
  const urlUid  = P.get('uid') || '';
  const tgUser  = tg?.initDataUnsafe?.user;
  let name = urlName || tgUser?.first_name || '';
  let uid  = urlUid || '';

  if (name) _renderProfile(name, uid);

  if (PROXY && CHAT_ID) {
    try {
      const r = await fetch(`${PROXY}/proxy-account?chat_id=${CHAT_ID}`, {
        headers: { 'ngrok-skip-browser-warning':'1', 'X-Chat-Id': CHAT_ID }
      });
      const d = await r.json().catch(()=>({}));
      if (d.name) name = d.name;
      if (d.uid)  uid  = d.uid;
      if (d.bank_token && !BANK_TOKEN) {}  // –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å
    } catch(e) {}
  }
  _renderProfile(name, uid);
}

function _renderProfile(name, uid) {
  $('prf-ava').textContent  = name ? name[0].toUpperCase() : '?';
  $('prf-name').textContent = name || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';
  $('prf-uid').textContent  = uid  ? `UID: ${uid}` : '';
  const badges = [];
  if (PLUS_TOKEN)  badges.push('<span class="prf-badge b">‚≠ê –Ø–Ω–¥–µ–∫—Å –ü–ª—é—Å</span>');
  if (BANK_TOKEN)  badges.push('<span class="prf-badge g">üí≥ –Ø–Ω–¥–µ–∫—Å –ë–∞–Ω–∫</span>');
  $('prf-badges').innerHTML = badges.join('');
  $('hdr-name').textContent = name ? name.split(' ')[0] : '';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ADDRESS ‚Äî suggest + geocode —á–µ—Ä–µ–∑ –ø—Ä–æ–∫—Å–∏
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let _sugTimer = null, _ymInited = false;

function initAddr() {
  if (S.address) {
    $('addr-in').value = S.address.short_text || S.address.full_text || '';
    $('f-entr').value  = S.address.entrance || '';
    $('f-floor').value = S.address.floor    || '';
    $('f-flat').value  = S.address.flat     || '';
    $('f-door').value  = S.address.doorcode || '';
    $('f-acmt').value  = S.address.comment  || '';
  }
  $('sug-list').innerHTML = '';
  if (!_ymInited) { _ymInited = true; loadYmap(); }
  else if (S.ymapReady && S.address?.lat) setPin(S.address.lat, S.address.lon);
}

function loadYmap() {
  const s = document.createElement('script');
  s.src = 'https://api-maps.yandex.ru/2.1/?lang=ru_RU&apikey=' + MAPS_KEY;
  s.onload = () => {
    if (!window.ymaps) return;
    ymaps.ready(() => {
      try {
        const lat = S.address?.lat || S.lat || 55.7558;
        const lon = S.address?.lon || S.lon || 37.6176;
        S.ymapObj = new ymaps.Map('ymap', { center:[lat,lon], zoom:16, controls:['zoomControl'] });
        S.ymapPin = new ymaps.Placemark([lat,lon], {}, { preset:'islands#redDotIcon' });
        S.ymapObj.geoObjects.add(S.ymapPin);
        S.ymapReady = true;
        S.ymapObj.events.add('click', e => {
          const [la,lo] = e.get('coords');
          setPin(la, lo);
          revGeo(la, lo);
        });
      } catch(e) { console.log('[MAP ERR]', e); }
    });
  };
  s.onerror = () => console.log('[MAP] –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª–∏—Å—å');
  document.head.appendChild(s);
}

function setPin(lat, lon) {
  if (!S.ymapReady) return;
  try {
    S.ymapPin.geometry.setCoordinates([lat, lon]);
    S.ymapObj.setCenter([lat, lon], 16, { duration:300 });
  } catch(e) {}
}

function onAddrInput(val) {
  clearTimeout(_sugTimer);
  if (!val || val.length < 2) { $('sug-list').innerHTML = ''; return; }
  _sugTimer = setTimeout(() => fetchSug(val), 350);
}

async function fetchSug(text) {
  $('sug-list').innerHTML = '<div style="padding:10px 16px;color:var(--sec);font-size:14px">–ò—â–µ–º...</div>';
  const items = await proxySuggest(text);
  if (!items.length) {
    $('sug-list').innerHTML = '<div style="padding:10px 16px;color:var(--sec);font-size:14px">–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</div>';
    return;
  }
  $('sug-list').innerHTML = items.slice(0,8).map(it => {
    const title = it?.title?.text || it?.name || it?.text || it?.value || '';
    const sub   = it?.subtitle?.text || it?.description || it?.displayName || '';
    const uri   = it?.uri || '';
    const safe  = encodeURIComponent(JSON.stringify({ title, sub, uri }));
    return `<div class="sug" onclick="selSug('${safe}')">
      <svg style="flex-shrink:0;margin-top:2px;opacity:.5" width="14" height="18" fill="none">
        <path d="M7 0C3.7 0 1 2.7 1 6c0 4.5 6 11 6 11S13 10.5 13 6C13 2.7 10.3 0 7 0zm0 8.5A2.5 2.5 0 1 1 7 3.5a2.5 2.5 0 0 1 0 5z" fill="#9E9B98"/>
      </svg>
      <div style="flex:1;min-width:0">
        <div class="sug-t">${title}</div>
        ${sub?`<div class="sug-s">${sub}</div>`:''}
      </div>
    </div>`;
  }).join('');
}

async function selSug(encoded) {
  try {
    const { title, sub, uri } = JSON.parse(decodeURIComponent(encoded));
    const full = [title, sub].filter(Boolean).join(', ');
    $('addr-in').value = title;
    $('sug-list').innerHTML = '';
    const geo = await proxyGeocode(full);
    if (geo) {
      S.address = { ...geo, uri: uri || geo.uri };
      if (S.ymapReady) setPin(geo.lat, geo.lon);
    } else {
      S.address = S.address || {};
      S.address.full_text  = full;
      S.address.short_text = title;
      S.address.uri        = uri;
      if (!S.address.lat) S.address.lat = S.lat || 55.7558;
      if (!S.address.lon) S.address.lon = S.lon || 37.6176;
      S.address.areas = S.address.areas || [];
    }
  } catch(e) {}
}

async function revGeo(lat, lon) {
  const geo = await proxyGeocode(`${lon},${lat}`);
  if (geo && S.address) {
    Object.assign(S.address, geo);
    $('addr-in').value = geo.short_text || geo.full_text || '';
  }
}

function confirmAddr() {
  const inputVal = ($('addr-in').value || '').trim();
  if (!inputVal && !S.address) { showToast('–í–≤–µ–¥–∏—Ç–µ –∞–¥—Ä–µ—Å'); return; }

  if (!S.address) S.address = {};
  if (inputVal && inputVal !== S.address.short_text && inputVal !== S.address.full_text) {
    S.address.full_text  = inputVal;
    S.address.short_text = inputVal;
    if (!S.address.lat) S.address.lat = S.lat || 55.7558;
    if (!S.address.lon) S.address.lon = S.lon || 37.6176;
    S.address.areas = S.address.areas || [];
  }

  S.address.entrance = $('f-entr')?.value  || '';
  S.address.floor    = $('f-floor')?.value || '';
  S.address.flat     = $('f-flat')?.value  || '';
  S.address.doorcode = $('f-door')?.value  || '';
  S.address.comment  = $('f-acmt')?.value  || '';

  const disp = S.address.short_text || S.address.full_text || '';
  $('addr-top').textContent  = disp;
  $('addr-cart').textContent = disp;
  _rLoaded = false;
  showToast('–ê–¥—Ä–µ—Å —Å–æ—Ö—Ä–∞–Ω—ë–Ω ‚úì');
  nav(S.prevScreen === 'address' ? 'catalog' : (S.prevScreen || 'catalog'));
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// LAUNCH
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
initGeo();

if (!TOKEN && !PROXY) {
  $('r-list').innerHTML = '<div class="err-box">–û—Ç–∫—Ä–æ–π—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —á–µ—Ä–µ–∑ Telegram-–±–æ—Ç–∞</div>';
} else {
  loadCatalog();
  loadProfile();
}
</script>
</body>
</html>
