<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>–Ø–Ω–¥–µ–∫—Å –ï–¥–∞</title>
<style>
  :root {
    --yellow: #FFE033;
    --yellow-dark: #F5C800;
    --black: #1A1A1A;
    --gray-bg: #F5F5F5;
    --gray-text: #8C8C8C;
    --gray-border: #E8E8E8;
    --green: #029154;
    --red: #E63946;
    --safe-top: env(safe-area-inset-top, 0px);
    --safe-bot: env(safe-area-inset-bottom, 0px);
  }
  * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
  html, body { height: 100%; overflow: hidden; font-family: -apple-system, 'SF Pro Display', 'Helvetica Neue', sans-serif; background: var(--gray-bg); }
  #app { height: 100dvh; display: flex; flex-direction: column; overflow: hidden; position: relative; }
  .topbar { background: var(--yellow); padding: calc(var(--safe-top) + 12px) 16px 12px; flex-shrink: 0; position: relative; z-index: 100; }
  .topbar-inner { display: flex; align-items: center; gap: 10px; }
  .logo { font-size: 22px; font-weight: 900; color: var(--black); }
  .address-btn { flex: 1; display: flex; align-items: center; gap: 6px; background: rgba(0,0,0,0.08); border-radius: 12px; padding: 8px 12px; cursor: pointer; border: none; text-align: left; min-width: 0; }
  .address-btn-text { font-size: 13px; font-weight: 600; color: var(--black); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .profile-btn { width: 36px; height: 36px; border-radius: 50%; background: rgba(0,0,0,0.1); border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 18px; flex-shrink: 0; }
  .tabs { background: var(--yellow); display: flex; padding: 0 16px 12px; gap: 8px; flex-shrink: 0; }
  .tab-btn { padding: 7px 16px; border-radius: 20px; border: none; font-size: 13px; font-weight: 600; cursor: pointer; transition: all 0.2s; }
  .tab-btn.active { background: var(--black); color: white; }
  .tab-btn:not(.active) { background: rgba(0,0,0,0.08); color: var(--black); }
  .content { flex: 1; overflow-y: auto; overflow-x: hidden; -webkit-overflow-scrolling: touch; overscroll-behavior: contain; }
  .content::-webkit-scrollbar { display: none; }
  .screen { display: none; }
  .screen.active { display: block; }
  .search-wrap { padding: 12px 16px 8px; }
  .search-box { display: flex; align-items: center; gap: 8px; background: white; border-radius: 14px; padding: 10px 14px; box-shadow: 0 1px 4px rgba(0,0,0,0.06); }
  .search-input { flex: 1; border: none; outline: none; font-size: 15px; background: transparent; }
  .search-input::placeholder { color: #B0B0B0; }
  .banners { display: flex; gap: 12px; padding: 12px 16px; overflow-x: auto; scrollbar-width: none; }
  .banners::-webkit-scrollbar { display: none; }
  .banner { min-width: 260px; height: 110px; border-radius: 20px; display: flex; align-items: flex-end; padding: 14px; flex-shrink: 0; cursor: pointer; position: relative; overflow: hidden; transition: transform 0.15s; }
  .banner:active { transform: scale(0.97); }
  .banner-1 { background: linear-gradient(135deg, #FF6B35, #FF3D3D); }
  .banner-2 { background: linear-gradient(135deg, #6C5CE7, #a29bfe); }
  .banner-3 { background: linear-gradient(135deg, #00B894, #00CEC9); }
  .banner-text { color: white; font-weight: 800; font-size: 15px; line-height: 1.2; }
  .banner-emoji { position: absolute; right: 14px; top: 14px; font-size: 42px; }
  .cats { display: flex; gap: 10px; padding: 4px 16px 12px; overflow-x: auto; scrollbar-width: none; }
  .cats::-webkit-scrollbar { display: none; }
  .cat-btn { display: flex; flex-direction: column; align-items: center; gap: 4px; background: white; border-radius: 16px; padding: 10px 14px; min-width: 72px; border: none; cursor: pointer; box-shadow: 0 1px 4px rgba(0,0,0,0.06); transition: all 0.15s; }
  .cat-btn:active { transform: scale(0.94); }
  .cat-btn.active { background: var(--black); }
  .cat-btn.active .cat-name { color: white; }
  .cat-emoji { font-size: 26px; }
  .cat-name { font-size: 11px; font-weight: 600; color: var(--black); white-space: nowrap; }
  .restaurants { padding: 4px 16px; display: flex; flex-direction: column; gap: 14px; }
  .rest-card { background: white; border-radius: 20px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.06); cursor: pointer; transition: transform 0.15s; }
  .rest-card:active { transform: scale(0.98); }
  .rest-img-placeholder { width: 100%; height: 150px; display: flex; align-items: center; justify-content: center; font-size: 60px; position: relative; overflow: hidden; }
  .rest-badge { position: absolute; top: 10px; left: 10px; font-size: 11px; font-weight: 700; padding: 3px 8px; border-radius: 8px; }
  .rest-badge.free { background: var(--green); color: white; }
  .rest-info { padding: 12px 14px; }
  .rest-name { font-size: 16px; font-weight: 700; color: var(--black); margin-bottom: 5px; }
  .rest-meta { display: flex; align-items: center; gap: 10px; flex-wrap: wrap; }
  .rest-rating { font-size: 13px; font-weight: 600; color: var(--black); }
  .rest-time { font-size: 13px; color: var(--gray-text); font-weight: 500; }
  .rest-delivery { font-size: 13px; font-weight: 600; color: var(--green); }
  .rest-tags { display: flex; gap: 6px; margin-top: 6px; flex-wrap: wrap; }
  .rest-tag { font-size: 11px; color: var(--gray-text); background: var(--gray-bg); border-radius: 6px; padding: 2px 7px; }
  .menu-hero { position: relative; }
  .menu-hero-img { width: 100%; height: 200px; display: flex; align-items: center; justify-content: center; font-size: 70px; overflow: hidden; }
  .menu-back { position: absolute; top: calc(var(--safe-top) + 12px); left: 12px; width: 38px; height: 38px; border-radius: 50%; background: white; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 18px; box-shadow: 0 2px 8px rgba(0,0,0,0.15); }
  .menu-rest-info { padding: 14px 16px 10px; background: white; }
  .menu-rest-name { font-size: 22px; font-weight: 800; color: var(--black); margin-bottom: 6px; letter-spacing: -0.3px; }
  .menu-rest-meta { display: flex; align-items: center; gap: 8px; flex-wrap: wrap; }
  .menu-rest-badge { font-size: 12px; font-weight: 600; padding: 3px 10px; border-radius: 10px; }
  .menu-rest-badge.delivery { background: #E8F8EE; color: var(--green); }
  .menu-rest-badge.time { background: #FFF5D0; color: #B8860B; }
  .menu-cats-scroll { display: flex; gap: 8px; padding: 10px 16px; overflow-x: auto; scrollbar-width: none; border-top: 1px solid var(--gray-border); background: white; position: sticky; top: 0; z-index: 50; }
  .menu-cats-scroll::-webkit-scrollbar { display: none; }
  .menu-cat-tab { padding: 6px 14px; border-radius: 20px; border: none; font-size: 13px; font-weight: 600; cursor: pointer; white-space: nowrap; transition: all 0.15s; }
  .menu-cat-tab.active { background: var(--black); color: white; }
  .menu-cat-tab:not(.active) { background: var(--gray-bg); color: var(--black); }
  .menu-section { padding: 16px 16px 0; }
  .menu-section-title { font-size: 18px; font-weight: 800; color: var(--black); margin-bottom: 12px; }
  .menu-items { display: flex; flex-direction: column; gap: 10px; margin-bottom: 20px; }
  .menu-item { background: white; border-radius: 16px; padding: 12px; display: flex; gap: 12px; align-items: flex-start; box-shadow: 0 1px 4px rgba(0,0,0,0.05); cursor: pointer; transition: transform 0.1s; }
  .menu-item:active { transform: scale(0.98); }
  .menu-item-img { width: 88px; height: 88px; border-radius: 12px; flex-shrink: 0; background: var(--gray-bg); display: flex; align-items: center; justify-content: center; font-size: 36px; overflow: hidden; }
  .menu-item-img img { width: 100%; height: 100%; object-fit: cover; }
  .menu-item-body { flex: 1; min-width: 0; }
  .menu-item-name { font-size: 14px; font-weight: 700; color: var(--black); margin-bottom: 4px; line-height: 1.3; }
  .menu-item-desc { font-size: 12px; color: var(--gray-text); line-height: 1.4; margin-bottom: 6px; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
  .menu-item-weight { font-size: 11px; color: #B0B0B0; font-weight: 500; margin-bottom: 6px; }
  .menu-item-footer { display: flex; align-items: center; justify-content: space-between; }
  .menu-item-price { font-size: 15px; font-weight: 800; color: var(--black); }
  .add-btn { width: 32px; height: 32px; border-radius: 10px; background: var(--yellow); border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 20px; font-weight: 700; transition: all 0.15s; flex-shrink: 0; }
  .add-btn:active { transform: scale(0.88); }
  .qty-ctrl { display: flex; align-items: center; gap: 8px; }
  .qty-btn { width: 30px; height: 30px; border-radius: 8px; background: var(--gray-bg); border: none; cursor: pointer; font-size: 18px; font-weight: 700; display: flex; align-items: center; justify-content: center; color: var(--black); }
  .qty-num { font-size: 15px; font-weight: 800; min-width: 20px; text-align: center; }
  .cart-empty { display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 80px 32px; text-align: center; gap: 16px; }
  .cart-empty-icon { font-size: 64px; }
  .cart-empty-title { font-size: 20px; font-weight: 800; color: var(--black); }
  .cart-empty-sub { font-size: 14px; color: var(--gray-text); }
  .cart-go-btn { margin-top: 8px; background: var(--yellow); color: var(--black); border: none; border-radius: 14px; padding: 14px 28px; font-size: 15px; font-weight: 700; cursor: pointer; }
  .cart-content { padding: 16px; }
  .cart-rest-name { font-size: 13px; color: var(--gray-text); font-weight: 500; margin-bottom: 12px; }
  .cart-items { display: flex; flex-direction: column; gap: 10px; margin-bottom: 16px; }
  .cart-item { background: white; border-radius: 16px; padding: 12px; display: flex; gap: 10px; align-items: center; box-shadow: 0 1px 4px rgba(0,0,0,0.05); }
  .cart-item-emoji { font-size: 32px; width: 48px; height: 48px; display: flex; align-items: center; justify-content: center; background: var(--gray-bg); border-radius: 10px; flex-shrink: 0; overflow: hidden; }
  .cart-item-emoji img { width: 100%; height: 100%; object-fit: cover; border-radius: 10px; }
  .cart-item-body { flex: 1; min-width: 0; }
  .cart-item-name { font-size: 13px; font-weight: 700; color: var(--black); margin-bottom: 2px; line-height: 1.3; }
  .cart-item-opt { font-size: 11px; color: var(--gray-text); }
  .cart-qty-btn { width: 26px; height: 26px; border-radius: 7px; background: var(--gray-bg); border: none; cursor: pointer; font-size: 16px; font-weight: 700; color: var(--black); display: flex; align-items: center; justify-content: center; }
  .cart-qty-num { font-size: 14px; font-weight: 800; min-width: 18px; text-align: center; }
  .cart-promo { background: white; border-radius: 16px; padding: 14px; margin-bottom: 14px; display: flex; gap: 10px; align-items: center; box-shadow: 0 1px 4px rgba(0,0,0,0.05); }
  .promo-input { flex: 1; border: none; outline: none; font-size: 14px; background: transparent; }
  .promo-apply-btn { background: var(--yellow); border: none; border-radius: 10px; padding: 8px 14px; font-size: 13px; font-weight: 700; color: var(--black); cursor: pointer; }
  .cart-summary { background: white; border-radius: 16px; padding: 16px; margin-bottom: 14px; box-shadow: 0 1px 4px rgba(0,0,0,0.05); }
  .summary-row { display: flex; justify-content: space-between; margin-bottom: 10px; }
  .summary-row:last-child { margin-bottom: 0; }
  .summary-label { font-size: 14px; color: var(--gray-text); }
  .summary-value { font-size: 14px; font-weight: 600; color: var(--black); }
  .summary-total .summary-label, .summary-total .summary-value { font-size: 16px; font-weight: 800; color: var(--black); }
  .summary-divider { height: 1px; background: var(--gray-border); margin: 10px 0; }
  .summary-free { color: var(--green); }
  .checkout-btn { width: 100%; background: var(--yellow); color: var(--black); border: none; border-radius: 16px; padding: 16px; font-size: 16px; font-weight: 800; cursor: pointer; transition: all 0.15s; display: flex; align-items: center; justify-content: space-between; }
  .checkout-btn:active { transform: scale(0.98); }
  .checkout-section { background: white; border-radius: 20px; margin: 12px 16px; padding: 16px; box-shadow: 0 1px 4px rgba(0,0,0,0.05); }
  .checkout-section-title { font-size: 15px; font-weight: 800; color: var(--black); margin-bottom: 12px; }
  .checkout-row { display: flex; align-items: center; gap: 12px; padding: 10px 0; border-bottom: 1px solid var(--gray-border); cursor: pointer; }
  .checkout-row:last-child { border-bottom: none; padding-bottom: 0; }
  .checkout-row-icon { font-size: 20px; width: 36px; height: 36px; background: var(--gray-bg); border-radius: 10px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
  .checkout-row-body { flex: 1; }
  .checkout-row-label { font-size: 12px; color: var(--gray-text); font-weight: 500; }
  .checkout-row-value { font-size: 14px; font-weight: 600; color: var(--black); }
  .pay-method { display: flex; gap: 8px; flex-wrap: wrap; }
  .pay-option { flex: 1; min-width: 80px; padding: 10px; border-radius: 12px; border: 2px solid var(--gray-border); text-align: center; cursor: pointer; transition: all 0.15s; }
  .pay-option.selected { border-color: var(--black); background: var(--black); color: white; }
  .pay-option-icon { font-size: 20px; margin-bottom: 2px; }
  .pay-option-name { font-size: 11px; font-weight: 600; }
  .place-order-btn { margin: 12px 16px; margin-bottom: calc(12px + var(--safe-bot)); width: calc(100% - 32px); background: var(--yellow); color: var(--black); border: none; border-radius: 16px; padding: 17px; font-size: 17px; font-weight: 800; cursor: pointer; transition: all 0.15s; display: block; }
  .place-order-btn:active { transform: scale(0.98); }
  .place-order-btn:disabled { opacity: 0.6; }
  .order-status { padding: 20px 16px; text-align: center; }
  .order-check { font-size: 64px; margin-bottom: 16px; }
  .order-title { font-size: 24px; font-weight: 900; color: var(--black); margin-bottom: 8px; letter-spacing: -0.4px; }
  .order-sub { font-size: 15px; color: var(--gray-text); margin-bottom: 24px; }
  .order-nr { background: white; border-radius: 16px; padding: 16px; box-shadow: 0 1px 4px rgba(0,0,0,0.06); margin-bottom: 12px; }
  .order-nr-label { font-size: 12px; color: var(--gray-text); font-weight: 500; margin-bottom: 4px; }
  .order-nr-value { font-size: 20px; font-weight: 900; color: var(--black); }
  .order-track { background: white; border-radius: 16px; padding: 20px; box-shadow: 0 1px 4px rgba(0,0,0,0.06); margin-bottom: 20px; }
  .track-step { display: flex; gap: 14px; align-items: flex-start; margin-bottom: 16px; position: relative; }
  .track-step:last-child { margin-bottom: 0; }
  .track-line { position: absolute; left: 14px; top: 30px; width: 2px; height: calc(100% + 4px); background: var(--gray-border); }
  .track-step:last-child .track-line { display: none; }
  .track-dot { width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 14px; flex-shrink: 0; z-index: 1; }
  .track-dot.done { background: var(--green); color: white; }
  .track-dot.active { background: var(--yellow); animation: pulse 1.5s infinite; }
  .track-dot.pending { background: var(--gray-border); }
  @keyframes pulse { 0%,100%{transform:scale(1)}50%{transform:scale(1.1)} }
  .track-label { font-size: 14px; font-weight: 700; color: var(--black); }
  .track-time { font-size: 12px; color: var(--gray-text); margin-top: 2px; }
  .track-text { padding-top: 4px; }
  .back-to-main { width: 100%; background: var(--yellow); color: var(--black); border: none; border-radius: 14px; padding: 15px; font-size: 15px; font-weight: 800; cursor: pointer; }
  .bottom-nav { display: flex; background: white; border-top: 1px solid var(--gray-border); padding: 8px 0 calc(8px + var(--safe-bot)); flex-shrink: 0; z-index: 100; }
  .nav-btn { flex: 1; display: flex; flex-direction: column; align-items: center; gap: 2px; border: none; background: transparent; cursor: pointer; padding: 4px 0; }
  .nav-icon { font-size: 22px; position: relative; display: inline-block; }
  .nav-label { font-size: 10px; font-weight: 600; color: var(--gray-text); }
  .nav-btn.active .nav-label { color: var(--black); }
  .cart-badge { position: absolute; top: -4px; right: -8px; background: var(--red); color: white; font-size: 9px; font-weight: 800; min-width: 16px; height: 16px; border-radius: 8px; display: flex; align-items: center; justify-content: center; padding: 0 3px; border: 2px solid white; }
  .loading-overlay { position: fixed; inset: 0; background: var(--yellow); display: flex; align-items: center; justify-content: center; z-index: 1000; transition: opacity 0.4s; flex-direction: column; gap: 12px; }
  .loading-logo { font-size: 42px; font-weight: 900; color: var(--black); }
  .loading-sub { font-size: 14px; color: rgba(0,0,0,0.4); font-weight: 500; }
  .toast { position: fixed; bottom: calc(80px + var(--safe-bot)); left: 50%; transform: translateX(-50%) translateY(20px); background: var(--black); color: white; border-radius: 14px; padding: 12px 20px; font-size: 14px; font-weight: 600; z-index: 500; opacity: 0; transition: all 0.3s; white-space: nowrap; pointer-events: none; max-width: 90vw; overflow: hidden; text-overflow: ellipsis; }
  .toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }
  .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 200; display: flex; align-items: flex-end; opacity: 0; pointer-events: none; transition: opacity 0.3s; }
  .modal-overlay.open { opacity: 1; pointer-events: all; }
  .modal { background: white; border-radius: 24px 24px 0 0; width: 100%; max-height: 90vh; overflow-y: auto; padding-bottom: calc(20px + var(--safe-bot)); transform: translateY(100%); transition: transform 0.35s cubic-bezier(0.34, 1.56, 0.64, 1); }
  .modal-overlay.open .modal { transform: translateY(0); }
  .modal-img { width: 100%; height: 220px; display: flex; align-items: center; justify-content: center; font-size: 80px; background: var(--gray-bg); border-radius: 24px 24px 0 0; overflow: hidden; position: relative; }
  .modal-img img { width: 100%; height: 100%; object-fit: cover; }
  .modal-close { position: absolute; top: 14px; right: 14px; width: 32px; height: 32px; border-radius: 50%; background: rgba(0,0,0,0.4); border: none; cursor: pointer; color: white; font-size: 16px; display: flex; align-items: center; justify-content: center; }
  .modal-body { padding: 20px 20px 0; }
  .modal-name { font-size: 22px; font-weight: 800; color: var(--black); margin-bottom: 8px; letter-spacing: -0.3px; }
  .modal-desc { font-size: 14px; color: var(--gray-text); line-height: 1.5; margin-bottom: 8px; }
  .modal-weight { font-size: 13px; color: #B0B0B0; margin-bottom: 18px; }
  .modal-opts-title { font-size: 15px; font-weight: 700; color: var(--black); margin-bottom: 10px; }
  .modal-opts { display: flex; flex-direction: column; gap: 8px; margin-bottom: 20px; }
  .modal-opt { display: flex; align-items: center; justify-content: space-between; padding: 10px 14px; border-radius: 12px; border: 2px solid var(--gray-border); cursor: pointer; transition: all 0.15s; }
  .modal-opt.selected { border-color: var(--black); background: #f8f8f8; }
  .modal-opt-name { font-size: 14px; font-weight: 500; }
  .modal-opt-price { font-size: 13px; color: var(--gray-text); font-weight: 600; }
  .modal-add-row { display: flex; align-items: center; gap: 12px; margin-top: 4px; }
  .modal-qty-ctrl { display: flex; align-items: center; gap: 12px; }
  .modal-qty-btn { width: 36px; height: 36px; border-radius: 10px; background: var(--gray-bg); border: none; cursor: pointer; font-size: 20px; font-weight: 700; color: var(--black); display: flex; align-items: center; justify-content: center; }
  .modal-qty-num { font-size: 18px; font-weight: 800; min-width: 24px; text-align: center; }
  .modal-add-btn { flex: 1; background: var(--yellow); color: var(--black); border: none; border-radius: 14px; padding: 15px; font-size: 15px; font-weight: 800; cursor: pointer; display: flex; align-items: center; justify-content: space-between; transition: all 0.15s; }
  .modal-add-btn:active { transform: scale(0.98); }
  /* PROFILE */
  .profile-header { background: var(--yellow); padding: calc(var(--safe-top) + 20px) 16px 30px; }
  .profile-header-top { display: flex; align-items: center; gap: 12px; margin-bottom: 20px; }
  .profile-avatar { width: 72px; height: 72px; border-radius: 50%; background: rgba(0,0,0,0.1); display: flex; align-items: center; justify-content: center; font-size: 32px; flex-shrink: 0; }
  .profile-info { flex: 1; }
  .profile-name { font-size: 20px; font-weight: 800; color: var(--black); }
  .profile-uid { font-size: 12px; color: rgba(0,0,0,0.5); margin-top: 2px; }
  .profile-plus { display: flex; align-items: center; gap: 8px; background: rgba(0,0,0,0.08); border-radius: 14px; padding: 10px 14px; }
  .profile-plus-icon { font-size: 20px; }
  .profile-plus-text { font-size: 13px; font-weight: 600; color: var(--black); flex: 1; }
  .profile-plus-status { font-size: 11px; font-weight: 700; color: var(--gray-text); background: white; border-radius: 8px; padding: 3px 8px; }
  .profile-menu { padding: 16px; display: flex; flex-direction: column; gap: 10px; }
  .profile-section { background: white; border-radius: 20px; overflow: hidden; box-shadow: 0 1px 4px rgba(0,0,0,0.05); }
  .profile-item { padding: 14px 16px; display: flex; align-items: center; gap: 12px; cursor: pointer; border-bottom: 1px solid var(--gray-border); }
  .profile-item:last-child { border-bottom: none; }
  .profile-item:active { background: var(--gray-bg); }
  .profile-item-icon { font-size: 22px; width: 40px; height: 40px; background: var(--gray-bg); border-radius: 12px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
  .profile-item-body { flex: 1; }
  .profile-item-text { font-size: 15px; font-weight: 600; color: var(--black); }
  .profile-item-sub { font-size: 12px; color: var(--gray-text); margin-top: 1px; }
  .profile-item-arrow { color: var(--gray-text); font-size: 16px; }
  /* ORDERS LIST */
  .orders-list { padding: 12px 16px; display: flex; flex-direction: column; gap: 12px; }
  .order-card { background: white; border-radius: 20px; padding: 16px; box-shadow: 0 1px 4px rgba(0,0,0,0.05); cursor: pointer; }
  .order-card:active { transform: scale(0.98); }
  .order-card-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px; }
  .order-card-nr { font-size: 14px; font-weight: 800; color: var(--black); }
  .order-card-date { font-size: 12px; color: var(--gray-text); }
  .order-card-rest { font-size: 14px; color: var(--gray-text); margin-bottom: 8px; }
  .order-card-items { font-size: 13px; color: var(--black); font-weight: 600; margin-bottom: 6px; }
  .order-card-footer { display: flex; align-items: center; justify-content: space-between; }
  .order-card-total { font-size: 15px; font-weight: 800; color: var(--black); }
  .order-status-badge { font-size: 11px; font-weight: 700; padding: 3px 10px; border-radius: 10px; }
  .order-status-badge.done { background: #E8F8EE; color: var(--green); }
  .order-status-badge.pending { background: #FFF5D0; color: #B8860B; }
  .order-status-badge.cancelled { background: #FEE; color: var(--red); }
  /* ADDRESSES */
  .address-card { background: white; border-radius: 16px; padding: 14px 16px; margin: 0 16px 10px; display: flex; align-items: center; gap: 12px; box-shadow: 0 1px 4px rgba(0,0,0,0.05); }
  .address-card-icon { font-size: 22px; width: 40px; height: 40px; background: var(--gray-bg); border-radius: 12px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
  .address-card-body { flex: 1; }
  .address-card-name { font-size: 14px; font-weight: 700; color: var(--black); }
  .address-card-full { font-size: 12px; color: var(--gray-text); margin-top: 2px; }
  /* PAYMENT METHODS */
  .payment-card { background: white; border-radius: 16px; padding: 14px 16px; margin: 0 16px 10px; display: flex; align-items: center; gap: 12px; box-shadow: 0 1px 4px rgba(0,0,0,0.05); }
  .payment-card-icon { font-size: 22px; width: 40px; height: 40px; background: var(--gray-bg); border-radius: 12px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
  .payment-card-body { flex: 1; }
  .payment-card-name { font-size: 14px; font-weight: 700; color: var(--black); }
  .payment-card-sub { font-size: 12px; color: var(--gray-text); margin-top: 2px; }
  /* PROMOS */
  .promo-card { background: white; border-radius: 16px; padding: 16px; margin: 0 16px 10px; box-shadow: 0 1px 4px rgba(0,0,0,0.05); }
  .promo-card-code { font-size: 16px; font-weight: 800; color: var(--black); margin-bottom: 4px; font-family: monospace; letter-spacing: 1px; }
  .promo-card-desc { font-size: 13px; color: var(--gray-text); }
  .promo-card-badge { display: inline-block; margin-top: 8px; font-size: 11px; font-weight: 700; padding: 3px 10px; border-radius: 8px; background: #E8F8EE; color: var(--green); }
  /* SUPPORT */
  .support-chat { padding: 16px; display: flex; flex-direction: column; gap: 12px; height: calc(100% - 120px); overflow-y: auto; }
  .support-msg { max-width: 80%; padding: 12px 14px; border-radius: 16px; font-size: 14px; line-height: 1.4; }
  .support-msg.bot { background: white; color: var(--black); align-self: flex-start; border-bottom-left-radius: 4px; box-shadow: 0 1px 4px rgba(0,0,0,0.06); }
  .support-msg.user { background: var(--black); color: white; align-self: flex-end; border-bottom-right-radius: 4px; }
  .support-input-row { padding: 12px 16px; background: white; border-top: 1px solid var(--gray-border); display: flex; gap: 10px; align-items: center; }
  .support-input { flex: 1; border: 1px solid var(--gray-border); border-radius: 20px; padding: 10px 14px; font-size: 14px; outline: none; background: var(--gray-bg); }
  .support-send { width: 40px; height: 40px; border-radius: 50%; background: var(--yellow); border: none; cursor: pointer; font-size: 18px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
  /* MISC */
  .screen-header { display: flex; align-items: center; gap: 10px; padding: calc(var(--safe-top) + 12px) 16px 12px; background: white; position: sticky; top: 0; z-index: 10; border-bottom: 1px solid var(--gray-border); flex-shrink: 0; }
  .back-btn { background: none; border: none; font-size: 24px; cursor: pointer; padding: 0; color: var(--black); line-height: 1; }
  .screen-hdr-title { font-size: 18px; font-weight: 800; color: var(--black); }
  .spinner { display: flex; justify-content: center; padding: 40px; }
  .spin { width: 32px; height: 32px; border: 3px solid var(--gray-border); border-top-color: var(--black); border-radius: 50%; animation: spin 0.8s linear infinite; }
  @keyframes spin { to{transform:rotate(360deg)} }
  .empty-state { text-align: center; padding: 60px 32px; color: var(--gray-text); }
  .empty-state-icon { font-size: 48px; margin-bottom: 12px; }
  .empty-state-text { font-size: 15px; font-weight: 600; }
  .empty-state-sub { font-size: 13px; margin-top: 6px; }
</style>
</head>
<body>

<div class="loading-overlay" id="loading">
  <div class="loading-logo">üçî –ï–¥–∞</div>
  <div class="loading-sub">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
</div>

<div class="toast" id="toast"></div>

<div class="modal-overlay" id="itemModal">
  <div class="modal">
    <div class="modal-img" id="modalImg">
      <button class="modal-close" onclick="closeModal()">‚úï</button>
    </div>
    <div class="modal-body">
      <div class="modal-name" id="modalName"></div>
      <div class="modal-desc" id="modalDesc"></div>
      <div class="modal-weight" id="modalWeight"></div>
      <div id="modalOptsWrap" style="display:none">
        <div class="modal-opts-title" id="modalOptsTitle"></div>
        <div class="modal-opts" id="modalOpts"></div>
      </div>
      <div class="modal-add-row">
        <div class="modal-qty-ctrl">
          <button class="modal-qty-btn" onclick="changeModalQty(-1)">‚àí</button>
          <span class="modal-qty-num" id="modalQty">1</span>
          <button class="modal-qty-btn" onclick="changeModalQty(1)">+</button>
        </div>
        <button class="modal-add-btn" onclick="addFromModal()">
          <span>–í –∫–æ—Ä–∑–∏–Ω—É</span>
          <span id="modalAddPrice"></span>
        </button>
      </div>
    </div>
  </div>
</div>

<div id="app">
  <div class="topbar" id="mainTopbar">
    <div class="topbar-inner">
      <div class="logo">–ï–¥–∞</div>
      <button class="address-btn" onclick="showToast('–°–º–µ–Ω–∞ –∞–¥—Ä–µ—Å–∞ —Å–∫–æ—Ä–æ')">
        <span>üìç</span>
        <span class="address-btn-text" id="addressText">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
        <span style="color:var(--black);opacity:0.4;margin-left:auto;">‚ñæ</span>
      </button>
      <button class="profile-btn" onclick="goTo('profile')">üë§</button>
    </div>
  </div>
  <div class="tabs" id="catalogTabs">
    <button class="tab-btn active" id="tab-online" onclick="selectTab('online',this)">–ó–∞–∫–∞–∑–∞—Ç—å</button>
    <button class="tab-btn" id="tab-offline" onclick="selectTab('offline',this)">–°—Ö–æ–¥–∏—Ç—å</button>
  </div>

  <div class="content" id="mainContent">

    <!-- CATALOG -->
    <div class="screen active" id="screen-catalog">
      <div class="search-wrap">
        <div class="search-box">
          <span>üîç</span>
          <input class="search-input" placeholder="–†–µ—Å—Ç–æ—Ä–∞–Ω –∏–ª–∏ –±–ª—é–¥–æ" id="searchInput" oninput="filterRestaurants(this.value)">
        </div>
      </div>
      <div class="banners">
        <div class="banner banner-1"><span class="banner-emoji">üî•</span><div class="banner-text">–ë–µ—Å–ø–ª–∞—Ç–Ω–∞—è<br>–¥–æ—Å—Ç–∞–≤–∫–∞</div></div>
        <div class="banner banner-2"><span class="banner-emoji">‚ö°</span><div class="banner-text">–ó–∞ 30 –º–∏–Ω—É—Ç<br>–∏–ª–∏ —Å–∫–∏–¥–∫–∞</div></div>
        <div class="banner banner-3"><span class="banner-emoji">üéÅ</span><div class="banner-text">–ù–æ–≤—ã–µ<br>—Ä–µ—Å—Ç–æ—Ä–∞–Ω—ã</div></div>
      </div>
      <div class="cats" id="catsList"></div>
      <div style="padding:4px 16px 10px;"><span style="font-size:20px;font-weight:800;color:var(--black);letter-spacing:-0.3px;">–†–µ—Å—Ç–æ—Ä–∞–Ω—ã</span></div>
      <div class="restaurants" id="restaurantsList"><div class="spinner"><div class="spin"></div></div></div>
      <div style="height:20px;"></div>
    </div>

    <!-- MENU -->
    <div class="screen" id="screen-menu">
      <div class="menu-hero">
        <div class="menu-hero-img" id="menuHeroImg"></div>
        <button class="menu-back" onclick="goTo('catalog')">‚Üê</button>
      </div>
      <div class="menu-rest-info">
        <div class="menu-rest-name" id="menuRestName"></div>
        <div class="menu-rest-meta" id="menuRestMeta"></div>
      </div>
      <div class="menu-cats-scroll" id="menuCatTabs"></div>
      <div id="menuItemsContainer"></div>
      <div style="height:24px;"></div>
    </div>

    <!-- CART -->
    <div class="screen" id="screen-cart">
      <div class="screen-header">
        <button class="back-btn" onclick="goTo('catalog')">‚Üê</button>
        <span class="screen-hdr-title">–ö–æ—Ä–∑–∏–Ω–∞</span>
      </div>
      <div class="cart-empty" id="cartEmpty">
        <div class="cart-empty-icon">üõí</div>
        <div class="cart-empty-title">–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞—è</div>
        <div class="cart-empty-sub">–î–æ–±–∞–≤—å—Ç–µ –±–ª—é–¥–∞ –∏–∑ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞</div>
        <button class="cart-go-btn" onclick="goTo('catalog')">–ö —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞–º</button>
      </div>
      <div id="cartFilled" style="display:none">
        <div class="cart-content">
          <div class="cart-rest-name" id="cartRestName"></div>
          <div class="cart-items" id="cartItemsList"></div>
          <div class="cart-promo">
            <span>üè∑Ô∏è</span>
            <input class="promo-input" placeholder="–ü—Ä–æ–º–æ–∫–æ–¥" id="promoInput">
            <button class="promo-apply-btn" onclick="applyPromo()">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
          </div>
          <div class="cart-summary">
            <div class="summary-row"><span class="summary-label">–¢–æ–≤–∞—Ä—ã</span><span class="summary-value" id="summaryItems">0 ‚ÇΩ</span></div>
            <div class="summary-row"><span class="summary-label">–î–æ—Å—Ç–∞–≤–∫–∞</span><span class="summary-value summary-free" id="summaryDelivery">–ë–µ—Å–ø–ª–∞—Ç–Ω–æ</span></div>
            <div class="summary-row"><span class="summary-label">–°–µ—Ä–≤–∏—Å–Ω—ã–π —Å–±–æ—Ä</span><span class="summary-value" id="summaryFee">0 ‚ÇΩ</span></div>
            <div class="summary-divider"></div>
            <div class="summary-row summary-total"><span class="summary-label">–ò—Ç–æ–≥–æ</span><span class="summary-value" id="summaryTotal">0 ‚ÇΩ</span></div>
          </div>
          <button class="checkout-btn" onclick="goTo('checkout')">
            <span>–û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑</span><span id="checkoutBtnTotal">0 ‚ÇΩ</span>
          </button>
        </div>
      </div>
    </div>

    <!-- CHECKOUT -->
    <div class="screen" id="screen-checkout">
      <div class="screen-header">
        <button class="back-btn" onclick="goTo('cart')">‚Üê</button>
        <span class="screen-hdr-title">–û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ</span>
      </div>
      <div class="checkout-section">
        <div class="checkout-section-title">üì¶ –î–æ—Å—Ç–∞–≤–∫–∞</div>
        <div class="checkout-row">
          <div class="checkout-row-icon">üìç</div>
          <div class="checkout-row-body">
            <div class="checkout-row-label">–ê–¥—Ä–µ—Å –¥–æ—Å—Ç–∞–≤–∫–∏</div>
            <div class="checkout-row-value" id="checkoutAddr">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
          </div>
          <div style="color:var(--gray-text);">‚Ä∫</div>
        </div>
        <div class="checkout-row">
          <div class="checkout-row-icon">‚è±Ô∏è</div>
          <div class="checkout-row-body">
            <div class="checkout-row-label">–í—Ä–µ–º—è –¥–æ—Å—Ç–∞–≤–∫–∏</div>
            <div class="checkout-row-value" id="checkoutTime">~30 –º–∏–Ω</div>
          </div>
        </div>
      </div>
      <div class="checkout-section">
        <div class="checkout-section-title">üí≥ –û–ø–ª–∞—Ç–∞</div>
        <div class="pay-method" id="payMethodList">
          <div class="pay-option selected" onclick="selectPay(this,'sbp_qr','sbp')"><div class="pay-option-icon">‚ö°</div><div class="pay-option-name">–°–ë–ü</div></div>
          <div class="pay-option" onclick="selectPay(this,'card','card')"><div class="pay-option-icon">üí≥</div><div class="pay-option-name">–ö–∞—Ä—Ç–∞</div></div>
          <div class="pay-option" onclick="selectPay(this,'cash','cash')"><div class="pay-option-icon">üíµ</div><div class="pay-option-name">–ù–∞–ª–∏—á–Ω—ã–µ</div></div>
        </div>
      </div>
      <div class="checkout-section">
        <div class="checkout-section-title">üìù –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</div>
        <input id="checkoutComment" style="width:100%;border:1px solid var(--gray-border);border-radius:10px;padding:10px 12px;font-size:14px;outline:none;background:var(--gray-bg);" placeholder="–î–æ–º–æ—Ñ–æ–Ω, —ç—Ç–∞–∂, –ø–æ–∂–µ–ª–∞–Ω–∏—è...">
      </div>
      <div class="checkout-section">
        <div class="checkout-section-title">üßæ –°–æ—Å—Ç–∞–≤ –∑–∞–∫–∞–∑–∞</div>
        <div id="checkoutItems"></div>
        <div class="summary-divider"></div>
        <div class="summary-row summary-total" style="margin-top:10px;">
          <span class="summary-label">–ò—Ç–æ–≥–æ</span>
          <span class="summary-value" id="checkoutTotal">0 ‚ÇΩ</span>
        </div>
      </div>
      <button class="place-order-btn" id="placeOrderBtn" onclick="placeOrder()">
        –ó–∞–∫–∞–∑–∞—Ç—å ¬∑ <span id="placeOrderTotal">0 ‚ÇΩ</span>
      </button>
    </div>

    <!-- ORDER TRACKING -->
    <div class="screen" id="screen-order">
      <div class="order-status">
        <div class="order-check">‚úÖ</div>
        <div class="order-title">–ó–∞–∫–∞–∑ –ø—Ä–∏–Ω—è—Ç!</div>
        <div class="order-sub">–†–µ—Å—Ç–æ—Ä–∞–Ω –Ω–∞—á–∞–ª –≥–æ—Ç–æ–≤–∏—Ç—å –≤–∞—à –∑–∞–∫–∞–∑</div>
        <div class="order-nr">
          <div class="order-nr-label">–ù–æ–º–µ—Ä –∑–∞–∫–∞–∑–∞</div>
          <div class="order-nr-value" id="orderNr">‚Äî</div>
        </div>
        <div class="order-track">
          <div class="track-step">
            <div class="track-dot done" id="step1dot">‚úì</div>
            <div class="track-line"></div>
            <div class="track-text"><div class="track-label">–ó–∞–∫–∞–∑ –ø—Ä–∏–Ω—è—Ç</div><div class="track-time" id="step1time"></div></div>
          </div>
          <div class="track-step">
            <div class="track-dot active" id="step2dot">üç≥</div>
            <div class="track-line"></div>
            <div class="track-text"><div class="track-label">–†–µ—Å—Ç–æ—Ä–∞–Ω –≥–æ—Ç–æ–≤–∏—Ç</div><div class="track-time" id="step2time">~20 –º–∏–Ω</div></div>
          </div>
          <div class="track-step">
            <div class="track-dot pending" id="step3dot">üõµ</div>
            <div class="track-line"></div>
            <div class="track-text"><div class="track-label">–ö—É—Ä—å–µ—Ä –≤ –ø—É—Ç–∏</div><div class="track-time" id="step3time"></div></div>
          </div>
          <div class="track-step">
            <div class="track-dot pending" id="step4dot">üéâ</div>
            <div class="track-text"><div class="track-label">–î–æ—Å—Ç–∞–≤–ª–µ–Ω–æ</div><div class="track-time" id="step4time"></div></div>
          </div>
        </div>
        <button class="back-to-main" onclick="goTo('catalog');clearCart();">–ù–∞ –≥–ª–∞–≤–Ω—É—é</button>
      </div>
    </div>

    <!-- PROFILE -->
    <div class="screen" id="screen-profile">
      <div class="profile-header">
        <div class="profile-header-top">
          <button class="back-btn" onclick="goTo('catalog')" style="margin-right:4px;">‚Üê</button>
          <div class="profile-avatar">üë§</div>
          <div class="profile-info">
            <div class="profile-name" id="profileName">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
            <div class="profile-uid" id="profileUid"></div>
          </div>
        </div>
        <div class="profile-plus">
          <span class="profile-plus-icon">‚≠ê</span>
          <span class="profile-plus-text" id="profilePlusText">–Ø–Ω–¥–µ–∫—Å –ü–ª—é—Å</span>
          <span class="profile-plus-status" id="profilePlusStatus">–ù–µ –∞–∫—Ç–∏–≤–µ–Ω</span>
        </div>
      </div>
      <div class="profile-menu">
        <div class="profile-section">
          <div class="profile-item" onclick="goTo('orders')">
            <div class="profile-item-icon">üì¶</div>
            <div class="profile-item-body">
              <div class="profile-item-text">–ú–æ–∏ –∑–∞–∫–∞–∑—ã</div>
              <div class="profile-item-sub" id="profileOrdersSub">–ò—Å—Ç–æ—Ä–∏—è –∑–∞–∫–∞–∑–æ–≤</div>
            </div>
            <span class="profile-item-arrow">‚Ä∫</span>
          </div>
          <div class="profile-item" onclick="goTo('addresses')">
            <div class="profile-item-icon">üìç</div>
            <div class="profile-item-body">
              <div class="profile-item-text">–ê–¥—Ä–µ—Å–∞ –¥–æ—Å—Ç–∞–≤–∫–∏</div>
              <div class="profile-item-sub" id="profileAddrSub">–ú–æ–∏ –∞–¥—Ä–µ—Å–∞</div>
            </div>
            <span class="profile-item-arrow">‚Ä∫</span>
          </div>
          <div class="profile-item" onclick="goTo('payments')">
            <div class="profile-item-icon">üí≥</div>
            <div class="profile-item-body">
              <div class="profile-item-text">–°–ø–æ—Å–æ–±—ã –æ–ø–ª–∞—Ç—ã</div>
              <div class="profile-item-sub" id="profilePaySub">–ö–∞—Ä—Ç—ã –∏ –∫–æ—à–µ–ª—å–∫–∏</div>
            </div>
            <span class="profile-item-arrow">‚Ä∫</span>
          </div>
        </div>
        <div class="profile-section">
          <div class="profile-item" onclick="goTo('promos')">
            <div class="profile-item-icon">üè∑Ô∏è</div>
            <div class="profile-item-body">
              <div class="profile-item-text">–ü—Ä–æ–º–æ–∫–æ–¥—ã –∏ –±–æ–Ω—É—Å—ã</div>
              <div class="profile-item-sub" id="profilePromoSub">–ê–∫—Ç–∏–≤–Ω—ã–µ –ø—Ä–æ–º–æ–∫–æ–¥—ã</div>
            </div>
            <span class="profile-item-arrow">‚Ä∫</span>
          </div>
          <div class="profile-item" onclick="goTo('support')">
            <div class="profile-item-icon">üí¨</div>
            <div class="profile-item-body">
              <div class="profile-item-text">–ü–æ–¥–¥–µ—Ä–∂–∫–∞</div>
              <div class="profile-item-sub">–ó–∞–¥–∞—Ç—å –≤–æ–ø—Ä–æ—Å</div>
            </div>
            <span class="profile-item-arrow">‚Ä∫</span>
          </div>
        </div>
      </div>
    </div>

    <!-- ORDERS HISTORY -->
    <div class="screen" id="screen-orders">
      <div class="screen-header">
        <button class="back-btn" onclick="goTo('profile')">‚Üê</button>
        <span class="screen-hdr-title">–ú–æ–∏ –∑–∞–∫–∞–∑—ã</span>
      </div>
      <div id="ordersListContainer"><div class="spinner"><div class="spin"></div></div></div>
    </div>

    <!-- ADDRESSES -->
    <div class="screen" id="screen-addresses">
      <div class="screen-header">
        <button class="back-btn" onclick="goTo('profile')">‚Üê</button>
        <span class="screen-hdr-title">–ê–¥—Ä–µ—Å–∞ –¥–æ—Å—Ç–∞–≤–∫–∏</span>
      </div>
      <div style="height:12px;"></div>
      <div id="addressesContainer"><div class="spinner"><div class="spin"></div></div></div>
    </div>

    <!-- PAYMENT METHODS -->
    <div class="screen" id="screen-payments">
      <div class="screen-header">
        <button class="back-btn" onclick="goTo('profile')">‚Üê</button>
        <span class="screen-hdr-title">–°–ø–æ—Å–æ–±—ã –æ–ø–ª–∞—Ç—ã</span>
      </div>
      <div style="height:12px;"></div>
      <div id="paymentsContainer"><div class="spinner"><div class="spin"></div></div></div>
    </div>

    <!-- PROMOS -->
    <div class="screen" id="screen-promos">
      <div class="screen-header">
        <button class="back-btn" onclick="goTo('profile')">‚Üê</button>
        <span class="screen-hdr-title">–ü—Ä–æ–º–æ–∫–æ–¥—ã</span>
      </div>
      <div style="height:12px;"></div>
      <div id="promosContainer"><div class="spinner"><div class="spin"></div></div></div>
    </div>

    <!-- SUPPORT -->
    <div class="screen" id="screen-support" style="display:flex;flex-direction:column;height:100%;">
      <div class="screen-header">
        <button class="back-btn" onclick="goTo('profile')">‚Üê</button>
        <span class="screen-hdr-title">–ü–æ–¥–¥–µ—Ä–∂–∫–∞</span>
      </div>
      <div class="support-chat" id="supportChat">
        <div class="support-msg bot">–ü—Ä–∏–≤–µ—Ç! –Ø –ø–æ–º–æ–≥—É –≤–∞–º —Å –≤–æ–ø—Ä–æ—Å–∞–º–∏ –æ –∑–∞–∫–∞–∑–∞—Ö. –ß–µ–º –º–æ–≥—É –ø–æ–º–æ—á—å?</div>
      </div>
      <div class="support-input-row">
        <input class="support-input" id="supportInput" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." onkeydown="if(event.key==='Enter')sendSupport()">
        <button class="support-send" onclick="sendSupport()">‚û§</button>
      </div>
    </div>

  </div>

  <div class="bottom-nav" id="bottomNav">
    <button class="nav-btn active" id="nav-catalog" onclick="goTo('catalog')">
      <span class="nav-icon">üè†</span><span class="nav-label">–ì–ª–∞–≤–Ω–∞—è</span>
    </button>
    <button class="nav-btn" id="nav-cart" onclick="goTo('cart')">
      <span class="nav-icon">üõí<span class="cart-badge" id="cartBadge"></span></span>
      <span class="nav-label">–ö–æ—Ä–∑–∏–Ω–∞</span>
    </button>
    <button class="nav-btn" id="nav-profile" onclick="goTo('profile')">
      <span class="nav-icon">üë§</span><span class="nav-label">–ü—Ä–æ—Ñ–∏–ª—å</span>
    </button>
  </div>
</div>

<script>
// ‚îÄ‚îÄ‚îÄ –ü–ê–†–ê–ú–ï–¢–†–´ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const _p         = new URLSearchParams(location.search);
const TOKEN      = _p.get('token')     || '';
const DEVICE_ID  = _p.get('device_id') || '9B57D76B-908D-4504-915D-381D08676F44';
const PROXY_BASE = _p.get('proxy')     || 'http://localhost:8888';
const LAT = 56.34750920385357, LON = 43.934390690686854;
const CLIENT_SESSION = (()=>{
  // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º UUID –≤ —Ñ–æ—Ä–º–∞—Ç–µ –∏–∑ —Å–Ω–∏—Ñ–∞: 2F9807EE-059C-4121-8487-50D496A57B3E
  return ([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g,c=>
    (c^crypto.getRandomValues(new Uint8Array(1))[0]&15>>c/4).toString(16)).toUpperCase();
})();

// ‚îÄ‚îÄ‚îÄ –°–û–°–¢–û–Ø–ù–ò–ï ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let cart = {}, currentRest = null, currentScreen = 'catalog';
let modalItem = null, modalQty = 1, selectedOpt = null;
let selectedPayId = 'sbp_qr', selectedPayType = 'sbp';
let profile = null, launchData = null;
let RESTS = [];

// Checkout data from go-checkout API
let checkoutData = null;

const CATS = [
  {e:'üçî',n:'–ë—É—Ä–≥–µ—Ä—ã'},{e:'üç£',n:'–°—É—à–∏'},{e:'üçï',n:'–ü–∏—Ü—Ü–∞'},
  {e:'üçó',n:'–ö—É—Ä–∏—Ü–∞'},{e:'ü•ó',n:'–ó–¥–æ—Ä–æ–≤–æ–µ'},{e:'üçú',n:'–ê–∑–∏—è'},
  {e:'üåÆ',n:'–§–∞—Å—Ç—Ñ—É–¥'},{e:'üç¶',n:'–î–µ—Å–µ—Ä—Ç—ã'}
];

// ‚îÄ‚îÄ‚îÄ API –•–ï–õ–ü–ï–† ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function api(path, body, method) {
  method = method || (body !== null ? 'POST' : 'GET');
  try {
    const opts = {
      method,
      headers: {
        'Content-Type':     'application/json',
        'X-Bearer':         TOKEN,
        'X-Device-Id':      DEVICE_ID,
        'X-Client-Session': CLIENT_SESSION,
      }
    };
    if (body !== null && body !== undefined) opts.body = JSON.stringify(body);
    const r = await fetch(PROXY_BASE + '/proxy' + path, opts);
    if (!r.ok) { console.warn('[API]', path, r.status); return null; }
    return await r.json();
  } catch(e) { console.error('[API]', path, e); return null; }
}

// GET –∑–∞–ø—Ä–æ—Å (body = null)
function apiGet(path) { return api(path, null, 'GET'); }

// ‚îÄ‚îÄ‚îÄ –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
window.addEventListener('load', async () => {
  document.getElementById('catsList').innerHTML = CATS.map((c,i) =>
    `<button class="cat-btn ${i===0?'active':''}" onclick="filterByCat(this,'${c.n}')">
      <span class="cat-emoji">${c.e}</span><span class="cat-name">${c.n}</span>
    </button>`
  ).join('');

  if (TOKEN) {
    // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ –ø—Ä–æ—Ñ–∏–ª—å –∏ —Ä–µ—Å—Ç–æ—Ä–∞–Ω—ã
    Promise.all([loadLaunchData(), loadRestaurants()]);
  } else {
    document.getElementById('restaurantsList').innerHTML =
      '<div style="text-align:center;padding:60px 32px;color:var(--gray-text);font-size:15px;">–í–æ–π–¥–∏—Ç–µ —á–µ—Ä–µ–∑ –±–æ—Ç–∞ —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å —Ä–µ—Å—Ç–æ—Ä–∞–Ω—ã</div>';
    document.getElementById('addressText').textContent = '–£–∫–∞–∂–∏—Ç–µ –∞–¥—Ä–µ—Å';
  }

  setTimeout(() => {
    const lo = document.getElementById('loading');
    lo.style.opacity = '0';
    setTimeout(() => lo.style.display = 'none', 400);
  }, 900);
});

// ‚îÄ‚îÄ‚îÄ –ü–†–û–§–ò–õ–¨ / LAUNCH DATA ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function loadLaunchData() {
  // launch/v2/native ‚Äî —Å–æ–¥–µ—Ä–∂–∏—Ç –ø—Ä–æ—Ñ–∏–ª—å, –∫–æ–Ω—Ñ–∏–≥–∏, –∞–¥—Ä–µ—Å
  const d = await api('/eats/v1/launch/v2/native', {
    experiments: {
      consumer: 'eda_ab_service',
      args: [
        {name:'application', type:'string',             value:'eda_ios_app'},
        {name:'version',     type:'application_version',value:'8.94.0'},
        {name:'device_id',   type:'string',             value:DEVICE_ID},
        {name:'is_watch_paired',          type:'boolean',value:true},
        {name:'is_watch_app_installed',   type:'boolean',value:false},
      ],
    }
  });

  if (d && d.profile) {
    profile = d.profile;
    launchData = d;
    const name = profile.name || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';
    document.getElementById('profileName').textContent = name;
    document.getElementById('profileUid').textContent  = profile.passport_uid ? 'UID: ' + profile.passport_uid : '';

    // Plus —Å—Ç–∞—Ç—É—Å —á–µ—Ä–µ–∑ persey/info
    loadPlusStatus();
  } else {
    // Fallback: welcome-features
    const d2 = await api('/eats/v1/eats-launch/v1/welcome-features', {
      communications: {screen_resolution: {width: 402, height: 874}},
      location: {latitude: LAT, longitude: LON},
      shipping_type: 'delivery',
    });
    if (d2 && d2.selected_address) {
      const addr = d2.selected_address;
      document.getElementById('addressText').textContent =
        addr.short_text || addr.full_text || '–ú–æ–π –∞–¥—Ä–µ—Å';
    }
    document.getElementById('profileName').textContent = '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';
    document.getElementById('profileUid').textContent  = TOKEN ? TOKEN.slice(0,20)+'...' : '';
  }

  // –ê–¥—Ä–µ—Å –≤ —à–∞–ø–∫–µ
  if (launchData && launchData.user_address) {
    const a = launchData.user_address;
    document.getElementById('addressText').textContent = a.short_text || a.full_text || '–ú–æ–π –∞–¥—Ä–µ—Å';
  } else if (!document.getElementById('addressText').textContent || document.getElementById('addressText').textContent === '–ó–∞–≥—Ä—É–∑–∫–∞...') {
    document.getElementById('addressText').textContent = '–ú–æ–π –∞–¥—Ä–µ—Å';
  }
}

async function loadPlusStatus() {
  const d = await apiGet(`/eats/v1/persey/info?latitude=${LAT}&longitude=${LON}&currency=RUB`);
  if (d) {
    const status = d.subscription_status;
    const active = status === 'active' || status === 'trial';
    document.getElementById('profilePlusStatus').textContent = active ? '‚úì –ê–∫—Ç–∏–≤–µ–Ω' : '–ù–µ –∞–∫—Ç–∏–≤–µ–Ω';
    document.getElementById('profilePlusStatus').style.color = active ? '#029154' : '';
  }
}

// ‚îÄ‚îÄ‚îÄ –†–ï–°–¢–û–†–ê–ù–´ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function loadRestaurants() {
  document.getElementById('restaurantsList').innerHTML = '<div class="spinner"><div class="spin"></div></div>';

  const d = await api('/eats/v1/layout-constructor/v1/layout', {
    filters_v2:     {filters: []},
    sort:           'default',
    is_bottomsheet: false,
    selected_state: 'online',
    location:       {longitude: LON, latitude: LAT},
    region_id:      17,
  });

  if (d && d.data) {
    // –ò—â–µ–º —Å–ø–∏—Å–æ–∫ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–æ–≤ –≤ —Å—Ç—Ä—É–∫—Ç—É—Ä–µ layout
    const found = extractRestaurantsFromLayout(d.data);
    if (found && found.length) {
      RESTS = found;
      renderRests(RESTS);
      return;
    }
  }

  // Fallback: multi-carts endpoint
  const d2 = await api(
    `/eats/v1/cart/v2/multi-carts?screen=catalog&longitude=${LON}&latitude=${LAT}&soft_multi=true`,
    {need_items_icons: false}
  );

  if (d2 && d2.carts && d2.carts.length) {
    RESTS = d2.carts.map(c => ({
      slug:         c.place_slug || '',
      name:         c.place_name || '‚Äî',
      imageUrl:     c.place_image_url || '',
      bg:           'linear-gradient(135deg,#FFE033,#F5C800)',
      rating:       c.rating ? String(c.rating) : '',
      time:         c.delivery_time ? String(c.delivery_time) : '',
      freeDelivery: c.delivery_cost === 0,
      tags:         (c.categories || []).map(x => x.name || x),
    }));
    renderRests(RESTS);
    return;
  }

  document.getElementById('restaurantsList').innerHTML =
    '<div style="text-align:center;padding:40px;color:var(--gray-text);">–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ä–µ—Å—Ç–æ—Ä–∞–Ω—ã.<br>–ü—Ä–æ–≤–µ—Ä—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –ø—Ä–æ–∫—Å–∏.</div>';
}

function extractRestaurantsFromLayout(data) {
  // Layout constructor –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ª–æ–∂–Ω—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É ‚Äî –∏—â–µ–º places
  const results = [];
  function walk(obj) {
    if (!obj || typeof obj !== 'object') return;
    if (Array.isArray(obj)) { obj.forEach(walk); return; }
    // –ò—â–µ–º –æ–±—ä–µ–∫—Ç —Å –ø–æ–ª–µ–º slug –∏ name ‚Äî —ç—Ç–æ —Ä–µ—Å—Ç–æ—Ä–∞–Ω
    if (obj.slug && obj.name && (obj.deliveryTime !== undefined || obj.rating !== undefined || obj.pictureUrl !== undefined)) {
      results.push({
        slug:         obj.slug,
        name:         obj.name,
        imageUrl:     obj.pictureUrl || obj.headerImageUrl || '',
        bg:           'linear-gradient(135deg,#FFE033,#F5C800)',
        rating:       obj.rating ? String(obj.rating) : '',
        time:         obj.deliveryTime ? String(obj.deliveryTime) : '',
        freeDelivery: obj.deliveryCost === 0,
        tags:         (obj.tags || obj.categories || []).map(t => t.name || t).filter(Boolean),
      });
      return;
    }
    // –¢–∞–∫–∂–µ –∏—â–µ–º foundPlaces
    if (obj.foundPlaces && Array.isArray(obj.foundPlaces)) {
      obj.foundPlaces.forEach(p => {
        const pl = p.place || p;
        results.push({
          slug:         pl.slug || '',
          name:         pl.name || '‚Äî',
          imageUrl:     pl.pictureUrl || pl.headerImageUrl || '',
          bg:           'linear-gradient(135deg,#FFE033,#F5C800)',
          rating:       pl.rating ? String(pl.rating) : '',
          time:         pl.deliveryTime ? String(pl.deliveryTime) : '',
          freeDelivery: pl.deliveryCost === 0,
          tags:         (pl.tags || pl.categories || []).map(t => t.name || t).filter(Boolean),
        });
      });
    }
    Object.values(obj).forEach(walk);
  }
  walk(data);
  // –î–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è –ø–æ slug
  const seen = new Set();
  return results.filter(r => r.slug && !seen.has(r.slug) && seen.add(r.slug));
}

// ‚îÄ‚îÄ‚îÄ –§–ò–õ–¨–¢–†–´ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function filterByCat(btn, cat) {
  document.querySelectorAll('.cat-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  const q = cat.toLowerCase();
  const f = RESTS.filter(r => r.tags.some(t => t.toLowerCase().includes(q)));
  renderRests(f.length ? f : RESTS);
}

function filterRestaurants(q) {
  if (!q) { renderRests(RESTS); return; }
  q = q.toLowerCase();
  renderRests(RESTS.filter(r =>
    r.name.toLowerCase().includes(q) ||
    r.tags.some(t => t.toLowerCase().includes(q))
  ));
}

// ‚îÄ‚îÄ‚îÄ –†–ï–ù–î–ï–† –†–ï–°–¢–û–†–ê–ù–û–í ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderRests(list) {
  const el = document.getElementById('restaurantsList');
  if (!list.length) {
    el.innerHTML = '<div style="text-align:center;padding:40px;color:var(--gray-text);">–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ üîç</div>';
    return;
  }
  el.innerHTML = list.map(r => `
    <div class="rest-card" onclick="openRest('${r.slug}')">
      <div class="rest-img-placeholder" style="background:${r.bg};">
        ${r.imageUrl
          ? `<img src="${r.imageUrl}" style="width:100%;height:100%;object-fit:cover;" onerror="this.style.display='none'">`
          : '<span style="font-size:60px">üçΩÔ∏è</span>'}
        ${r.freeDelivery ? '<div class="rest-badge free">–ë–µ—Å–ø–ª–∞—Ç–Ω–æ</div>' : ''}
      </div>
      <div class="rest-info">
        <div class="rest-name">${r.name}</div>
        <div class="rest-meta">
          ${r.rating ? `<span class="rest-rating">‚òÖ ${r.rating}</span>` : ''}
          ${r.time   ? `<span class="rest-time">‚è± ${r.time} –º–∏–Ω</span>` : ''}
          ${r.freeDelivery ? '<span class="rest-delivery">–ë–µ—Å–ø–ª–∞—Ç–Ω–∞—è –¥–æ—Å—Ç–∞–≤–∫–∞</span>' : ''}
        </div>
        <div class="rest-tags">${r.tags.slice(0,3).map(t=>`<span class="rest-tag">${t}</span>`).join('')}</div>
      </div>
    </div>
  `).join('');
}

// ‚îÄ‚îÄ‚îÄ –ú–ï–ù–Æ –†–ï–°–¢–û–†–ê–ù–ê ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function openRest(slug) {
  currentRest = RESTS.find(r => r.slug === slug);
  if (!currentRest) return;
  goTo('menu');

  document.getElementById('menuRestName').textContent = currentRest.name;
  document.getElementById('menuHeroImg').innerHTML = currentRest.imageUrl
    ? `<img src="${currentRest.imageUrl}" style="width:100%;height:100%;object-fit:cover;">`
    : '<span style="font-size:70px">üçΩÔ∏è</span>';
  document.getElementById('menuRestMeta').innerHTML = `
    ${currentRest.freeDelivery ? '<span class="menu-rest-badge delivery">–ë–µ—Å–ø–ª–∞—Ç–Ω–∞—è –¥–æ—Å—Ç–∞–≤–∫–∞</span>' : ''}
    ${currentRest.time   ? `<span class="menu-rest-badge time">‚è± ${currentRest.time} –º–∏–Ω</span>` : ''}
    ${currentRest.rating ? `<span class="menu-rest-badge time">‚òÖ ${currentRest.rating}</span>` : ''}
  `;
  document.getElementById('menuCatTabs').innerHTML = '';
  document.getElementById('menuItemsContainer').innerHTML = '<div class="spinner"><div class="spin"></div></div>';

  // GET /api/v2/menu/retrieve/{slug} ‚Äî —Ç–æ—á–Ω–æ –∏–∑ —Å–Ω–∏—Ñ–∞
  const d = await apiGet(
    `/api/v2/menu/retrieve/${slug}?shippingType=delivery&longitude=${LON}&latitude=${LAT}&is_ad=false`
  );

  if (!d || !d.payload || !d.payload.categories) {
    document.getElementById('menuItemsContainer').innerHTML =
      '<div style="text-align:center;padding:40px;color:var(--gray-text);">–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –º–µ–Ω—é</div>';
    return;
  }

  currentRest.cats = d.payload.categories
    .filter(cat => cat.available !== false)
    .map(cat => ({
      n:     cat.name,
      items: (cat.items || []).map(item => ({
        id:  item.id,
        n:   item.name,
        d:   item.description || '',
        p:   item.price ? Math.round(item.price) : 0,
        w:   item.weight_in_grams ? item.weight_in_grams + ' –≥' : '',
        e:   'üçΩÔ∏è',
        img: item.picture_url || item.pictureUrl || '',
        opts: (item.options || []).map(og => ({
          g: og.name,
          i: (og.items || og.options || []).map(o => ({
            id: o.id, n: o.name,
            p:  o.price ? Math.round(o.price) : 0
          }))
        })).filter(og => og.i.length > 0),
      }))
    })).filter(cat => cat.items.length > 0);

  document.getElementById('menuCatTabs').innerHTML = currentRest.cats.map((c,i) =>
    `<button class="menu-cat-tab ${i===0?'active':''}" onclick="scrollCat(${i},this)">${c.n}</button>`
  ).join('');

  renderMenuItems();
}

function renderMenuItems() {
  document.getElementById('menuItemsContainer').innerHTML =
    currentRest.cats.map((cat, ci) => `
      <div class="menu-section" id="ms${ci}">
        <div class="menu-section-title">${cat.n}</div>
        <div class="menu-items">${cat.items.map(item => renderMenuItem(item)).join('')}</div>
      </div>
    `).join('') + '<div style="height:80px;"></div>';
}

function renderMenuItem(item) {
  const q = getQty(item.id);
  const safeItem = JSON.stringify(item).replace(/'/g,"&#39;").replace(/"/g,'&quot;');
  return `
    <div class="menu-item" onclick='openModal(${JSON.stringify(item).replace(/'/g,"&#39;")})'>
      <div class="menu-item-img">
        ${item.img
          ? `<img src="${item.img}" style="width:100%;height:100%;object-fit:cover;border-radius:12px;" onerror="this.parentElement.innerHTML='üçΩÔ∏è'">`
          : item.e}
      </div>
      <div class="menu-item-body">
        <div class="menu-item-name">${item.n}</div>
        ${item.d ? `<div class="menu-item-desc">${item.d}</div>` : ''}
        ${item.w ? `<div class="menu-item-weight">${item.w}</div>` : ''}
        <div class="menu-item-footer">
          <div class="menu-item-price">${item.p} ‚ÇΩ</div>
          ${q > 0
            ? `<div class="qty-ctrl">
                <button class="qty-btn" onclick="event.stopPropagation();adjQty(${item.id},-1)">‚àí</button>
                <span class="qty-num">${q}</span>
                <button class="qty-btn" onclick="event.stopPropagation();adjQty(${item.id},1)">+</button>
               </div>`
            : `<button class="add-btn" onclick='event.stopPropagation();quickAdd(${JSON.stringify(item).replace(/'/g,"&#39;")})'>+</button>`}
        </div>
      </div>
    </div>`;
}

function scrollCat(i, btn) {
  document.querySelectorAll('.menu-cat-tab').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  document.getElementById('ms'+i)?.scrollIntoView({behavior:'smooth', block:'start'});
}

// ‚îÄ‚îÄ‚îÄ –ú–û–î–ê–õ–ö–ê –¢–û–í–ê–†–ê ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function openModal(item) {
  if (typeof item === 'string') item = JSON.parse(item);
  modalItem = item; modalQty = 1; selectedOpt = null;
  document.getElementById('modalImg').innerHTML =
    (item.img
      ? `<img src="${item.img}" style="width:100%;height:100%;object-fit:cover;">`
      : `<span style="font-size:80px">${item.e}</span>`) +
    `<button class="modal-close" onclick="closeModal()">‚úï</button>`;
  document.getElementById('modalName').textContent   = item.n;
  document.getElementById('modalDesc').textContent   = item.d || '';
  document.getElementById('modalWeight').textContent = item.w || '';
  document.getElementById('modalQty').textContent    = '1';
  const ow = document.getElementById('modalOptsWrap');
  if (item.opts && item.opts.length) {
    const g = item.opts[0];
    document.getElementById('modalOptsTitle').textContent = g.g;
    document.getElementById('modalOpts').innerHTML = g.i.map((o,idx) =>
      `<div class="modal-opt ${idx===0?'selected':''}" onclick='pickOpt(this,${JSON.stringify(o)})'>
        <span class="modal-opt-name">${o.n}</span>
        <span class="modal-opt-price">${o.p>0?'+'+o.p+' ‚ÇΩ':'–±–µ—Å–ø–ª–∞—Ç–Ω–æ'}</span>
       </div>`
    ).join('');
    selectedOpt = g.i[0];
    ow.style.display = 'block';
  } else { ow.style.display = 'none'; }
  updateModalPrice();
  document.getElementById('itemModal').classList.add('open');
}

function pickOpt(el, opt) {
  if (typeof opt === 'string') opt = JSON.parse(opt);
  document.querySelectorAll('.modal-opt').forEach(e => e.classList.remove('selected'));
  el.classList.add('selected');
  selectedOpt = opt;
  updateModalPrice();
}

function updateModalPrice() {
  if (!modalItem) return;
  const p = modalItem.p + (selectedOpt && selectedOpt.p > 0 ? selectedOpt.p : 0);
  document.getElementById('modalAddPrice').textContent = (p * modalQty) + ' ‚ÇΩ';
}

function changeModalQty(d) {
  modalQty = Math.max(1, modalQty + d);
  document.getElementById('modalQty').textContent = modalQty;
  updateModalPrice();
}

function addFromModal() {
  if (!modalItem || !currentRest) return;
  const on = selectedOpt ? selectedOpt.n : '';
  const op = selectedOpt ? (selectedOpt.p || 0) : 0;
  for (let i = 0; i < modalQty; i++) addToCart(modalItem, on, op);
  closeModal();
  showToast(modalItem.n + ' –¥–æ–±–∞–≤–ª–µ–Ω –≤ –∫–æ—Ä–∑–∏–Ω—É ‚úì');
}

function closeModal() {
  document.getElementById('itemModal').classList.remove('open');
  modalItem = null;
}
document.getElementById('itemModal').addEventListener('click', e => {
  if (e.target === document.getElementById('itemModal')) closeModal();
});

function quickAdd(item) {
  if (typeof item === 'string') item = JSON.parse(item);
  if (item.opts && item.opts.length) { openModal(item); return; }
  addToCart(item, '', 0);
  showToast(item.n + ' –¥–æ–±–∞–≤–ª–µ–Ω ‚úì');
  renderMenuItems();
}

// ‚îÄ‚îÄ‚îÄ –ö–û–†–ó–ò–ù–ê ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function addToCart(item, optName, optPrice) {
  if (!cart.items) cart = { slug: currentRest.slug, restName: currentRest.name, items: [] };
  if (cart.slug !== currentRest.slug) {
    if (!confirm(`–û—á–∏—Å—Ç–∏—Ç—å –∫–æ—Ä–∑–∏–Ω—É –æ—Ç "${cart.restName}"?`)) return;
    cart = { slug: currentRest.slug, restName: currentRest.name, items: [] };
  }
  const key = item.id + '_' + optName;
  const ex  = cart.items.find(i => i.key === key);
  if (ex) ex.qty++;
  else cart.items.push({
    key, iid: item.id, n: item.n,
    p: item.p + optPrice,
    e: item.e, img: item.img || '',
    on: optName, qty: 1
  });
  updateBadge();
}

function adjQty(iid, d) {
  if (!cart.items) return;
  const idx = cart.items.findIndex(i => i.iid === iid);
  if (idx < 0) return;
  cart.items[idx].qty += d;
  if (cart.items[idx].qty <= 0) cart.items.splice(idx, 1);
  if (!cart.items.length) cart = {};
  updateBadge();
  if (currentScreen === 'menu' && currentRest && currentRest.cats) renderMenuItems();
  if (currentScreen === 'cart') renderCartScreen();
}

function getQty(iid)   { return cart.items ? cart.items.filter(i=>i.iid===iid).reduce((s,i)=>s+i.qty,0) : 0; }
function getTotal()    { return cart.items ? cart.items.reduce((s,i)=>s+i.p*i.qty,0) : 0; }
function getCount()    { return cart.items ? cart.items.reduce((s,i)=>s+i.qty,0) : 0; }
function updateBadge() { const c=getCount(); document.getElementById('cartBadge').textContent=c>0?c:''; }
function clearCart()   { cart={}; updateBadge(); }

function renderCartScreen() {
  if (!cart.items || !cart.items.length) {
    document.getElementById('cartEmpty').style.display  = 'flex';
    document.getElementById('cartFilled').style.display = 'none';
    return;
  }
  document.getElementById('cartEmpty').style.display  = 'none';
  document.getElementById('cartFilled').style.display = 'block';
  document.getElementById('cartRestName').textContent  = 'üì¶ ' + (cart.restName || '');
  document.getElementById('cartItemsList').innerHTML   = cart.items.map(ci => `
    <div class="cart-item">
      <div class="cart-item-emoji">
        ${ci.img
          ? `<img src="${ci.img}" onerror="this.parentElement.innerHTML='üçΩÔ∏è'">`
          : ci.e}
      </div>
      <div class="cart-item-body">
        <div class="cart-item-name">${ci.n}</div>
        ${ci.on ? `<div class="cart-item-opt">${ci.on}</div>` : ''}
      </div>
      <div style="display:flex;flex-direction:column;align-items:flex-end;gap:6px;">
        <div style="font-size:14px;font-weight:800;">${ci.p*ci.qty} ‚ÇΩ</div>
        <div style="display:flex;align-items:center;gap:6px;">
          <button class="cart-qty-btn" onclick="adjQty(${ci.iid},-1)">‚àí</button>
          <span class="cart-qty-num">${ci.qty}</span>
          <button class="cart-qty-btn" onclick="adjQty(${ci.iid},1)">+</button>
        </div>
      </div>
    </div>`).join('');
  const sub=getTotal(), fee=Math.round(sub*0.05), total=sub+fee;
  document.getElementById('summaryItems').textContent      = sub   + ' ‚ÇΩ';
  document.getElementById('summaryFee').textContent        = fee   + ' ‚ÇΩ';
  document.getElementById('summaryTotal').textContent      = total + ' ‚ÇΩ';
  document.getElementById('checkoutBtnTotal').textContent  = total + ' ‚ÇΩ';
}

// ‚îÄ‚îÄ‚îÄ –ü–†–û–ú–û–ö–û–î ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function applyPromo() {
  const code = document.getElementById('promoInput').value.trim().toUpperCase();
  if (!code) return;
  if (!TOKEN) { showToast('‚ùå –ù—É–∂–Ω–æ –≤–æ–π—Ç–∏ —á–µ—Ä–µ–∑ –±–æ—Ç–∞'); return; }
  showToast('‚è≥ –ü—Ä–æ–≤–µ—Ä—è—é –ø—Ä–æ–º–æ–∫–æ–¥...');
  // POST /api/v2/cart/promocode ‚Äî –∏–∑ —Å–Ω–∏—Ñ–∞
  const d = await api(
    `/api/v2/cart/promocode?soft_multi=true&shippingType=delivery&placeSlug=${cart.slug || ''}`,
    { code, place_slug: cart.slug || '', location: {latitude: LAT, longitude: LON} }
  );
  if (d && (d.discount || d.applied || d.promocode)) {
    showToast('‚úÖ –ü—Ä–æ–º–æ–∫–æ–¥ –ø—Ä–∏–º–µ–Ω—ë–Ω!');
  } else {
    // –ü—Ä–æ–±—É–µ–º —Å—Ç–∞—Ä—ã–π endpoint
    const d2 = await api('/api/v1/promotions/apply_code', {
      code, place_slug: cart.slug || '',
      location: {latitude: LAT, longitude: LON},
    });
    if (d2 && (d2.discount || d2.applied)) {
      const disc = d2.discount || {};
      showToast('‚úÖ –ü—Ä–æ–º–æ–∫–æ–¥: ' + (disc.amount ? `-${disc.amount} ‚ÇΩ` : disc.percent ? `-${disc.percent}%` : '–ø—Ä–∏–º–µ–Ω—ë–Ω'));
    } else {
      showToast('‚ùå ' + (d2 && d2.message ? d2.message : '–ü—Ä–æ–º–æ–∫–æ–¥ –Ω–µ –Ω–∞–π–¥–µ–Ω'));
    }
  }
}

// ‚îÄ‚îÄ‚îÄ –û–§–û–†–ú–õ–ï–ù–ò–ï ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function renderCheckoutScreen() {
  const sub=getTotal(), fee=Math.round(sub*0.05), total=sub+fee;
  document.getElementById('checkoutTotal').textContent      = total + ' ‚ÇΩ';
  document.getElementById('placeOrderTotal').textContent    = total + ' ‚ÇΩ';
  document.getElementById('checkoutItems').innerHTML        = (cart.items||[]).map(ci =>
    `<div class="summary-row">
       <span class="summary-label">${ci.n}${ci.on?' ('+ci.on+')':''} √ó ${ci.qty}</span>
       <span class="summary-value">${ci.p*ci.qty} ‚ÇΩ</span>
     </div>`
  ).join('');

  // –ü–æ–ª—É—á–∞–µ–º —Ä–µ–∞–ª—å–Ω—ã–π –∞–¥—Ä–µ—Å –∏–∑ go-checkout API
  if (cart.slug && TOKEN) {
    document.getElementById('checkoutAddr').textContent = '‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞...';
    const gcd = await api('/api/v2/cart/go-checkout', {
      place_slug: cart.slug,
      plus_subscription_toggle_state: null,
      address: {
        location: {longitude: LON, latitude: LAT},
        house:      '8',
        short_text: '–í–æ–ª–∂—Å–∫–∞—è –Ω–∞–±–µ—Ä–µ–∂–Ω–∞—è, 8',
        type:       {id: 0},
        city:       '–ù–∏–∂–Ω–∏–π –ù–æ–≤–≥–æ—Ä–æ–¥',
        street:     '–í–æ–ª–∂—Å–∫–∞—è –Ω–∞–±–µ—Ä–µ–∂–Ω–∞—è',
        country:    '–†–æ—Å—Å–∏—è',
      }
    });
    if (gcd) {
      checkoutData = gcd;
      const addr = gcd.address;
      if (addr) {
        document.getElementById('checkoutAddr').textContent =
          addr.short_text || addr.full_text || '–í–æ–ª–∂—Å–∫–∞—è –Ω–∞–±–µ—Ä–µ–∂–Ω–∞—è, 8';
      }
      // –ì—Ä—É–∑–∏–º –º–µ—Ç–æ–¥—ã –æ–ø–ª–∞—Ç—ã –∏–∑ go-checkout
      if (gcd.payment_methods && gcd.payment_methods.length) {
        renderPayMethods(gcd.payment_methods);
      }
      // –í—Ä–µ–º—è –¥–æ—Å—Ç–∞–≤–∫–∏
      if (gcd.delivery_time) {
        document.getElementById('checkoutTime').textContent = '~' + gcd.delivery_time + ' –º–∏–Ω';
      }
    } else {
      document.getElementById('checkoutAddr').textContent = '–í–æ–ª–∂—Å–∫–∞—è –Ω–∞–±–µ—Ä–µ–∂–Ω–∞—è, 8';
    }
  } else {
    document.getElementById('checkoutAddr').textContent = '–í–æ–ª–∂—Å–∫–∞—è –Ω–∞–±–µ—Ä–µ–∂–Ω–∞—è, 8';
  }
}

function renderPayMethods(methods) {
  const icons = {sbp:'‚ö°', card:'üí≥', cash:'üíµ', wallet:'üëõ', bonus:'‚≠ê'};
  const names = {sbp:'–°–ë–ü', card:'–ö–∞—Ä—Ç–∞', cash:'–ù–∞–ª–∏—á–Ω—ã–µ', wallet:'–ö–æ—à–µ–ª—ë–∫', bonus:'–ë–æ–Ω—É—Å—ã'};
  const el = document.getElementById('payMethodList');
  // –°—Ç—Ä–æ–∏–º –∏–∑ —Ä–µ–∞–ª—å–Ω—ã—Ö –º–µ—Ç–æ–¥–æ–≤
  let first = true;
  el.innerHTML = methods.slice(0,4).map(m => {
    const type = m.type || m.payment_method_type || 'card';
    const id   = m.payment_method_id || m.id || type;
    const name = m.name || names[type] || type;
    const icon = icons[type] || 'üí≥';
    const sel  = first ? 'selected' : '';
    if (first) { selectedPayId = id; selectedPayType = type; first = false; }
    return `<div class="pay-option ${sel}" onclick="selectPay(this,'${id}','${type}')">
      <div class="pay-option-icon">${icon}</div>
      <div class="pay-option-name">${name}</div>
    </div>`;
  }).join('');
}

function selectPay(el, id, type) {
  document.querySelectorAll('.pay-option').forEach(o => o.classList.remove('selected'));
  el.classList.add('selected');
  selectedPayId  = id;
  selectedPayType = type;
}

async function placeOrder() {
  const btn = document.getElementById('placeOrderBtn');
  btn.disabled = true;
  btn.textContent = '‚è≥ –û—Ñ–æ—Ä–º–ª—è—é –∑–∞–∫–∞–∑...';

  let nr = null;
  if (TOKEN && cart.slug) {
    const reqId   = crypto.randomUUID().replace(/-/g,'') + '.' + (checkoutData?.offers?.[0]?.offer_identity || crypto.randomUUID().replace(/-/g,''));
    const comment = document.getElementById('checkoutComment').value;

    const d = await api('/api/v1/orders', {
      courier_options:  [],
      persons_quantity: 1,
      request_id:       reqId,
      location:         {latitude: LAT, longitude: LON},
      comment,
      payment:          {recently_link_cards: false},
      payment_method_id: selectedPayType === 'sbp' ? 5 : selectedPayType === 'cash' ? 1 : 2,
      place_slug:       cart.slug,
      phone:            '+70000000000',
      extended_options: [{type: 'delivery_options'}],
      address: {
        house:      '8',
        short_text: '–í–æ–ª–∂—Å–∫–∞—è –Ω–∞–±–µ—Ä–µ–∂–Ω–∞—è, 8',
        full_text:  '–ù–∏–∂–Ω–∏–π –ù–æ–≤–≥–æ—Ä–æ–¥, –í–æ–ª–∂—Å–∫–∞—è –Ω–∞–±–µ—Ä–µ–∂–Ω–∞—è, 8',
        country:    '–†–æ—Å—Å–∏—è',
        city:       '–ù–∏–∂–Ω–∏–π –ù–æ–≤–≥–æ—Ä–æ–¥',
        street:     '–í–æ–ª–∂—Å–∫–∞—è –Ω–∞–±–µ—Ä–µ–∂–Ω–∞—è',
        location:   {latitude: LAT, longitude: LON},
        type:       {id: 0},
        areas:      ['–≥–æ—Ä–æ–¥—Å–∫–æ–π –æ–∫—Ä—É–≥ –ù–∏–∂–Ω–∏–π –ù–æ–≤–≥–æ—Ä–æ–¥'],
      },
      payment_information: {
        type: selectedPayType,
        id:   selectedPayId,
        costForCustomer: String(getTotal()),
      }
    });
    if (d && d.order_nr) nr = d.order_nr;
  }

  if (!nr) {
    const d = new Date();
    nr = `${String(d.getDate()).padStart(2,'0')}${String(d.getMonth()+1).padStart(2,'0')}${String(d.getFullYear()).slice(-2)}-${Math.floor(1000000+Math.random()*9000000)}`;
  }

  clearCart();
  showOrderStatus(nr);
  btn.disabled = false;
}

function showOrderStatus(nr) {
  document.getElementById('orderNr').textContent = nr;
  const fmt = d => d.getHours()+':'+String(d.getMinutes()).padStart(2,'0');
  document.getElementById('step1time').textContent = fmt(new Date());
  goTo('order');

  // –≠–º—É–ª–∏—Ä—É–µ–º —Ç—Ä–µ–∫–∏–Ω–≥ (—Ä–µ–∞–ª—å–Ω—ã–π —á–µ—Ä–µ–∑ POST /eats/v1/eats-payments/v1/order/tracking)
  setTimeout(() => {
    document.getElementById('step2dot').textContent = '‚úì';
    document.getElementById('step2dot').className   = 'track-dot done';
    document.getElementById('step3dot').className   = 'track-dot active';
    document.getElementById('step3time').textContent = '~10 –º–∏–Ω';
  }, 8000);
  setTimeout(() => {
    document.getElementById('step3dot').textContent = '‚úì';
    document.getElementById('step3dot').className   = 'track-dot done';
    document.getElementById('step4dot').className   = 'track-dot active';
    document.getElementById('step4time').textContent = fmt(new Date(Date.now()+5*60000));
  }, 18000);
}

// ‚îÄ‚îÄ‚îÄ –ü–†–û–§–ò–õ–¨ –≠–ö–†–ê–ù–´ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

// –ú–æ–∏ –∑–∞–∫–∞–∑—ã ‚Äî –∏—Å—Ç–æ—Ä–∏—è —á–µ—Ä–µ–∑ API
async function loadOrders() {
  const el = document.getElementById('ordersListContainer');
  el.innerHTML = '<div class="spinner"><div class="spin"></div></div>';

  // GET /api/v1/user/orders –∏–ª–∏ —á–µ—Ä–µ–∑ eats-orders
  // –í —Å–Ω–∏—Ñ–µ –Ω–µ—Ç –∏—Å—Ç–æ—Ä–∏–∏ ‚Äî –Ω–æ endpoint —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π
  const d = await apiGet('/api/v1/user/orders?page=1&limit=20');
  if (d && d.orders && d.orders.length) {
    el.innerHTML = '<div class="orders-list">' + d.orders.map(o => {
      const date = new Date(o.created_at || o.date).toLocaleDateString('ru', {day:'numeric',month:'long'});
      const statusMap = {delivered:'done', cancelled:'cancelled', pending:'pending', cooking:'pending'};
      const statusLabel = {delivered:'–î–æ—Å—Ç–∞–≤–ª–µ–Ω', cancelled:'–û—Ç–º–µ–Ω—ë–Ω', pending:'–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è', cooking:'–ì–æ—Ç–æ–≤–∏—Ç—Å—è'};
      const st = o.status || 'delivered';
      const items = (o.items || []).slice(0,2).map(i => i.name || i.n).join(', ');
      return `<div class="order-card">
        <div class="order-card-header">
          <span class="order-card-nr">–ó–∞–∫–∞–∑ ${o.order_nr || o.id}</span>
          <span class="order-card-date">${date}</span>
        </div>
        <div class="order-card-rest">${o.place_name || o.restaurant_name || ''}</div>
        ${items ? `<div class="order-card-items">${items}${(o.items||[]).length>2?' –∏ –µ—â—ë...':''}</div>` : ''}
        <div class="order-card-footer">
          <span class="order-card-total">${o.total || o.cost || 0} ‚ÇΩ</span>
          <span class="order-status-badge ${statusMap[st]||'done'}">${statusLabel[st]||'–î–æ—Å—Ç–∞–≤–ª–µ–Ω'}</span>
        </div>
      </div>`;
    }).join('') + '</div>';
  } else {
    el.innerHTML = `<div class="empty-state">
      <div class="empty-state-icon">üì¶</div>
      <div class="empty-state-text">–ó–∞–∫–∞–∑–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç</div>
      <div class="empty-state-sub">–°–¥–µ–ª–∞–π—Ç–µ –ø–µ—Ä–≤—ã–π –∑–∞–∫–∞–∑ –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å!</div>
    </div>`;
  }
}

// –ê–¥—Ä–µ—Å–∞
async function loadAddresses() {
  const el = document.getElementById('addressesContainer');
  el.innerHTML = '<div class="spinner"><div class="spin"></div></div>';

  const d = await apiGet('/eats/v1/eats-addresses/v1/addresses');
  if (d && d.addresses && d.addresses.length) {
    el.innerHTML = d.addresses.map(a => {
      const icons = {home:'üè†', work:'üè¢', other:'üìç'};
      const icon = icons[a.type] || 'üìç';
      return `<div class="address-card">
        <div class="address-card-icon">${icon}</div>
        <div class="address-card-body">
          <div class="address-card-name">${a.title || a.short_text || '–ê–¥—Ä–µ—Å'}</div>
          <div class="address-card-full">${a.full_text || a.short_text || ''}</div>
        </div>
      </div>`;
    }).join('');
  } else {
    // –ï—Å–ª–∏ –Ω–µ—Ç ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∞–¥—Ä–µ—Å –∏–∑ launch/checkout
    const addr = checkoutData?.address;
    if (addr) {
      el.innerHTML = `<div class="address-card">
        <div class="address-card-icon">üìç</div>
        <div class="address-card-body">
          <div class="address-card-name">–ú–æ–π –∞–¥—Ä–µ—Å</div>
          <div class="address-card-full">${addr.full_text || addr.short_text || ''}</div>
        </div>
      </div>`;
    } else {
      el.innerHTML = `<div class="empty-state">
        <div class="empty-state-icon">üìç</div>
        <div class="empty-state-text">–ê–¥—Ä–µ—Å–∞ –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω—ã</div>
        <div class="empty-state-sub">–î–æ–±–∞–≤—å—Ç–µ –∞–¥—Ä–µ—Å –ø—Ä–∏ —Å–ª–µ–¥—É—é—â–µ–º –∑–∞–∫–∞–∑–µ</div>
      </div>`;
    }
  }
}

// –ú–µ—Ç–æ–¥—ã –æ–ø–ª–∞—Ç—ã
async function loadPayments() {
  const el = document.getElementById('paymentsContainer');
  el.innerHTML = '<div class="spinner"><div class="spin"></div></div>';

  // –ü–æ–ª—É—á–∞–µ–º –∏–∑ go-checkout (–µ—Å–ª–∏ –±—ã–ª) –∏–ª–∏ —á–µ—Ä–µ–∑ –æ—Ç–¥–µ–ª—å–Ω—ã–π –∑–∞–ø—Ä–æ—Å
  const d = await api('/api/v2/cart/go-checkout', {
    place_slug: cart.slug || (RESTS[0] && RESTS[0].slug) || '',
    plus_subscription_toggle_state: null,
    address: {
      location: {longitude: LON, latitude: LAT},
      house: '8', short_text: '–í–æ–ª–∂—Å–∫–∞—è –Ω–∞–±–µ—Ä–µ–∂–Ω–∞—è, 8',
      type: {id: 0}, city: '–ù–∏–∂–Ω–∏–π –ù–æ–≤–≥–æ—Ä–æ–¥',
      street: '–í–æ–ª–∂—Å–∫–∞—è –Ω–∞–±–µ—Ä–µ–∂–Ω–∞—è', country: '–†–æ—Å—Å–∏—è',
    }
  });

  const icons  = {sbp:'‚ö°', card:'üí≥', cash:'üíµ', wallet:'üëõ', bonus:'‚≠ê', yandex_pay:'üíõ'};
  const colors = {sbp:'#E8F8EE', card:'#EEF2FF', cash:'#FFF5D0', wallet:'#FEF9EE'};

  if (d && d.payment_methods && d.payment_methods.length) {
    el.innerHTML = d.payment_methods.map(m => {
      const type = m.type || m.payment_method_type || 'card';
      const icon = icons[type] || 'üí≥';
      const name = m.name || type;
      const sub  = m.account || m.description || '';
      return `<div class="payment-card">
        <div class="payment-card-icon" style="background:${colors[type]||'#F5F5F5'}">${icon}</div>
        <div class="payment-card-body">
          <div class="payment-card-name">${name}</div>
          ${sub ? `<div class="payment-card-sub">${sub}</div>` : ''}
        </div>
      </div>`;
    }).join('');
    document.getElementById('profilePaySub').textContent = d.payment_methods.length + ' —Å–ø–æ—Å–æ–±–æ–≤';
  } else {
    el.innerHTML = `<div class="payment-card">
      <div class="payment-card-icon">‚ö°</div>
      <div class="payment-card-body">
        <div class="payment-card-name">–°–ë–ü (–°–∏—Å—Ç–µ–º–∞ –±—ã—Å—Ç—Ä—ã—Ö –ø–ª–∞—Ç–µ–∂–µ–π)</div>
      </div>
    </div>
    <div class="payment-card">
      <div class="payment-card-icon">üí≥</div>
      <div class="payment-card-body">
        <div class="payment-card-name">–ë–∞–Ω–∫–æ–≤—Å–∫–∞—è –∫–∞—Ä—Ç–∞</div>
      </div>
    </div>
    <div class="payment-card">
      <div class="payment-card-icon">üíµ</div>
      <div class="payment-card-body">
        <div class="payment-card-name">–ù–∞–ª–∏—á–Ω—ã–µ –∫—É—Ä—å–µ—Ä—É</div>
      </div>
    </div>`;
  }
}

// –ü—Ä–æ–º–æ–∫–æ–¥—ã
async function loadPromos() {
  const el = document.getElementById('promosContainer');
  el.innerHTML = '<div class="spinner"><div class="spin"></div></div>';

  // POST /api/v1/user/promocodes ‚Äî –∏–∑ —Å–Ω–∏—Ñ–∞
  const d = await api('/api/v1/user/promocodes', {
    payment: {payment_method_id: selectedPayId || 'sbp_qr', type: selectedPayType || 'sbp'}
  });

  if (d && d.promocodes && d.promocodes.length) {
    el.innerHTML = '<div style="padding:4px 0;">' + d.promocodes.map(p => `
      <div class="promo-card">
        <div class="promo-card-code">${p.code || ''}</div>
        <div class="promo-card-desc">${p.description || p.title || ''}</div>
        ${p.discount ? `<span class="promo-card-badge">‚àí${p.discount}</span>` : ''}
      </div>`).join('') + '</div>';
    document.getElementById('profilePromoSub').textContent = d.promocodes.length + ' –ø—Ä–æ–º–æ–∫–æ–¥–∞(–æ–≤)';
  } else {
    el.innerHTML = `<div class="empty-state">
      <div class="empty-state-icon">üè∑Ô∏è</div>
      <div class="empty-state-text">–ü—Ä–æ–º–æ–∫–æ–¥–æ–≤ –Ω–µ—Ç</div>
      <div class="empty-state-sub">–ê–∫—Ç–∏–≤–∏—Ä—É–π—Ç–µ –ø—Ä–æ–º–æ–∫–æ–¥ –ø—Ä–∏ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–∏ –∑–∞–∫–∞–∑–∞</div>
    </div>`;
  }
}

// –ü–æ–¥–¥–µ—Ä–∂–∫–∞
function sendSupport() {
  const inp = document.getElementById('supportInput');
  const text = inp.value.trim();
  if (!text) return;
  const chat = document.getElementById('supportChat');
  chat.innerHTML += `<div class="support-msg user">${text}</div>`;
  inp.value = '';
  chat.scrollTop = chat.scrollHeight;
  // –ê–≤—Ç–æ–æ—Ç–≤–µ—Ç —á–µ—Ä–µ–∑ 1.5—Å
  setTimeout(() => {
    const responses = [
      '–°–ø–∞—Å–∏–±–æ –∑–∞ –æ–±—Ä–∞—â–µ–Ω–∏–µ! –í–∞—à –≤–æ–ø—Ä–æ—Å –ø–µ—Ä–µ–¥–∞–Ω –æ–ø–µ—Ä–∞—Ç–æ—Ä—É.',
      '–ü–æ–Ω—è–ª –≤–∞—Å. –û–±—ã—á–Ω–æ –º—ã –æ—Ç–≤–µ—á–∞–µ–º –≤ —Ç–µ—á–µ–Ω–∏–µ 5 –º–∏–Ω—É—Ç.',
      '–í–∞—à –∑–∞–ø—Ä–æ—Å –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω. –ú–æ–∂–µ—Ç–µ —Ç–∞–∫–∂–µ –ø–æ–∑–≤–æ–Ω–∏—Ç—å –Ω–∞ –≥–æ—Ä—è—á—É—é –ª–∏–Ω–∏—é.',
      '–ú—ã —Ä–∞—Å—Å–º–æ—Ç—Ä–∏–º –≤–∞—à—É –ø—Ä–æ–±–ª–µ–º—É –∫–∞–∫ –º–æ–∂–Ω–æ —Å–∫–æ—Ä–µ–µ!',
    ];
    const r = responses[Math.floor(Math.random()*responses.length)];
    chat.innerHTML += `<div class="support-msg bot">${r}</div>`;
    chat.scrollTop = chat.scrollHeight;
  }, 1500);
}

// ‚îÄ‚îÄ‚îÄ –ù–ê–í–ò–ì–ê–¶–ò–Ø ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const PROFILE_SCREENS = ['profile','orders','addresses','payments','promos','support'];

function goTo(screen) {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  const el = document.getElementById('screen-'+screen);
  if (el) el.classList.add('active');

  document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
  const nb = document.getElementById('nav-'+screen);
  if (nb) nb.classList.add('active');
  if (PROFILE_SCREENS.includes(screen)) {
    const pnb = document.getElementById('nav-profile');
    if (pnb) pnb.classList.add('active');
  }

  const top  = document.getElementById('mainTopbar');
  const tabs = document.getElementById('catalogTabs');
  const bnav = document.getElementById('bottomNav');

  if (screen === 'catalog') {
    top.style.display='block'; tabs.style.display='flex'; bnav.style.display='flex';
    document.getElementById('nav-catalog').classList.add('active');
  } else if (screen === 'menu') {
    top.style.display='none'; tabs.style.display='none'; bnav.style.display='flex';
  } else if (screen === 'cart') {
    top.style.display='none'; tabs.style.display='none'; bnav.style.display='flex';
    renderCartScreen();
  } else if (screen === 'checkout') {
    top.style.display='none'; tabs.style.display='none'; bnav.style.display='none';
    renderCheckoutScreen();
  } else if (screen === 'order') {
    top.style.display='none'; tabs.style.display='none'; bnav.style.display='none';
  } else if (screen === 'profile') {
    top.style.display='none'; tabs.style.display='none'; bnav.style.display='flex';
  } else if (screen === 'orders') {
    top.style.display='none'; tabs.style.display='none'; bnav.style.display='none';
    loadOrders();
  } else if (screen === 'addresses') {
    top.style.display='none'; tabs.style.display='none'; bnav.style.display='none';
    loadAddresses();
  } else if (screen === 'payments') {
    top.style.display='none'; tabs.style.display='none'; bnav.style.display='none';
    loadPayments();
  } else if (screen === 'promos') {
    top.style.display='none'; tabs.style.display='none'; bnav.style.display='none';
    loadPromos();
  } else if (screen === 'support') {
    top.style.display='none'; tabs.style.display='none'; bnav.style.display='none';
  }

  currentScreen = screen;
  document.getElementById('mainContent').scrollTo(0, 0);
}

function selectTab(t, btn) {
  document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  if (t === 'offline') showToast('–ö–∞—Ä—Ç–∞ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–æ–≤ —Å–∫–æ—Ä–æ –±—É–¥–µ—Ç');
}

let toastT;
function showToast(msg) {
  const el = document.getElementById('toast');
  el.textContent = msg;
  el.classList.add('show');
  clearTimeout(toastT);
  toastT = setTimeout(() => el.classList.remove('show'), 2800);
}

goTo('catalog');
</script>
</body>
</html>
