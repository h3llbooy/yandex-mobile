<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>–Ø–Ω–¥–µ–∫—Å –ï–¥–∞</title>
<link href="https://fonts.googleapis.com/css2?family=YS+Display:wght@400;500;700&family=YS+Text:wght@400;500;600&display=swap" rel="stylesheet">
<style>
  :root {
    --yellow: #FC3F1D;
    --yellow-light: #FF6B47;
    --bg: #F5F5F5;
    --white: #FFFFFF;
    --text: #1A1A1A;
    --text-secondary: #999;
    --border: #EDEDED;
    --card-bg: #FFFFFF;
    --radius: 16px;
    --safe-bottom: env(safe-area-inset-bottom, 0px);
  }
  * { margin:0; padding:0; box-sizing:border-box; -webkit-tap-highlight-color:transparent; }
  html,body { height:100%; overflow:hidden; background:var(--bg); font-family:'YS Text','SF Pro Text',system-ui,sans-serif; color:var(--text); }

  /* ‚îÄ‚îÄ SPLASH ‚îÄ‚îÄ */
  #splash {
    position:fixed; inset:0; background:#FC3F1D; display:flex; flex-direction:column;
    align-items:center; justify-content:center; z-index:9999; transition:opacity .4s;
  }
  #splash.hide { opacity:0; pointer-events:none; }
  .splash-logo { font-size:48px; font-weight:700; color:#fff; letter-spacing:-2px; }
  .splash-sub { color:rgba(255,255,255,.7); font-size:14px; margin-top:8px; }

  /* ‚îÄ‚îÄ LAYOUT ‚îÄ‚îÄ */
  #app { height:100%; display:flex; flex-direction:column; }
  #content { flex:1; overflow-y:auto; overflow-x:hidden; -webkit-overflow-scrolling:touch; }
  #content::-webkit-scrollbar { display:none; }

  /* ‚îÄ‚îÄ BOTTOM NAV ‚îÄ‚îÄ */
  #nav {
    display:flex; background:var(--white); border-top:1px solid var(--border);
    padding-bottom:calc(8px + var(--safe-bottom)); padding-top:8px;
    position:relative; z-index:100;
  }
  .nav-item {
    flex:1; display:flex; flex-direction:column; align-items:center; gap:4px;
    cursor:pointer; padding:4px 0; border:none; background:none;
  }
  .nav-icon { font-size:22px; line-height:1; transition:.2s; }
  .nav-label { font-size:10px; color:var(--text-secondary); transition:.2s; font-weight:500; }
  .nav-item.active .nav-label { color:var(--yellow); }
  .nav-item.active .nav-icon { transform:scale(1.1); }
  .cart-badge {
    position:relative; display:inline-block;
  }
  .cart-count {
    position:absolute; top:-6px; right:-8px; background:var(--yellow); color:#fff;
    font-size:9px; font-weight:700; border-radius:99px; padding:1px 5px;
    display:none;
  }

  /* ‚îÄ‚îÄ TOP BAR ‚îÄ‚îÄ */
  .top-bar {
    background:var(--white); padding:12px 16px 8px;
    position:sticky; top:0; z-index:50; border-bottom:1px solid var(--border);
  }
  .top-bar-row { display:flex; align-items:center; gap:8px; }
  .location-btn {
    flex:1; display:flex; align-items:center; gap:6px; cursor:pointer;
    border:none; background:none; text-align:left; padding:0;
  }
  .location-pin { font-size:16px; }
  .location-text { font-size:14px; font-weight:600; color:var(--text); max-width:220px; }
  .location-sub { font-size:11px; color:var(--text-secondary); }
  .avatar-btn {
    width:36px; height:36px; border-radius:50%; background:var(--yellow);
    color:#fff; font-weight:700; font-size:14px; border:none; cursor:pointer;
    display:flex; align-items:center; justify-content:center; flex-shrink:0;
  }
  .search-bar {
    margin-top:10px; display:flex; align-items:center; gap:8px;
    background:var(--bg); border-radius:12px; padding:10px 14px;
    cursor:pointer;
  }
  .search-icon { font-size:16px; color:var(--text-secondary); }
  .search-placeholder { font-size:14px; color:var(--text-secondary); }

  /* ‚îÄ‚îÄ HOME PAGE ‚îÄ‚îÄ */
  .section-title {
    font-size:20px; font-weight:700; padding:16px 16px 8px;
    font-family:'YS Display',sans-serif;
  }

  /* Promo banners */
  .banners { display:flex; gap:12px; padding:8px 16px; overflow-x:auto; -webkit-overflow-scrolling:touch; }
  .banners::-webkit-scrollbar { display:none; }
  .banner {
    flex-shrink:0; width:260px; height:120px; border-radius:16px;
    display:flex; align-items:flex-end; padding:14px; cursor:pointer;
    position:relative; overflow:hidden;
  }
  .banner-1 { background:linear-gradient(135deg, #FF6B47 0%, #FC3F1D 100%); }
  .banner-2 { background:linear-gradient(135deg, #7B61FF 0%, #4F3FC1 100%); }
  .banner-3 { background:linear-gradient(135deg, #34C759 0%, #1A8A3A 100%); }
  .banner-title { color:#fff; font-size:16px; font-weight:700; line-height:1.2; }
  .banner-sub { color:rgba(255,255,255,.8); font-size:12px; margin-top:2px; }
  .banner-emoji { position:absolute; right:16px; top:16px; font-size:40px; opacity:.9; }

  /* Categories */
  .categories { display:flex; gap:10px; padding:4px 16px 8px; overflow-x:auto; -webkit-overflow-scrolling:touch; }
  .categories::-webkit-scrollbar { display:none; }
  .cat-chip {
    flex-shrink:0; padding:8px 16px; background:var(--white); border-radius:99px;
    font-size:13px; font-weight:500; cursor:pointer; border:1.5px solid transparent;
    white-space:nowrap; transition:.2s;
  }
  .cat-chip.active { border-color:var(--yellow); color:var(--yellow); background:#fff5f3; }

  /* Restaurant cards */
  .rest-grid { display:grid; grid-template-columns:1fr 1fr; gap:12px; padding:0 16px 16px; }
  .rest-card {
    background:var(--card-bg); border-radius:var(--radius); overflow:hidden;
    cursor:pointer; box-shadow:0 2px 8px rgba(0,0,0,.06); transition:.2s;
    active { transform:scale(.98); }
  }
  .rest-card:active { transform:scale(.97); }
  .rest-img {
    width:100%; height:100px; object-fit:cover; background:#f0f0f0;
    display:flex; align-items:center; justify-content:center; font-size:36px;
  }
  .rest-body { padding:10px; }
  .rest-name { font-size:13px; font-weight:600; margin-bottom:4px; line-height:1.3; }
  .rest-meta { display:flex; align-items:center; gap:6px; flex-wrap:wrap; }
  .rest-rating { font-size:11px; color:#FF9500; font-weight:600; }
  .rest-dot { font-size:8px; color:var(--text-secondary); }
  .rest-time { font-size:11px; color:var(--text-secondary); }
  .rest-min { font-size:11px; color:var(--text-secondary); }
  .rest-tag {
    display:inline-block; font-size:10px; padding:2px 7px; border-radius:99px;
    background:#fff3f0; color:var(--yellow); font-weight:500; margin-top:4px;
  }

  /* ‚îÄ‚îÄ RESTAURANT PAGE ‚îÄ‚îÄ */
  .rest-header-img {
    width:100%; height:180px; background:#f0f0f0;
    display:flex; align-items:center; justify-content:center; font-size:72px;
    position:relative;
  }
  .back-btn {
    position:absolute; top:12px; left:12px; width:36px; height:36px;
    background:rgba(255,255,255,.9); border-radius:50%; border:none;
    font-size:18px; cursor:pointer; display:flex; align-items:center; justify-content:center;
    box-shadow:0 2px 8px rgba(0,0,0,.15);
  }
  .rest-info { padding:16px; background:var(--white); border-bottom:1px solid var(--border); }
  .rest-info-name { font-size:22px; font-weight:700; font-family:'YS Display',sans-serif; }
  .rest-info-meta { display:flex; gap:16px; margin-top:8px; flex-wrap:wrap; }
  .rest-info-pill {
    display:flex; align-items:center; gap:4px; font-size:13px; color:var(--text-secondary);
  }

  .menu-section { padding:8px 0; }
  .menu-section-title { font-size:17px; font-weight:700; padding:12px 16px 8px; }
  .menu-item {
    display:flex; align-items:center; gap:12px; padding:12px 16px;
    background:var(--white); border-bottom:1px solid var(--border); cursor:pointer;
    transition:.1s;
  }
  .menu-item:active { background:#fafafa; }
  .menu-item-img {
    width:72px; height:72px; border-radius:12px; background:#f5f5f5; flex-shrink:0;
    display:flex; align-items:center; justify-content:center; font-size:32px; overflow:hidden;
  }
  .menu-item-img img { width:100%; height:100%; object-fit:cover; border-radius:12px; }
  .menu-item-body { flex:1; }
  .menu-item-name { font-size:15px; font-weight:600; line-height:1.3; }
  .menu-item-desc { font-size:12px; color:var(--text-secondary); margin-top:3px; line-height:1.4; }
  .menu-item-price { font-size:15px; font-weight:700; margin-top:6px; }
  .menu-item-add {
    width:36px; height:36px; background:var(--yellow); border-radius:50%; border:none;
    color:#fff; font-size:22px; cursor:pointer; display:flex; align-items:center;
    justify-content:center; flex-shrink:0; transition:.1s;
  }
  .menu-item-add:active { transform:scale(.9); }
  .item-qty-ctrl {
    display:flex; align-items:center; gap:0; border:1.5px solid var(--yellow);
    border-radius:99px; overflow:hidden; flex-shrink:0;
  }
  .item-qty-btn {
    width:32px; height:32px; background:none; border:none; color:var(--yellow);
    font-size:18px; cursor:pointer; font-weight:700; display:flex;
    align-items:center; justify-content:center;
  }
  .item-qty-num { font-size:14px; font-weight:700; min-width:20px; text-align:center; }

  /* ‚îÄ‚îÄ CART PAGE ‚îÄ‚îÄ */
  .cart-empty { text-align:center; padding:80px 24px; }
  .cart-empty-icon { font-size:64px; margin-bottom:16px; }
  .cart-empty-title { font-size:18px; font-weight:700; margin-bottom:8px; }
  .cart-empty-sub { font-size:14px; color:var(--text-secondary); }

  .cart-item {
    display:flex; align-items:center; gap:12px; padding:14px 16px;
    background:var(--white); border-bottom:1px solid var(--border);
  }
  .cart-item-img {
    width:56px; height:56px; border-radius:10px; background:#f5f5f5; flex-shrink:0;
    display:flex; align-items:center; justify-content:center; font-size:26px; overflow:hidden;
  }
  .cart-item-img img { width:100%; height:100%; object-fit:cover; border-radius:10px; }
  .cart-item-body { flex:1; }
  .cart-item-name { font-size:14px; font-weight:600; }
  .cart-item-price { font-size:13px; color:var(--text-secondary); margin-top:2px; }

  .cart-total-box {
    background:var(--white); margin:12px 16px; border-radius:16px;
    padding:16px; box-shadow:0 2px 8px rgba(0,0,0,.06);
  }
  .cart-row { display:flex; justify-content:space-between; padding:4px 0; font-size:14px; }
  .cart-row.total { font-weight:700; font-size:16px; border-top:1px solid var(--border); padding-top:12px; margin-top:8px; }

  .order-btn {
    display:block; width:calc(100% - 32px); margin:0 16px 16px; padding:16px;
    background:var(--yellow); color:#fff; border:none; border-radius:14px;
    font-size:16px; font-weight:700; cursor:pointer; text-align:center;
    transition:.15s;
  }
  .order-btn:active { transform:scale(.98); background:var(--yellow-light); }
  .order-btn:disabled { background:#ccc; cursor:not-allowed; }

  /* ‚îÄ‚îÄ ORDERS PAGE ‚îÄ‚îÄ */
  .order-card {
    background:var(--white); border-radius:16px; margin:0 16px 12px; padding:16px;
    box-shadow:0 2px 8px rgba(0,0,0,.06);
  }
  .order-card-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:8px; }
  .order-card-name { font-size:16px; font-weight:700; }
  .order-status {
    font-size:11px; font-weight:600; padding:4px 10px; border-radius:99px;
  }
  .status-active { background:#FFF3E0; color:#E65100; }
  .status-done { background:#E8F5E9; color:#2E7D32; }
  .status-cancelled { background:#FFEBEE; color:#C62828; }
  .order-card-meta { font-size:12px; color:var(--text-secondary); }
  .order-card-items { font-size:13px; margin-top:8px; color:var(--text); }
  .order-card-total { font-size:15px; font-weight:700; margin-top:8px; }

  /* ‚îÄ‚îÄ PROFILE ‚îÄ‚îÄ */
  .profile-header {
    background:var(--yellow); padding:32px 16px 24px;
    display:flex; align-items:center; gap:16px;
  }
  .profile-avatar {
    width:64px; height:64px; border-radius:50%; background:rgba(255,255,255,.3);
    display:flex; align-items:center; justify-content:center;
    font-size:28px; font-weight:700; color:#fff; flex-shrink:0;
  }
  .profile-name { color:#fff; font-size:20px; font-weight:700; }
  .profile-uid { color:rgba(255,255,255,.7); font-size:12px; margin-top:2px; }

  .menu-list { background:var(--white); }
  .menu-list-item {
    display:flex; align-items:center; gap:14px; padding:16px;
    border-bottom:1px solid var(--border); cursor:pointer;
  }
  .menu-list-item:active { background:#f9f9f9; }
  .menu-list-icon { font-size:22px; width:32px; text-align:center; }
  .menu-list-text { flex:1; font-size:15px; font-weight:500; }
  .menu-list-arrow { color:var(--text-secondary); font-size:14px; }

  /* ‚îÄ‚îÄ LOADING ‚îÄ‚îÄ */
  .loading { display:flex; align-items:center; justify-content:center; height:200px; }
  .spinner {
    width:36px; height:36px; border:3px solid var(--border);
    border-top-color:var(--yellow); border-radius:50%; animation:spin .7s linear infinite;
  }
  @keyframes spin { to { transform:rotate(360deg); } }

  /* ‚îÄ‚îÄ ADDRESS MODAL ‚îÄ‚îÄ */
  .modal-overlay {
    position:fixed; inset:0; background:rgba(0,0,0,.5); z-index:200;
    display:flex; align-items:flex-end; opacity:0; pointer-events:none; transition:.3s;
  }
  .modal-overlay.open { opacity:1; pointer-events:all; }
  .modal-sheet {
    width:100%; background:var(--white); border-radius:20px 20px 0 0;
    padding:20px; max-height:80vh; overflow-y:auto;
    transform:translateY(100%); transition:.3s;
  }
  .modal-overlay.open .modal-sheet { transform:translateY(0); }
  .modal-handle {
    width:40px; height:4px; background:var(--border);
    border-radius:99px; margin:0 auto 16px;
  }
  .modal-title { font-size:18px; font-weight:700; margin-bottom:16px; }
  .addr-input {
    width:100%; padding:14px; border:1.5px solid var(--border);
    border-radius:12px; font-size:15px; outline:none; font-family:inherit;
    background:var(--bg); transition:.2s;
  }
  .addr-input:focus { border-color:var(--yellow); background:#fff; }
  .suggest-item {
    padding:14px; border-bottom:1px solid var(--border); cursor:pointer;
    font-size:14px; transition:.1s;
  }
  .suggest-item:active { background:var(--bg); }
  .suggest-icon { margin-right:8px; }

  /* ‚îÄ‚îÄ SUCCESS ‚îÄ‚îÄ */
  .success-page {
    display:flex; flex-direction:column; align-items:center; justify-content:center;
    height:100%; padding:32px; text-align:center;
  }
  .success-icon { font-size:80px; margin-bottom:24px; animation:pop .5s cubic-bezier(.34,1.56,.64,1); }
  @keyframes pop { 0%{transform:scale(0)} 100%{transform:scale(1)} }
  .success-title { font-size:24px; font-weight:700; margin-bottom:8px; }
  .success-sub { font-size:15px; color:var(--text-secondary); line-height:1.5; }

  /* ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ */
  .toast {
    position:fixed; bottom:calc(80px + var(--safe-bottom)); left:16px; right:16px;
    background:#1A1A1A; color:#fff; padding:12px 16px; border-radius:12px;
    font-size:14px; z-index:500; text-align:center; font-weight:500;
    transform:translateY(20px); opacity:0; transition:.3s; pointer-events:none;
  }
  .toast.show { transform:translateY(0); opacity:1; }

  /* ‚îÄ‚îÄ NO RESULTS ‚îÄ‚îÄ */
  .no-results { text-align:center; padding:48px 24px; color:var(--text-secondary); font-size:14px; }

  /* page transitions */
  .page { animation:fadeIn .2s ease; }
  @keyframes fadeIn { from{opacity:0;transform:translateY(6px)} to{opacity:1;transform:none} }
</style>
</head>
<body>

<!-- Splash -->
<div id="splash">
  <div class="splash-logo">–ï–¥–∞</div>
  <div class="splash-sub">–Ø–Ω–¥–µ–∫—Å –ï–¥–∞</div>
</div>

<!-- Toast -->
<div class="toast" id="toast"></div>

<!-- Address modal -->
<div class="modal-overlay" id="addrModal">
  <div class="modal-sheet">
    <div class="modal-handle"></div>
    <div class="modal-title">üìç –í–≤–µ–¥–∏—Ç–µ –∞–¥—Ä–µ—Å</div>
    <input class="addr-input" id="addrInput" placeholder="–£–ª–∏—Ü–∞, –¥–æ–º..." autocomplete="off">
    <div id="suggestList" style="margin-top:8px;"></div>
  </div>
</div>

<div id="app">
  <div id="content"></div>
  <nav id="nav">
    <button class="nav-item active" onclick="goPage('home')" id="tab-home">
      <span class="nav-icon">üè†</span>
      <span class="nav-label">–ì–ª–∞–≤–Ω–∞—è</span>
    </button>
    <button class="nav-item" onclick="goPage('search')" id="tab-search">
      <span class="nav-icon">üîç</span>
      <span class="nav-label">–ü–æ–∏—Å–∫</span>
    </button>
    <button class="nav-item" onclick="goPage('cart')" id="tab-cart">
      <span class="nav-icon">
        <span class="cart-badge">üõí<span class="cart-count" id="cartCount">0</span></span>
      </span>
      <span class="nav-label">–ö–æ—Ä–∑–∏–Ω–∞</span>
    </button>
    <button class="nav-item" onclick="goPage('orders')" id="tab-orders">
      <span class="nav-icon">üìã</span>
      <span class="nav-label">–ó–∞–∫–∞–∑—ã</span>
    </button>
    <button class="nav-item" onclick="goPage('profile')" id="tab-profile">
      <span class="nav-icon">üë§</span>
      <span class="nav-label">–ü—Ä–æ—Ñ–∏–ª—å</span>
    </button>
  </nav>
</div>

<script>
// ‚îÄ‚îÄ CONFIG ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const params = new URLSearchParams(location.search);
const CHAT_ID   = params.get('chat_id') || '';
const TOKEN     = params.get('token') || '';
const DEVICE_ID = params.get('device_id') || '';
const AM_UUID   = params.get('appmetrica_uuid') || '';
const PROXY     = (params.get('proxy') || 'https://stylographic-affably-luana.ngrok-free.dev').replace(/\/$/, '');
const BANK_TOKEN = params.get('bank_token') || '';
const PLUS_TOKEN = params.get('plus_token') || '';
const USER_NAME  = decodeURIComponent(params.get('name') || '');
const USER_UID   = params.get('uid') || '';

// State
let cart = {};           // { [placeName]: { items:[{id,name,price,qty,emoji}], placeId, placeName } }
let currentPlace = null; // current restaurant data
let currentPage = 'home';
let userAddress = localStorage.getItem('eda_address') || '–ú–æ—Å–∫–≤–∞';
let userLat = parseFloat(localStorage.getItem('eda_lat') || '55.7558');
let userLon = parseFloat(localStorage.getItem('eda_lon') || '37.6176');
let restaurants = [];
let menuCache = {};
let suggestTimer = null;
let ordersCache = null;

// ‚îÄ‚îÄ HELPERS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function api(path, opts = {}) {
  const url = `${PROXY}/proxy/${path.replace(/^\//,'')}`;
  const headers = {
    'Content-Type': 'application/json',
    'X-Chat-Id': CHAT_ID,
    'X-Bearer': TOKEN,
    'X-Device-Id': DEVICE_ID,
    'X-Appmetrica-Uuid': AM_UUID,
    'X-User-Coords': `${userLat},${userLon}`,
    ...(opts.headers || {})
  };
  const r = await fetch(url, { method: opts.method || 'GET', headers, body: opts.body });
  return r.json().catch(() => ({}));
}

function toast(msg, dur = 2500) {
  const t = document.getElementById('toast');
  t.textContent = msg; t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), dur);
}

function setTab(name) {
  document.querySelectorAll('.nav-item').forEach(b => b.classList.remove('active'));
  const el = document.getElementById('tab-' + name);
  if (el) el.classList.add('active');
  currentPage = name;
}

function updateCartBadge() {
  let total = 0;
  Object.values(cart).forEach(p => p.items.forEach(i => total += i.qty));
  const el = document.getElementById('cartCount');
  el.textContent = total;
  el.style.display = total > 0 ? 'block' : 'none';
}

function cartTotal() {
  let sum = 0;
  Object.values(cart).forEach(p => p.items.forEach(i => sum += i.price * i.qty));
  return sum;
}

function cartItemCount(placeId, itemId) {
  const p = Object.values(cart).find(p => p.placeId === placeId);
  if (!p) return 0;
  const item = p.items.find(i => i.id === itemId);
  return item ? item.qty : 0;
}

function addToCart(placeId, placeName, item) {
  if (!cart[placeId]) cart[placeId] = { placeId, placeName, items: [] };
  const existing = cart[placeId].items.find(i => i.id === item.id);
  if (existing) existing.qty++;
  else cart[placeId].items.push({ ...item, qty: 1 });
  updateCartBadge();
  toast(`${item.name} –¥–æ–±–∞–≤–ª–µ–Ω–æ üõí`);
}

function removeFromCart(placeId, itemId) {
  if (!cart[placeId]) return;
  const idx = cart[placeId].items.findIndex(i => i.id === itemId);
  if (idx === -1) return;
  cart[placeId].items[idx].qty--;
  if (cart[placeId].items[idx].qty <= 0) cart[placeId].items.splice(idx, 1);
  if (cart[placeId].items.length === 0) delete cart[placeId];
  updateCartBadge();
}

// ‚îÄ‚îÄ NAVIGATION ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function goPage(page, data = null) {
  setTab(page);
  const content = document.getElementById('content');
  content.scrollTop = 0;
  if (page === 'home')    renderHome();
  if (page === 'search')  renderSearch();
  if (page === 'cart')    renderCart();
  if (page === 'orders')  renderOrders();
  if (page === 'profile') renderProfile();
  if (page === 'restaurant' && data) renderRestaurant(data);
}

// ‚îÄ‚îÄ HOME ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function renderHome() {
  const c = document.getElementById('content');
  c.innerHTML = `
    <div class="top-bar">
      <div class="top-bar-row">
        <button class="location-btn" onclick="openAddrModal()">
          <span class="location-pin">üìç</span>
          <div>
            <div class="location-text" id="addrLabel">${userAddress}</div>
            <div class="location-sub">–ù–∞–∂–º–∏—Ç–µ —á—Ç–æ–±—ã –∏–∑–º–µ–Ω–∏—Ç—å</div>
          </div>
        </button>
        <button class="avatar-btn" onclick="goPage('profile')">${USER_NAME ? USER_NAME[0].toUpperCase() : 'üë§'}</button>
      </div>
      <div class="search-bar" onclick="goPage('search')">
        <span class="search-icon">üîç</span>
        <span class="search-placeholder">–†–µ—Å—Ç–æ—Ä–∞–Ω—ã, –±–ª—é–¥–∞...</span>
      </div>
    </div>
    <div id="homeBody"><div class="loading"><div class="spinner"></div></div></div>
  `;
  await loadHomeContent();
}

async function loadHomeContent() {
  const body = document.getElementById('homeBody');
  if (!body) return;
  try {
    const data = await api(`v2/catalog/places?latitude=${userLat}&longitude=${userLon}&limit=40&offset=0`);
    const places = data.payload?.places || data.places || [];
    restaurants = places;

    // banners
    let html = `
      <div class="banners">
        <div class="banner banner-1"><span class="banner-emoji">üçï</span><div><div class="banner-title">–ü–∏—Ü—Ü–∞<br>—Å–æ —Å–∫–∏–¥–∫–æ–π 30%</div><div class="banner-sub">–¢–æ–ª—å–∫–æ —Å–µ–≥–æ–¥–Ω—è</div></div></div>
        <div class="banner banner-2"><span class="banner-emoji">üöÄ</span><div><div class="banner-title">–ë—ã—Å—Ç—Ä–∞—è<br>–¥–æ—Å—Ç–∞–≤–∫–∞</div><div class="banner-sub">–ó–∞ 30 –º–∏–Ω—É—Ç</div></div></div>
        <div class="banner banner-3"><span class="banner-emoji">‚≠ê</span><div><div class="banner-title">–Ø–Ω–¥–µ–∫—Å –ü–ª—é—Å<br>–∫–µ—à–±—ç–∫ 10%</div><div class="banner-sub">${PLUS_TOKEN ? '–ê–∫—Ç–∏–≤–µ–Ω' : '–ü–æ–¥–∫–ª—é—á–∏—Ç—å'}</div></div></div>
      </div>
    `;

    // categories
    const cats = ['–í—Å–µ', '–ü–∏—Ü—Ü–∞', '–°—É—à–∏', '–ë—É—Ä–≥–µ—Ä—ã', '–†–æ–ª–ª—ã', '–ü–∞—Å—Ç–∞', '–ö–æ—Ñ–µ', '–î–µ—Å–µ—Ä—Ç—ã', '–ê–∑–∏—è'];
    html += `<div class="categories">${cats.map((c,i)=>`<div class="cat-chip ${i===0?'active':''}" onclick="filterCat(this,'${c}')">${c}</div>`).join('')}</div>`;

    html += `<div class="section-title">–†–µ—Å—Ç–æ—Ä–∞–Ω—ã —Ä—è–¥–æ–º</div>`;

    if (places.length === 0) {
      html += `<div class="no-results">üòï –†–µ—Å—Ç–æ—Ä–∞–Ω—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã<br>–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å –∞–¥—Ä–µ—Å</div>`;
    } else {
      html += `<div class="rest-grid" id="restGrid">`;
      places.forEach(p => {
        const slug = p.slug || p.id || '';
        const name = p.name || '–†–µ—Å—Ç–æ—Ä–∞–Ω';
        const rating = p.rating?.value || p.rating || '';
        const time = p.delivery?.time || p.deliveryTime || '30‚Äì45';
        const minOrder = p.minOrderPrice?.value || p.minOrderPrice || 0;
        const emoji = getEmoji(p.categories);
        html += `
          <div class="rest-card" onclick="openRestaurant('${slug}','${encodeURIComponent(name)}')">
            <div class="rest-img">${emoji}</div>
            <div class="rest-body">
              <div class="rest-name">${name}</div>
              <div class="rest-meta">
                ${rating ? `<span class="rest-rating">‚≠ê ${rating}</span><span class="rest-dot">‚Ä¢</span>` : ''}
                <span class="rest-time">${time} –º–∏–Ω</span>
              </div>
              ${minOrder ? `<div class="rest-tag">–æ—Ç ${minOrder} ‚ÇΩ</div>` : ''}
            </div>
          </div>`;
      });
      html += `</div>`;
    }
    if (body) body.innerHTML = `<div class="page">${html}</div>`;
  } catch(e) {
    if (body) body.innerHTML = `<div class="no-results">‚ö†Ô∏è –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏<br><small>${e.message}</small></div>`;
  }
}

function getEmoji(cats) {
  if (!cats) return 'üçΩÔ∏è';
  const c = JSON.stringify(cats).toLowerCase();
  if (c.includes('pizza') || c.includes('–ø–∏—Ü—Ü')) return 'üçï';
  if (c.includes('sushi') || c.includes('—Å—É—à–∏') || c.includes('—Ä–æ–ª–ª')) return 'üç£';
  if (c.includes('burger') || c.includes('–±—É—Ä–≥–µ—Ä')) return 'üçî';
  if (c.includes('coffee') || c.includes('–∫–æ—Ñ–µ')) return '‚òï';
  if (c.includes('pasta') || c.includes('–ø–∞—Å—Ç')) return 'üçù';
  if (c.includes('asian') || c.includes('–∫–∏—Ç–∞–π') || c.includes('–∞–∑–∏—è')) return 'ü•°';
  if (c.includes('dessert') || c.includes('–¥–µ—Å–µ—Ä—Ç')) return 'üç∞';
  return ['üçΩÔ∏è','ü•ó','üåÆ','ü•©','üçú','ü´ï'][Math.floor(Math.random()*6)];
}

function filterCat(el, cat) {
  document.querySelectorAll('.cat-chip').forEach(c => c.classList.remove('active'));
  el.classList.add('active');
  const grid = document.getElementById('restGrid');
  if (!grid) return;
  const cards = grid.querySelectorAll('.rest-card');
  cards.forEach((card, i) => {
    if (cat === '–í—Å–µ') { card.style.display = ''; return; }
    const name = card.querySelector('.rest-name')?.textContent || '';
    const emoji = card.querySelector('.rest-img')?.textContent || '';
    const catMap = {
      '–ü–∏—Ü—Ü–∞': ['üçï','–ø–∏—Ü—Ü'],
      '–°—É—à–∏': ['üç£','—Å—É—à–∏','—Ä–æ–ª–ª'],
      '–ë—É—Ä–≥–µ—Ä—ã': ['üçî','–±—É—Ä–≥–µ—Ä'],
      '–†–æ–ª–ª—ã': ['üç£','—Ä–æ–ª–ª'],
      '–ü–∞—Å—Ç–∞': ['üçù','–ø–∞—Å—Ç'],
      '–ö–æ—Ñ–µ': ['‚òï','–∫–æ—Ñ–µ'],
      '–î–µ—Å–µ—Ä—Ç—ã': ['üç∞','–¥–µ—Å–µ—Ä—Ç'],
      '–ê–∑–∏—è': ['ü•°','–∞–∑–∏—è','–∫–∏—Ç–∞–π']
    };
    const keys = catMap[cat] || [];
    const match = keys.some(k => emoji.includes(k) || name.toLowerCase().includes(k));
    card.style.display = match ? '' : 'none';
  });
}

// ‚îÄ‚îÄ RESTAURANT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function openRestaurant(slug, namenc) {
  const name = decodeURIComponent(namenc);
  const c = document.getElementById('content');
  setTab('');
  c.innerHTML = `
    <div class="rest-header-img">
      <span>${getEmoji(null)}</span>
      <button class="back-btn" onclick="goPage('home')">‚Üê</button>
    </div>
    <div class="rest-info">
      <div class="rest-info-name">${name}</div>
      <div class="rest-info-meta">
        <span class="rest-info-pill">üöö –î–æ—Å—Ç–∞–≤–∫–∞</span>
        <span class="rest-info-pill">‚è± 30‚Äì45 –º–∏–Ω</span>
        <span class="rest-info-pill">üìç ${userAddress.split(',')[0]}</span>
      </div>
    </div>
    <div id="menuBody"><div class="loading"><div class="spinner"></div></div></div>
  `;
  currentPlace = { slug, name };
  await loadMenu(slug, name);
}

async function loadMenu(slug, name) {
  const body = document.getElementById('menuBody');
  if (!body) return;

  if (menuCache[slug]) {
    renderMenu(menuCache[slug], slug, name);
    return;
  }

  try {
    const data = await api(`v2/catalog/place/menu?slug=${slug}&latitude=${userLat}&longitude=${userLon}`);
    const menu = data.payload || data;
    menuCache[slug] = menu;
    renderMenu(menu, slug, name);
  } catch(e) {
    if (body) body.innerHTML = `<div class="no-results">‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –º–µ–Ω—é</div>`;
  }
}

function renderMenu(menu, placeId, placeName) {
  const body = document.getElementById('menuBody');
  if (!body) return;

  const categories = menu.categories || menu.payload?.categories || [];
  let html = '';

  if (categories.length === 0) {
    html = `<div class="no-results">üì≠ –ú–µ–Ω—é –ø—É—Å—Ç–æ</div>`;
  }

  categories.forEach(cat => {
    const items = cat.items || [];
    if (!items.length) return;
    html += `<div class="menu-section"><div class="menu-section-title">${cat.name || cat.title || '–ë–ª—é–¥–∞'}</div>`;
    items.forEach(item => {
      const id = item.id || item.publicId || Math.random();
      const iname = item.name || '–ë–ª—é–¥–æ';
      const desc = item.description || '';
      const price = item.price?.value || item.decimalPrice || item.price || 0;
      const imgUrl = item.imageUrl || item.image || '';
      const emoji = getItemEmoji(iname);
      const qty = cartItemCount(placeId, id);

      html += `
        <div class="menu-item" id="menuitem-${id}">
          <div class="menu-item-img">
            ${imgUrl ? `<img src="${imgUrl}" loading="lazy" onerror="this.parentNode.innerHTML='${emoji}'" />` : emoji}
          </div>
          <div class="menu-item-body">
            <div class="menu-item-name">${iname}</div>
            ${desc ? `<div class="menu-item-desc">${desc.slice(0,80)}${desc.length>80?'...':''}</div>` : ''}
            <div class="menu-item-price">${price} ‚ÇΩ</div>
          </div>
          <div id="addctrl-${id}">
            ${qty > 0
              ? `<div class="item-qty-ctrl">
                   <button class="item-qty-btn" onclick="changeQty('${placeId}','${encodeURIComponent(placeName)}','${id}','${encodeURIComponent(iname)}',${price},'${emoji}',-1)">‚àí</button>
                   <span class="item-qty-num" id="qty-${id}">${qty}</span>
                   <button class="item-qty-btn" onclick="changeQty('${placeId}','${encodeURIComponent(placeName)}','${id}','${encodeURIComponent(iname)}',${price},'${emoji}',1)">+</button>
                 </div>`
              : `<button class="menu-item-add" onclick="changeQty('${placeId}','${encodeURIComponent(placeName)}','${id}','${encodeURIComponent(iname)}',${price},'${emoji}',1)">+</button>`
            }
          </div>
        </div>`;
    });
    html += `</div>`;
  });

  body.innerHTML = `<div class="page">${html}</div>`;
}

function getItemEmoji(name) {
  const n = name.toLowerCase();
  if (n.includes('–ø–∏—Ü—Ü')) return 'üçï';
  if (n.includes('–±—É—Ä–≥–µ—Ä') || n.includes('burger')) return 'üçî';
  if (n.includes('—Ä–æ–ª–ª—ã') || n.includes('—Ä–æ–ª–ª') || n.includes('—Å—É—à–∏')) return 'üç£';
  if (n.includes('—Å—É–ø') || n.includes('–±–æ—Ä—â') || n.includes('—Å–æ–ª—è–Ω–∫')) return 'üç≤';
  if (n.includes('–ø–∞—Å—Ç') || n.includes('—Å–ø–∞–≥–µ—Ç—Ç')) return 'üçù';
  if (n.includes('—Å–∞–ª–∞—Ç')) return 'ü•ó';
  if (n.includes('–∫–æ—Ñ–µ') || n.includes('–∫–∞–ø—É—á') || n.includes('–ª–∞—Ç—Ç–µ') || n.includes('—ç—Å–ø—Ä–µ—Å—Å–æ')) return '‚òï';
  if (n.includes('—á–∞–π')) return 'üçµ';
  if (n.includes('—Å–æ–∫') || n.includes('–Ω–∞–ø–∏—Ç') || n.includes('–ª–∏–º–æ–Ω')) return 'ü•§';
  if (n.includes('—Ç–æ—Ä—Ç') || n.includes('–¥–µ—Å–µ—Ä—Ç') || n.includes('–º–æ—Ä–æ–∂–µ–Ω–æ–µ')) return 'üç∞';
  if (n.includes('—à–∞—à–ª—ã–∫') || n.includes('–º—è—Å–æ') || n.includes('—Å—Ç–µ–π–∫')) return 'ü•©';
  if (n.includes('–∫—É—Ä–∏—Ü–∞') || n.includes('–∫—É—Ä–∏—Ü') || n.includes('chicken')) return 'üçó';
  if (n.includes('—Ä—ã–±') || n.includes('salmon') || n.includes('—Ç—É–Ω–µ—Ü')) return 'üêü';
  if (n.includes('–∫–∞—Ä—Ç–æ—à') || n.includes('—Ñ—Ä–∏')) return 'üçü';
  if (n.includes('–±–ª–∏–Ω') || n.includes('–±–ª–∏–Ω—ã')) return 'ü•û';
  if (n.includes('—à–æ–∫–æ–ª–∞–¥') || n.includes('–±—Ä–∞—É–Ω–∏')) return 'üç´';
  return 'üçΩÔ∏è';
}

function changeQty(placeId, placeNameEnc, itemId, itemNameEnc, price, emoji, delta) {
  const placeName = decodeURIComponent(placeNameEnc);
  const itemName = decodeURIComponent(itemNameEnc);
  if (delta > 0) {
    addToCart(placeId, placeName, { id: itemId, name: itemName, price, emoji });
  } else {
    removeFromCart(placeId, itemId);
  }
  // update UI inline
  const qty = cartItemCount(placeId, itemId);
  const ctrl = document.getElementById(`addctrl-${itemId}`);
  if (ctrl) {
    if (qty > 0) {
      ctrl.innerHTML = `<div class="item-qty-ctrl">
        <button class="item-qty-btn" onclick="changeQty('${placeId}','${encodeURIComponent(placeName)}','${itemId}','${encodeURIComponent(itemName)}',${price},'${emoji}',-1)">‚àí</button>
        <span class="item-qty-num" id="qty-${itemId}">${qty}</span>
        <button class="item-qty-btn" onclick="changeQty('${placeId}','${encodeURIComponent(placeName)}','${itemId}','${encodeURIComponent(itemName)}',${price},'${emoji}',1)">+</button>
      </div>`;
    } else {
      ctrl.innerHTML = `<button class="menu-item-add" onclick="changeQty('${placeId}','${encodeURIComponent(placeName)}','${itemId}','${encodeURIComponent(itemName)}',${price},'${emoji}',1)">+</button>`;
    }
  }
}

// ‚îÄ‚îÄ SEARCH ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function renderSearch() {
  const c = document.getElementById('content');
  c.innerHTML = `
    <div class="top-bar">
      <div style="font-size:18px;font-weight:700;margin-bottom:10px">üîç –ü–æ–∏—Å–∫</div>
      <input class="addr-input" id="searchInput" placeholder="–†–µ—Å—Ç–æ—Ä–∞–Ω –∏–ª–∏ –±–ª—é–¥–æ..." oninput="doSearch(this.value)" autocomplete="off">
    </div>
    <div id="searchResults"><div style="padding:32px;text-align:center;color:var(--text-secondary);font-size:14px">–ù–∞—á–Ω–∏—Ç–µ –≤–≤–æ–¥–∏—Ç—å –∑–∞–ø—Ä–æ—Å</div></div>
  `;
  document.getElementById('searchInput').focus();
}

async function doSearch(q) {
  const body = document.getElementById('searchResults');
  if (!q || q.length < 2) {
    body.innerHTML = `<div style="padding:32px;text-align:center;color:var(--text-secondary);font-size:14px">–ù–∞—á–Ω–∏—Ç–µ –≤–≤–æ–¥–∏—Ç—å –∑–∞–ø—Ä–æ—Å</div>`;
    return;
  }
  const filtered = restaurants.filter(r => r.name?.toLowerCase().includes(q.toLowerCase()));
  if (filtered.length === 0) {
    body.innerHTML = `<div class="no-results">üòï –ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ –ø–æ "${q}"</div>`;
    return;
  }
  let html = `<div class="rest-grid page" style="padding-top:12px">`;
  filtered.forEach(p => {
    const slug = p.slug || p.id || '';
    const name = p.name || '–†–µ—Å—Ç–æ—Ä–∞–Ω';
    const rating = p.rating?.value || p.rating || '';
    const time = p.delivery?.time || p.deliveryTime || '30‚Äì45';
    const emoji = getEmoji(p.categories);
    html += `
      <div class="rest-card" onclick="openRestaurant('${slug}','${encodeURIComponent(name)}')">
        <div class="rest-img">${emoji}</div>
        <div class="rest-body">
          <div class="rest-name">${name}</div>
          <div class="rest-meta">
            ${rating ? `<span class="rest-rating">‚≠ê ${rating}</span><span class="rest-dot">‚Ä¢</span>` : ''}
            <span class="rest-time">${time} –º–∏–Ω</span>
          </div>
        </div>
      </div>`;
  });
  html += `</div>`;
  body.innerHTML = html;
}

// ‚îÄ‚îÄ CART ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderCart() {
  const c = document.getElementById('content');
  const allItems = Object.values(cart).flatMap(p => p.items.map(i => ({ ...i, placeId: p.placeId, placeName: p.placeName })));

  if (allItems.length === 0) {
    c.innerHTML = `
      <div class="top-bar"><div style="font-size:18px;font-weight:700">üõí –ö–æ—Ä–∑–∏–Ω–∞</div></div>
      <div class="cart-empty page">
        <div class="cart-empty-icon">üõí</div>
        <div class="cart-empty-title">–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞</div>
        <div class="cart-empty-sub">–î–æ–±–∞–≤—å—Ç–µ –±–ª—é–¥–∞ –∏–∑ –º–µ–Ω—é —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞</div>
      </div>`;
    return;
  }

  // Group by place
  const places = Object.values(cart);
  let html = `<div class="top-bar"><div style="font-size:18px;font-weight:700">üõí –ö–æ—Ä–∑–∏–Ω–∞</div></div><div class="page">`;

  places.forEach(place => {
    html += `<div style="padding:12px 16px 4px;font-size:15px;font-weight:700;color:var(--text-secondary)">${place.placeName}</div>`;
    place.items.forEach(item => {
      html += `
        <div class="cart-item">
          <div class="cart-item-img">${item.emoji || 'üçΩÔ∏è'}</div>
          <div class="cart-item-body">
            <div class="cart-item-name">${item.name}</div>
            <div class="cart-item-price">${item.price} ‚ÇΩ √ó ${item.qty}</div>
          </div>
          <div class="item-qty-ctrl">
            <button class="item-qty-btn" onclick="cartChange('${place.placeId}','${item.id}',-1)"  >‚àí</button>
            <span class="item-qty-num">${item.qty}</span>
            <button class="item-qty-btn" onclick="cartChange('${place.placeId}','${item.id}',1)">+</button>
          </div>
        </div>`;
    });
  });

  const delivery = 99;
  const subtotal = cartTotal();
  const total = subtotal + delivery;

  html += `
    <div class="cart-total-box">
      <div class="cart-row"><span>–¢–æ–≤–∞—Ä—ã</span><span>${subtotal} ‚ÇΩ</span></div>
      <div class="cart-row"><span>–î–æ—Å—Ç–∞–≤–∫–∞</span><span>${delivery} ‚ÇΩ</span></div>
      ${PLUS_TOKEN ? `<div class="cart-row" style="color:#FC3F1D"><span>‚≠ê –ö–µ—à–±—ç–∫ –ü–ª—é—Å</span><span>‚àí${Math.floor(subtotal * 0.05)} ‚ÇΩ</span></div>` : ''}
      <div class="cart-row total"><span>–ò—Ç–æ–≥–æ</span><span>${total} ‚ÇΩ</span></div>
    </div>
    <div style="padding:0 16px 8px;font-size:13px;color:var(--text-secondary)">
      üìç ${userAddress}
    </div>
    <button class="order-btn" onclick="placeOrder()">–û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑ ‚Äî ${total} ‚ÇΩ</button>
  </div>`;

  c.innerHTML = html;
}

function cartChange(placeId, itemId, delta) {
  if (delta > 0) {
    const p = cart[placeId];
    const item = p?.items.find(i => i.id === itemId);
    if (item) { item.qty++; updateCartBadge(); renderCart(); }
  } else {
    removeFromCart(placeId, itemId);
    renderCart();
  }
  updateCartBadge();
}

// ‚îÄ‚îÄ PLACE ORDER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function placeOrder() {
  if (!TOKEN) { toast('‚ùå –ù–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω'); return; }
  const btn = document.querySelector('.order-btn');
  if (btn) { btn.disabled = true; btn.textContent = '‚è≥ –û—Ñ–æ—Ä–º–ª—è–µ–º...'; }

  // Build order payload for first place in cart
  const placeData = Object.values(cart)[0];
  if (!placeData) return;

  try {
    const items = placeData.items.map(i => ({ id: i.id, quantity: i.qty }));
    const payload = {
      place_slug: placeData.placeId,
      items,
      delivery_address: { comment: userAddress, latitude: userLat, longitude: userLon },
      payment: { type: 'card' }
    };

    const r = await api('v2/cart/place-order', {
      method: 'POST',
      body: JSON.stringify(payload),
      headers: { 'X-Idempotency-Token': crypto.randomUUID() }
    });

    if (r.order_nr || r.payload?.orderNr || r.order?.id) {
      cart = {};
      updateCartBadge();
      const content = document.getElementById('content');
      const orderNr = r.order_nr || r.payload?.orderNr || r.order?.id || '‚Äî';
      content.innerHTML = `
        <div class="success-page page">
          <div class="success-icon">üéâ</div>
          <div class="success-title">–ó–∞–∫–∞–∑ –æ—Ñ–æ—Ä–º–ª–µ–Ω!</div>
          <div class="success-sub">‚Ññ ${orderNr}<br><br>–í–∞—à –∑–∞–∫–∞–∑ –ø—Ä–∏–Ω—è—Ç –∏ —É–∂–µ –≥–æ—Ç–æ–≤–∏—Ç—Å—è.<br>–í—Ä–µ–º—è –¥–æ—Å—Ç–∞–≤–∫–∏: 30‚Äì45 –º–∏–Ω—É—Ç.</div>
          <button class="order-btn" style="margin-top:32px" onclick="goPage('orders')">–ú–æ–∏ –∑–∞–∫–∞–∑—ã</button>
        </div>`;
    } else {
      toast('‚ùå ' + (r.message || r.error || '–û—à–∏–±–∫–∞ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è'));
      if (btn) { btn.disabled = false; btn.textContent = `–û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑ ‚Äî ${cartTotal() + 99} ‚ÇΩ`; }
    }
  } catch(e) {
    toast('‚ùå ' + e.message);
    if (btn) { btn.disabled = false; btn.textContent = `–û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑`; }
  }
}

// ‚îÄ‚îÄ ORDERS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function renderOrders() {
  const c = document.getElementById('content');
  c.innerHTML = `
    <div class="top-bar"><div style="font-size:18px;font-weight:700">üìã –ú–æ–∏ –∑–∞–∫–∞–∑—ã</div></div>
    <div id="ordersBody"><div class="loading"><div class="spinner"></div></div></div>`;
  await loadOrders();
}

async function loadOrders() {
  const body = document.getElementById('ordersBody');
  if (!body) return;
  try {
    const data = await api('v2/orders?limit=20&offset=0');
    const orders = data.payload?.orders || data.orders || [];

    if (orders.length === 0) {
      body.innerHTML = `<div class="cart-empty page"><div class="cart-empty-icon">üìã</div><div class="cart-empty-title">–ó–∞–∫–∞–∑–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç</div><div class="cart-empty-sub">–ü–æ—Å–ª–µ –ø–µ—Ä–≤–æ–≥–æ –∑–∞–∫–∞–∑–∞ –æ–Ω–∏ –ø–æ—è–≤—è—Ç—Å—è –∑–¥–µ—Å—å</div></div>`;
      return;
    }

    let html = `<div class="page" style="padding-top:12px">`;
    orders.forEach(o => {
      const status = o.status || '';
      const statusMap = {
        'active': ['–ê–∫—Ç–∏–≤–µ–Ω', 'status-active'],
        'in_progress': ['–í –ø—É—Ç–∏', 'status-active'],
        'delivered': ['–î–æ—Å—Ç–∞–≤–ª–µ–Ω', 'status-done'],
        'cancelled': ['–û—Ç–º–µ–Ω—ë–Ω', 'status-cancelled'],
      };
      const [slabel, scls] = statusMap[status] || [status, 'status-active'];
      const date = o.created_at ? new Date(o.created_at * 1000).toLocaleDateString('ru') : '';
      const total = o.total?.value || o.total || '';
      const itemNames = (o.items || []).map(i => i.name).join(', ');
      const placeName = o.place?.name || o.place_name || '';

      html += `
        <div class="order-card">
          <div class="order-card-header">
            <div class="order-card-name">${placeName}</div>
            <span class="order-status ${scls}">${slabel}</span>
          </div>
          <div class="order-card-meta">${date}${o.order_nr ? ' ¬∑ ‚Ññ' + o.order_nr : ''}</div>
          ${itemNames ? `<div class="order-card-items">${itemNames.slice(0,80)}</div>` : ''}
          ${total ? `<div class="order-card-total">${total} ‚ÇΩ</div>` : ''}
        </div>`;
    });
    html += `</div>`;
    body.innerHTML = html;
  } catch(e) {
    body.innerHTML = `<div class="no-results">‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∑–∞–∫–∞–∑—ã</div>`;
  }
}

// ‚îÄ‚îÄ PROFILE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderProfile() {
  const c = document.getElementById('content');
  const initials = USER_NAME ? USER_NAME.slice(0,2).toUpperCase() : '??';
  c.innerHTML = `
    <div class="page">
      <div class="profile-header">
        <div class="profile-avatar">${initials}</div>
        <div>
          <div class="profile-name">${USER_NAME || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å'}</div>
          <div class="profile-uid">UID: ${USER_UID || '‚Äî'}</div>
        </div>
      </div>
      <div style="background:var(--white);margin:12px 16px;border-radius:16px;overflow:hidden;box-shadow:0 2px 8px rgba(0,0,0,.06)">
        <div class="menu-list-item"><span class="menu-list-icon">üéÅ</span><span class="menu-list-text">–Ø–Ω–¥–µ–∫—Å –ü–ª—é—Å</span><span style="font-size:12px;color:${PLUS_TOKEN?'#34C759':'#999'}">${PLUS_TOKEN?'–ê–∫—Ç–∏–≤–µ–Ω':'–ù–µ—Ç'}</span></div>
        <div class="menu-list-item"><span class="menu-list-icon">üí≥</span><span class="menu-list-text">–ú–µ—Ç–æ–¥—ã –æ–ø–ª–∞—Ç—ã</span><span class="menu-list-arrow">‚Ä∫</span></div>
        <div class="menu-list-item"><span class="menu-list-icon">üìç</span><span class="menu-list-text">–ú–æ–∏ –∞–¥—Ä–µ—Å–∞</span><span class="menu-list-arrow">‚Ä∫</span></div>
        <div class="menu-list-item" onclick="goPage('orders')"><span class="menu-list-icon">üìã</span><span class="menu-list-text">–ò—Å—Ç–æ—Ä–∏—è –∑–∞–∫–∞–∑–æ–≤</span><span class="menu-list-arrow">‚Ä∫</span></div>
      </div>
      <div style="background:var(--white);margin:0 16px 12px;border-radius:16px;overflow:hidden;box-shadow:0 2px 8px rgba(0,0,0,.06)">
        <div class="menu-list-item"><span class="menu-list-icon">üîî</span><span class="menu-list-text">–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</span><span class="menu-list-arrow">‚Ä∫</span></div>
        <div class="menu-list-item"><span class="menu-list-icon">üîí</span><span class="menu-list-text">–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å</span><span class="menu-list-arrow">‚Ä∫</span></div>
        <div class="menu-list-item"><span class="menu-list-icon">‚ùì</span><span class="menu-list-text">–ü–æ–º–æ—â—å</span><span class="menu-list-arrow">‚Ä∫</span></div>
      </div>
      <div style="padding:8px 16px 24px">
        <div style="background:var(--white);border-radius:16px;padding:14px;box-shadow:0 2px 8px rgba(0,0,0,.06)">
          <div style="font-size:11px;color:var(--text-secondary);margin-bottom:6px;font-weight:600">–°–¢–ê–¢–£–° –°–ï–°–°–ò–ò</div>
          <div style="font-size:12px;color:#34C759;font-weight:600">‚úÖ –ê–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω —á–µ—Ä–µ–∑ –Ø–Ω–¥–µ–∫—Å</div>
          <div style="font-size:11px;color:var(--text-secondary);margin-top:4px">Token: ${TOKEN ? TOKEN.slice(0,20)+'...' : '‚Äî'}</div>
        </div>
      </div>
    </div>`;
}

// ‚îÄ‚îÄ ADDRESS MODAL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function openAddrModal() {
  document.getElementById('addrModal').classList.add('open');
  document.getElementById('addrInput').value = '';
  document.getElementById('suggestList').innerHTML = '';
  setTimeout(() => document.getElementById('addrInput').focus(), 300);
}

function closeAddrModal() {
  document.getElementById('addrModal').classList.remove('open');
}

document.getElementById('addrModal').addEventListener('click', e => {
  if (e.target === document.getElementById('addrModal')) closeAddrModal();
});

document.getElementById('addrInput').addEventListener('input', e => {
  clearTimeout(suggestTimer);
  const q = e.target.value;
  if (q.length < 2) { document.getElementById('suggestList').innerHTML = ''; return; }
  suggestTimer = setTimeout(() => loadSuggests(q), 300);
});

async function loadSuggests(q) {
  const list = document.getElementById('suggestList');
  try {
    const r = await fetch(`${PROXY}/proxy-suggest`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'X-Chat-Id': CHAT_ID },
      body: JSON.stringify({ text: q, lat: userLat, lon: userLon })
    });
    const data = await r.json();
    const items = data.results || data.features || [];
    list.innerHTML = items.slice(0, 6).map(item => {
      const title = item.title?.text || item.properties?.name || item.name || q;
      const sub = item.subtitle?.text || item.properties?.description || '';
      return `<div class="suggest-item" onclick="selectAddr('${encodeURIComponent(title)}')">
        <span class="suggest-icon">üìç</span>${title}${sub ? `<br><small style="color:var(--text-secondary)">${sub}</small>` : ''}
      </div>`;
    }).join('');
  } catch(e) {
    list.innerHTML = `<div class="suggest-item" onclick="selectAddr('${encodeURIComponent(q)}')">üìç ${q}</div>`;
  }
}

async function selectAddr(enc) {
  const addr = decodeURIComponent(enc);
  userAddress = addr;
  localStorage.setItem('eda_address', addr);

  // geocode
  try {
    const r = await fetch(`${PROXY}/proxy-geocode`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ text: addr })
    });
    const d = await r.json();
    const pos = d.response?.GeoObjectCollection?.featureMember?.[0]?.GeoObject?.Point?.pos;
    if (pos) {
      const [lon, lat] = pos.split(' ').map(Number);
      userLat = lat; userLon = lon;
      localStorage.setItem('eda_lat', lat); localStorage.setItem('eda_lon', lon);
    }
  } catch(e) {}

  closeAddrModal();
  const lbl = document.getElementById('addrLabel');
  if (lbl) lbl.textContent = addr;
  menuCache = {};
  restaurants = [];
  loadHomeContent();
  toast(`üìç –ê–¥—Ä–µ—Å: ${addr}`);
}

// ‚îÄ‚îÄ INIT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function init() {
  // Hidde splash
  setTimeout(() => {
    document.getElementById('splash').classList.add('hide');
    setTimeout(() => document.getElementById('splash').remove(), 400);
  }, 1200);

  if (!TOKEN && !CHAT_ID) {
    document.getElementById('content').innerHTML = `
      <div class="success-page">
        <div style="font-size:64px">üîê</div>
        <div class="success-title">–ù–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω</div>
        <div class="success-sub">–û—Ç–∫—Ä–æ–π—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —á–µ—Ä–µ–∑ Telegram –±–æ—Ç–∞</div>
      </div>`;
    return;
  }

  renderHome();
}

init();
</script>
</body>
</html>
