<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>–Ø–Ω–¥–µ–∫—Å –ï–¥–∞</title>
<style>
  :root {
    --yellow: #FFE033;
    --yellow-dark: #F5C800;
    --black: #1A1A1A;
    --gray-bg: #F5F5F5;
    --gray-text: #8C8C8C;
    --gray-border: #E8E8E8;
    --green: #029154;
    --red: #E63946;
    --safe-top: env(safe-area-inset-top, 0px);
    --safe-bot: env(safe-area-inset-bottom, 0px);
  }
  * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
  html, body { height: 100%; overflow: hidden; font-family: -apple-system, 'SF Pro Display', 'Helvetica Neue', sans-serif; background: var(--gray-bg); }
  #app { height: 100dvh; display: flex; flex-direction: column; overflow: hidden; position: relative; }
  .topbar { background: var(--yellow); padding: calc(var(--safe-top) + 12px) 16px 12px; flex-shrink: 0; position: relative; z-index: 100; }
  .topbar-inner { display: flex; align-items: center; gap: 10px; }
  .logo { font-size: 22px; font-weight: 900; color: var(--black); }
  .address-btn { flex: 1; display: flex; align-items: center; gap: 6px; background: rgba(0,0,0,0.08); border-radius: 12px; padding: 8px 12px; cursor: pointer; border: none; text-align: left; min-width: 0; }
  .address-btn-text { font-size: 13px; font-weight: 600; color: var(--black); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .profile-btn { width: 36px; height: 36px; border-radius: 50%; background: rgba(0,0,0,0.1); border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 18px; flex-shrink: 0; }
  .tabs { background: var(--yellow); display: flex; padding: 0 16px 12px; gap: 8px; flex-shrink: 0; }
  .tab-btn { padding: 7px 16px; border-radius: 20px; border: none; font-size: 13px; font-weight: 600; cursor: pointer; transition: all 0.2s; }
  .tab-btn.active { background: var(--black); color: white; }
  .tab-btn:not(.active) { background: rgba(0,0,0,0.08); color: var(--black); }
  .content { flex: 1; overflow-y: auto; overflow-x: hidden; -webkit-overflow-scrolling: touch; overscroll-behavior: contain; }
  .content::-webkit-scrollbar { display: none; }
  .screen { display: none; }
  .screen.active { display: block; }
  .search-wrap { padding: 12px 16px 8px; }
  .search-box { display: flex; align-items: center; gap: 8px; background: white; border-radius: 14px; padding: 10px 14px; box-shadow: 0 1px 4px rgba(0,0,0,0.06); }
  .search-input { flex: 1; border: none; outline: none; font-size: 15px; background: transparent; }
  .search-input::placeholder { color: #B0B0B0; }
  .banners { display: flex; gap: 12px; padding: 12px 16px; overflow-x: auto; scrollbar-width: none; }
  .banners::-webkit-scrollbar { display: none; }
  .banner { min-width: 260px; height: 110px; border-radius: 20px; display: flex; align-items: flex-end; padding: 14px; flex-shrink: 0; cursor: pointer; position: relative; overflow: hidden; transition: transform 0.15s; }
  .banner:active { transform: scale(0.97); }
  .banner-1 { background: linear-gradient(135deg, #FF6B35, #FF3D3D); }
  .banner-2 { background: linear-gradient(135deg, #6C5CE7, #a29bfe); }
  .banner-3 { background: linear-gradient(135deg, #00B894, #00CEC9); }
  .banner-text { color: white; font-weight: 800; font-size: 15px; line-height: 1.2; }
  .banner-emoji { position: absolute; right: 14px; top: 14px; font-size: 42px; }
  .cats { display: flex; gap: 10px; padding: 4px 16px 12px; overflow-x: auto; scrollbar-width: none; }
  .cats::-webkit-scrollbar { display: none; }
  .cat-btn { display: flex; flex-direction: column; align-items: center; gap: 4px; background: white; border-radius: 16px; padding: 10px 14px; min-width: 72px; border: none; cursor: pointer; box-shadow: 0 1px 4px rgba(0,0,0,0.06); transition: all 0.15s; }
  .cat-btn:active { transform: scale(0.94); }
  .cat-btn.active { background: var(--black); }
  .cat-btn.active .cat-name { color: white; }
  .cat-emoji { font-size: 26px; }
  .cat-name { font-size: 11px; font-weight: 600; color: var(--black); white-space: nowrap; }
  .restaurants { padding: 4px 16px; display: flex; flex-direction: column; gap: 14px; }
  .rest-card { background: white; border-radius: 20px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.06); cursor: pointer; transition: transform 0.15s; }
  .rest-card:active { transform: scale(0.98); }
  .rest-img-placeholder { width: 100%; height: 150px; display: flex; align-items: center; justify-content: center; font-size: 60px; position: relative; }
  .rest-badge { position: absolute; top: 10px; left: 10px; font-size: 11px; font-weight: 700; padding: 3px 8px; border-radius: 8px; }
  .rest-badge.free { background: var(--green); color: white; }
  .rest-info { padding: 12px 14px; }
  .rest-name { font-size: 16px; font-weight: 700; color: var(--black); margin-bottom: 5px; }
  .rest-meta { display: flex; align-items: center; gap: 10px; flex-wrap: wrap; }
  .rest-rating { font-size: 13px; font-weight: 600; color: var(--black); }
  .rest-time { font-size: 13px; color: var(--gray-text); font-weight: 500; }
  .rest-delivery { font-size: 13px; font-weight: 600; color: var(--green); }
  .rest-tags { display: flex; gap: 6px; margin-top: 6px; flex-wrap: wrap; }
  .rest-tag { font-size: 11px; color: var(--gray-text); background: var(--gray-bg); border-radius: 6px; padding: 2px 7px; }
  .menu-hero { position: relative; }
  .menu-hero-img { width: 100%; height: 200px; display: flex; align-items: center; justify-content: center; font-size: 70px; }
  .menu-back { position: absolute; top: calc(var(--safe-top) + 12px); left: 12px; width: 38px; height: 38px; border-radius: 50%; background: white; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 18px; box-shadow: 0 2px 8px rgba(0,0,0,0.15); }
  .menu-rest-info { padding: 14px 16px 10px; background: white; }
  .menu-rest-name { font-size: 22px; font-weight: 800; color: var(--black); margin-bottom: 6px; letter-spacing: -0.3px; }
  .menu-rest-meta { display: flex; align-items: center; gap: 8px; flex-wrap: wrap; }
  .menu-rest-badge { font-size: 12px; font-weight: 600; padding: 3px 10px; border-radius: 10px; }
  .menu-rest-badge.delivery { background: #E8F8EE; color: var(--green); }
  .menu-rest-badge.time { background: #FFF5D0; color: #B8860B; }
  .menu-cats-scroll { display: flex; gap: 8px; padding: 10px 16px; overflow-x: auto; scrollbar-width: none; border-top: 1px solid var(--gray-border); background: white; position: sticky; top: 0; z-index: 50; }
  .menu-cats-scroll::-webkit-scrollbar { display: none; }
  .menu-cat-tab { padding: 6px 14px; border-radius: 20px; border: none; font-size: 13px; font-weight: 600; cursor: pointer; white-space: nowrap; transition: all 0.15s; }
  .menu-cat-tab.active { background: var(--black); color: white; }
  .menu-cat-tab:not(.active) { background: var(--gray-bg); color: var(--black); }
  .menu-section { padding: 16px 16px 0; }
  .menu-section-title { font-size: 18px; font-weight: 800; color: var(--black); margin-bottom: 12px; }
  .menu-items { display: flex; flex-direction: column; gap: 10px; margin-bottom: 20px; }
  .menu-item { background: white; border-radius: 16px; padding: 12px; display: flex; gap: 12px; align-items: flex-start; box-shadow: 0 1px 4px rgba(0,0,0,0.05); cursor: pointer; transition: transform 0.1s; }
  .menu-item:active { transform: scale(0.98); }
  .menu-item-img { width: 88px; height: 88px; border-radius: 12px; flex-shrink: 0; background: var(--gray-bg); display: flex; align-items: center; justify-content: center; font-size: 36px; overflow: hidden; }
  .menu-item-img img { width: 100%; height: 100%; object-fit: cover; }
  .menu-item-body { flex: 1; min-width: 0; }
  .menu-item-name { font-size: 14px; font-weight: 700; color: var(--black); margin-bottom: 4px; line-height: 1.3; }
  .menu-item-desc { font-size: 12px; color: var(--gray-text); line-height: 1.4; margin-bottom: 6px; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
  .menu-item-weight { font-size: 11px; color: #B0B0B0; font-weight: 500; margin-bottom: 6px; }
  .menu-item-footer { display: flex; align-items: center; justify-content: space-between; }
  .menu-item-price { font-size: 15px; font-weight: 800; color: var(--black); }
  .add-btn { width: 32px; height: 32px; border-radius: 10px; background: var(--yellow); border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 20px; font-weight: 700; transition: all 0.15s; flex-shrink: 0; }
  .add-btn:active { transform: scale(0.88); }
  .qty-ctrl { display: flex; align-items: center; gap: 8px; }
  .qty-btn { width: 30px; height: 30px; border-radius: 8px; background: var(--gray-bg); border: none; cursor: pointer; font-size: 18px; font-weight: 700; display: flex; align-items: center; justify-content: center; color: var(--black); }
  .qty-num { font-size: 15px; font-weight: 800; min-width: 20px; text-align: center; }
  .cart-empty { display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 80px 32px; text-align: center; gap: 16px; }
  .cart-empty-icon { font-size: 64px; }
  .cart-empty-title { font-size: 20px; font-weight: 800; color: var(--black); }
  .cart-empty-sub { font-size: 14px; color: var(--gray-text); }
  .cart-go-btn { margin-top: 8px; background: var(--yellow); color: var(--black); border: none; border-radius: 14px; padding: 14px 28px; font-size: 15px; font-weight: 700; cursor: pointer; }
  .cart-content { padding: 16px; }
  .cart-rest-name { font-size: 13px; color: var(--gray-text); font-weight: 500; margin-bottom: 12px; }
  .cart-items { display: flex; flex-direction: column; gap: 10px; margin-bottom: 16px; }
  .cart-item { background: white; border-radius: 16px; padding: 12px; display: flex; gap: 10px; align-items: center; box-shadow: 0 1px 4px rgba(0,0,0,0.05); }
  .cart-item-emoji { font-size: 32px; width: 48px; height: 48px; display: flex; align-items: center; justify-content: center; background: var(--gray-bg); border-radius: 10px; flex-shrink: 0; }
  .cart-item-body { flex: 1; min-width: 0; }
  .cart-item-name { font-size: 13px; font-weight: 700; color: var(--black); margin-bottom: 2px; line-height: 1.3; }
  .cart-item-opt { font-size: 11px; color: var(--gray-text); }
  .cart-qty-btn { width: 26px; height: 26px; border-radius: 7px; background: var(--gray-bg); border: none; cursor: pointer; font-size: 16px; font-weight: 700; color: var(--black); display: flex; align-items: center; justify-content: center; }
  .cart-qty-num { font-size: 14px; font-weight: 800; min-width: 18px; text-align: center; }
  .cart-promo { background: white; border-radius: 16px; padding: 14px; margin-bottom: 14px; display: flex; gap: 10px; align-items: center; box-shadow: 0 1px 4px rgba(0,0,0,0.05); }
  .promo-input { flex: 1; border: none; outline: none; font-size: 14px; background: transparent; }
  .promo-apply-btn { background: var(--yellow); border: none; border-radius: 10px; padding: 8px 14px; font-size: 13px; font-weight: 700; color: var(--black); cursor: pointer; }
  .cart-summary { background: white; border-radius: 16px; padding: 16px; margin-bottom: 14px; box-shadow: 0 1px 4px rgba(0,0,0,0.05); }
  .summary-row { display: flex; justify-content: space-between; margin-bottom: 10px; }
  .summary-row:last-child { margin-bottom: 0; }
  .summary-label { font-size: 14px; color: var(--gray-text); }
  .summary-value { font-size: 14px; font-weight: 600; color: var(--black); }
  .summary-total .summary-label, .summary-total .summary-value { font-size: 16px; font-weight: 800; color: var(--black); }
  .summary-divider { height: 1px; background: var(--gray-border); margin: 10px 0; }
  .summary-free { color: var(--green); }
  .checkout-btn { width: 100%; background: var(--yellow); color: var(--black); border: none; border-radius: 16px; padding: 16px; font-size: 16px; font-weight: 800; cursor: pointer; transition: all 0.15s; display: flex; align-items: center; justify-content: space-between; }
  .checkout-btn:active { transform: scale(0.98); }
  .checkout-section { background: white; border-radius: 20px; margin: 12px 16px; padding: 16px; box-shadow: 0 1px 4px rgba(0,0,0,0.05); }
  .checkout-section-title { font-size: 15px; font-weight: 800; color: var(--black); margin-bottom: 12px; }
  .checkout-row { display: flex; align-items: center; gap: 12px; padding: 10px 0; border-bottom: 1px solid var(--gray-border); cursor: pointer; }
  .checkout-row:last-child { border-bottom: none; padding-bottom: 0; }
  .checkout-row-icon { font-size: 20px; width: 36px; height: 36px; background: var(--gray-bg); border-radius: 10px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
  .checkout-row-body { flex: 1; }
  .checkout-row-label { font-size: 12px; color: var(--gray-text); font-weight: 500; }
  .checkout-row-value { font-size: 14px; font-weight: 600; color: var(--black); }
  .pay-method { display: flex; gap: 8px; flex-wrap: wrap; }
  .pay-option { flex: 1; min-width: 80px; padding: 10px; border-radius: 12px; border: 2px solid var(--gray-border); text-align: center; cursor: pointer; transition: all 0.15s; }
  .pay-option.selected { border-color: var(--black); background: var(--black); color: white; }
  .pay-option-icon { font-size: 20px; margin-bottom: 2px; }
  .pay-option-name { font-size: 11px; font-weight: 600; }
  .place-order-btn { margin: 12px 16px; margin-bottom: calc(12px + var(--safe-bot)); width: calc(100% - 32px); background: var(--yellow); color: var(--black); border: none; border-radius: 16px; padding: 17px; font-size: 17px; font-weight: 800; cursor: pointer; transition: all 0.15s; display: block; }
  .place-order-btn:active { transform: scale(0.98); }
  .place-order-btn:disabled { opacity: 0.6; }
  .order-status { padding: 20px 16px; text-align: center; }
  .order-check { font-size: 64px; margin-bottom: 16px; }
  .order-title { font-size: 24px; font-weight: 900; color: var(--black); margin-bottom: 8px; letter-spacing: -0.4px; }
  .order-sub { font-size: 15px; color: var(--gray-text); margin-bottom: 24px; }
  .order-nr { background: white; border-radius: 16px; padding: 16px; box-shadow: 0 1px 4px rgba(0,0,0,0.06); margin-bottom: 12px; }
  .order-nr-label { font-size: 12px; color: var(--gray-text); font-weight: 500; margin-bottom: 4px; }
  .order-nr-value { font-size: 20px; font-weight: 900; color: var(--black); }
  .order-track { background: white; border-radius: 16px; padding: 20px; box-shadow: 0 1px 4px rgba(0,0,0,0.06); margin-bottom: 20px; }
  .track-step { display: flex; gap: 14px; align-items: flex-start; margin-bottom: 16px; position: relative; }
  .track-step:last-child { margin-bottom: 0; }
  .track-line { position: absolute; left: 14px; top: 30px; width: 2px; height: calc(100% + 4px); background: var(--gray-border); }
  .track-step:last-child .track-line { display: none; }
  .track-dot { width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 14px; flex-shrink: 0; z-index: 1; }
  .track-dot.done { background: var(--green); }
  .track-dot.active { background: var(--yellow); animation: pulse 1.5s infinite; }
  .track-dot.pending { background: var(--gray-border); }
  @keyframes pulse { 0%,100%{transform:scale(1)}50%{transform:scale(1.1)} }
  .track-label { font-size: 14px; font-weight: 700; color: var(--black); }
  .track-time { font-size: 12px; color: var(--gray-text); margin-top: 2px; }
  .track-text { padding-top: 4px; }
  .back-to-main { width: 100%; background: var(--yellow); color: var(--black); border: none; border-radius: 14px; padding: 15px; font-size: 15px; font-weight: 800; cursor: pointer; }
  .bottom-nav { display: flex; background: white; border-top: 1px solid var(--gray-border); padding: 8px 0 calc(8px + var(--safe-bot)); flex-shrink: 0; z-index: 100; }
  .nav-btn { flex: 1; display: flex; flex-direction: column; align-items: center; gap: 2px; border: none; background: transparent; cursor: pointer; padding: 4px 0; }
  .nav-icon { font-size: 22px; position: relative; display: inline-block; }
  .nav-label { font-size: 10px; font-weight: 600; color: var(--gray-text); }
  .nav-btn.active .nav-label { color: var(--black); }
  .cart-badge { position: absolute; top: -4px; right: -8px; background: var(--red); color: white; font-size: 9px; font-weight: 800; min-width: 16px; height: 16px; border-radius: 8px; display: flex; align-items: center; justify-content: center; padding: 0 3px; border: 2px solid white; }
  .loading-overlay { position: fixed; inset: 0; background: var(--yellow); display: flex; align-items: center; justify-content: center; z-index: 1000; transition: opacity 0.4s; flex-direction: column; gap: 12px; }
  .loading-logo { font-size: 42px; font-weight: 900; color: var(--black); }
  .loading-sub { font-size: 14px; color: rgba(0,0,0,0.4); font-weight: 500; }
  .toast { position: fixed; bottom: calc(80px + var(--safe-bot)); left: 50%; transform: translateX(-50%) translateY(20px); background: var(--black); color: white; border-radius: 14px; padding: 12px 20px; font-size: 14px; font-weight: 600; z-index: 500; opacity: 0; transition: all 0.3s; white-space: nowrap; pointer-events: none; max-width: 90vw; overflow: hidden; text-overflow: ellipsis; }
  .toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }
  .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 200; display: flex; align-items: flex-end; opacity: 0; pointer-events: none; transition: opacity 0.3s; }
  .modal-overlay.open { opacity: 1; pointer-events: all; }
  .modal { background: white; border-radius: 24px 24px 0 0; width: 100%; max-height: 90vh; overflow-y: auto; padding-bottom: calc(20px + var(--safe-bot)); transform: translateY(100%); transition: transform 0.35s cubic-bezier(0.34, 1.56, 0.64, 1); }
  .modal-overlay.open .modal { transform: translateY(0); }
  .modal-img { width: 100%; height: 220px; display: flex; align-items: center; justify-content: center; font-size: 80px; background: var(--gray-bg); border-radius: 24px 24px 0 0; overflow: hidden; position: relative; }
  .modal-img img { width: 100%; height: 100%; object-fit: cover; }
  .modal-close { position: absolute; top: 14px; right: 14px; width: 32px; height: 32px; border-radius: 50%; background: rgba(0,0,0,0.4); border: none; cursor: pointer; color: white; font-size: 16px; display: flex; align-items: center; justify-content: center; }
  .modal-body { padding: 20px 20px 0; }
  .modal-name { font-size: 22px; font-weight: 800; color: var(--black); margin-bottom: 8px; letter-spacing: -0.3px; }
  .modal-desc { font-size: 14px; color: var(--gray-text); line-height: 1.5; margin-bottom: 8px; }
  .modal-weight { font-size: 13px; color: #B0B0B0; margin-bottom: 18px; }
  .modal-opts-title { font-size: 15px; font-weight: 700; color: var(--black); margin-bottom: 10px; }
  .modal-opts { display: flex; flex-direction: column; gap: 8px; margin-bottom: 20px; }
  .modal-opt { display: flex; align-items: center; justify-content: space-between; padding: 10px 14px; border-radius: 12px; border: 2px solid var(--gray-border); cursor: pointer; transition: all 0.15s; }
  .modal-opt.selected { border-color: var(--black); background: #f8f8f8; }
  .modal-opt-name { font-size: 14px; font-weight: 500; }
  .modal-opt-price { font-size: 13px; color: var(--gray-text); font-weight: 600; }
  .modal-add-row { display: flex; align-items: center; gap: 12px; margin-top: 4px; }
  .modal-qty-ctrl { display: flex; align-items: center; gap: 12px; }
  .modal-qty-btn { width: 36px; height: 36px; border-radius: 10px; background: var(--gray-bg); border: none; cursor: pointer; font-size: 20px; font-weight: 700; color: var(--black); display: flex; align-items: center; justify-content: center; }
  .modal-qty-num { font-size: 18px; font-weight: 800; min-width: 24px; text-align: center; }
  .modal-add-btn { flex: 1; background: var(--yellow); color: var(--black); border: none; border-radius: 14px; padding: 15px; font-size: 15px; font-weight: 800; cursor: pointer; display: flex; align-items: center; justify-content: space-between; transition: all 0.15s; }
  .modal-add-btn:active { transform: scale(0.98); }
  .profile-header { background: var(--yellow); padding: calc(var(--safe-top) + 20px) 16px 24px; text-align: center; }
  .profile-avatar { width: 72px; height: 72px; border-radius: 50%; background: rgba(0,0,0,0.1); display: flex; align-items: center; justify-content: center; font-size: 32px; margin: 0 auto 12px; }
  .profile-name { font-size: 22px; font-weight: 800; color: var(--black); }
  .profile-uid { font-size: 13px; color: rgba(0,0,0,0.5); margin-top: 4px; }
  .profile-menu { padding: 16px; }
  .profile-item { background: white; border-radius: 16px; padding: 14px 16px; margin-bottom: 10px; display: flex; align-items: center; gap: 12px; cursor: pointer; box-shadow: 0 1px 4px rgba(0,0,0,0.05); }
  .profile-item-icon { font-size: 22px; width: 40px; text-align: center; }
  .profile-item-text { flex: 1; font-size: 15px; font-weight: 600; color: var(--black); }
  .screen-header { display: flex; align-items: center; gap: 10px; padding: calc(var(--safe-top) + 12px) 16px 12px; background: white; position: sticky; top: 0; z-index: 10; border-bottom: 1px solid var(--gray-border); }
  .back-btn { background: none; border: none; font-size: 24px; cursor: pointer; padding: 0; color: var(--black); line-height: 1; }
  .screen-hdr-title { font-size: 18px; font-weight: 800; color: var(--black); }
  .spinner { display: flex; justify-content: center; padding: 40px; }
  .spin { width: 32px; height: 32px; border: 3px solid var(--gray-border); border-top-color: var(--black); border-radius: 50%; animation: spin 0.8s linear infinite; }
  @keyframes spin { to{transform:rotate(360deg)} }
</style>
</head>
<body>

<div class="loading-overlay" id="loading">
  <div class="loading-logo">üçî –ï–¥–∞</div>
  <div class="loading-sub">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
</div>

<div class="toast" id="toast"></div>

<div class="modal-overlay" id="itemModal">
  <div class="modal">
    <div class="modal-img" id="modalImg">
      <button class="modal-close" onclick="closeModal()">‚úï</button>
    </div>
    <div class="modal-body">
      <div class="modal-name" id="modalName"></div>
      <div class="modal-desc" id="modalDesc"></div>
      <div class="modal-weight" id="modalWeight"></div>
      <div id="modalOptsWrap" style="display:none">
        <div class="modal-opts-title" id="modalOptsTitle"></div>
        <div class="modal-opts" id="modalOpts"></div>
      </div>
      <div class="modal-add-row">
        <div class="modal-qty-ctrl">
          <button class="modal-qty-btn" onclick="changeModalQty(-1)">‚àí</button>
          <span class="modal-qty-num" id="modalQty">1</span>
          <button class="modal-qty-btn" onclick="changeModalQty(1)">+</button>
        </div>
        <button class="modal-add-btn" onclick="addFromModal()">
          <span>–í –∫–æ—Ä–∑–∏–Ω—É</span>
          <span id="modalAddPrice"></span>
        </button>
      </div>
    </div>
  </div>
</div>

<div id="app">
  <div class="topbar" id="mainTopbar">
    <div class="topbar-inner">
      <div class="logo">–ï–¥–∞</div>
      <button class="address-btn" onclick="showToast('–°–º–µ–Ω–∞ –∞–¥—Ä–µ—Å–∞ —Å–∫–æ—Ä–æ')">
        <span>üìç</span>
        <span class="address-btn-text" id="addressText">–û–ø—Ä–µ–¥–µ–ª—è—é –∞–¥—Ä–µ—Å...</span>
        <span style="color:var(--black);opacity:0.4;margin-left:auto;">‚ñæ</span>
      </button>
      <button class="profile-btn" onclick="goTo('profile')">üë§</button>
    </div>
  </div>
  <div class="tabs" id="catalogTabs">
    <button class="tab-btn active" id="tab-online" onclick="selectTab('online',this)">–ó–∞–∫–∞–∑–∞—Ç—å</button>
    <button class="tab-btn" id="tab-offline" onclick="selectTab('offline',this)">–°—Ö–æ–¥–∏—Ç—å</button>
  </div>

  <div class="content" id="mainContent">

    <!-- CATALOG -->
    <div class="screen active" id="screen-catalog">
      <div class="search-wrap">
        <div class="search-box">
          <span>üîç</span>
          <input class="search-input" placeholder="–†–µ—Å—Ç–æ—Ä–∞–Ω –∏–ª–∏ –±–ª—é–¥–æ" id="searchInput" oninput="filterRestaurants(this.value)">
        </div>
      </div>
      <div class="banners">
        <div class="banner banner-1"><span class="banner-emoji">üî•</span><div class="banner-text">–ë–µ—Å–ø–ª–∞—Ç–Ω–∞—è<br>–¥–æ—Å—Ç–∞–≤–∫–∞</div></div>
        <div class="banner banner-2"><span class="banner-emoji">‚ö°</span><div class="banner-text">–ó–∞ 30 –º–∏–Ω—É—Ç<br>–∏–ª–∏ —Å–∫–∏–¥–∫–∞</div></div>
        <div class="banner banner-3"><span class="banner-emoji">üéÅ</span><div class="banner-text">–ù–æ–≤—ã–µ<br>—Ä–µ—Å—Ç–æ—Ä–∞–Ω—ã</div></div>
      </div>
      <div class="cats" id="catsList"></div>
      <div style="padding:4px 16px 10px;"><span style="font-size:20px;font-weight:800;color:var(--black);letter-spacing:-0.3px;">–†–µ—Å—Ç–æ—Ä–∞–Ω—ã</span></div>
      <div class="restaurants" id="restaurantsList"><div class="spinner"><div class="spin"></div></div></div>
      <div style="height:20px;"></div>
    </div>

    <!-- MENU -->
    <div class="screen" id="screen-menu">
      <div class="menu-hero">
        <div class="menu-hero-img" id="menuHeroImg"></div>
        <button class="menu-back" onclick="goTo('catalog')">‚Üê</button>
      </div>
      <div class="menu-rest-info">
        <div class="menu-rest-name" id="menuRestName"></div>
        <div class="menu-rest-meta" id="menuRestMeta"></div>
      </div>
      <div class="menu-cats-scroll" id="menuCatTabs"></div>
      <div id="menuItemsContainer"></div>
      <div style="height:24px;"></div>
    </div>

    <!-- CART -->
    <div class="screen" id="screen-cart">
      <div class="screen-header">
        <button class="back-btn" onclick="goTo('catalog')">‚Üê</button>
        <span class="screen-hdr-title">–ö–æ—Ä–∑–∏–Ω–∞</span>
      </div>
      <div class="cart-empty" id="cartEmpty">
        <div class="cart-empty-icon">üõí</div>
        <div class="cart-empty-title">–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞—è</div>
        <div class="cart-empty-sub">–î–æ–±–∞–≤—å—Ç–µ –±–ª—é–¥–∞ –∏–∑ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞</div>
        <button class="cart-go-btn" onclick="goTo('catalog')">–ö —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞–º</button>
      </div>
      <div id="cartFilled" style="display:none">
        <div class="cart-content">
          <div class="cart-rest-name" id="cartRestName"></div>
          <div class="cart-items" id="cartItemsList"></div>
          <div class="cart-promo">
            <span>üè∑Ô∏è</span>
            <input class="promo-input" placeholder="–ü—Ä–æ–º–æ–∫–æ–¥" id="promoInput">
            <button class="promo-apply-btn" onclick="applyPromo()">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
          </div>
          <div class="cart-summary">
            <div class="summary-row"><span class="summary-label">–¢–æ–≤–∞—Ä—ã</span><span class="summary-value" id="summaryItems">0 ‚ÇΩ</span></div>
            <div class="summary-row"><span class="summary-label">–î–æ—Å—Ç–∞–≤–∫–∞</span><span class="summary-value summary-free" id="summaryDelivery">–ë–µ—Å–ø–ª–∞—Ç–Ω–æ</span></div>
            <div class="summary-row"><span class="summary-label">–°–µ—Ä–≤–∏—Å–Ω—ã–π —Å–±–æ—Ä</span><span class="summary-value" id="summaryFee">0 ‚ÇΩ</span></div>
            <div class="summary-divider"></div>
            <div class="summary-row summary-total"><span class="summary-label">–ò—Ç–æ–≥–æ</span><span class="summary-value" id="summaryTotal">0 ‚ÇΩ</span></div>
          </div>
          <button class="checkout-btn" onclick="goTo('checkout')">
            <span>–û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑</span><span id="checkoutBtnTotal">0 ‚ÇΩ</span>
          </button>
        </div>
      </div>
    </div>

    <!-- CHECKOUT -->
    <div class="screen" id="screen-checkout">
      <div class="screen-header">
        <button class="back-btn" onclick="goTo('cart')">‚Üê</button>
        <span class="screen-hdr-title">–û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ</span>
      </div>
      <div class="checkout-section">
        <div class="checkout-section-title">üì¶ –î–æ—Å—Ç–∞–≤–∫–∞</div>
        <div class="checkout-row">
          <div class="checkout-row-icon">üìç</div>
          <div class="checkout-row-body">
            <div class="checkout-row-label">–ê–¥—Ä–µ—Å –¥–æ—Å—Ç–∞–≤–∫–∏</div>
            <div class="checkout-row-value" id="checkoutAddr">–ù–µ —É–∫–∞–∑–∞–Ω</div>
          </div>
          <div style="color:var(--gray-text);">‚Ä∫</div>
        </div>
        <div class="checkout-row">
          <div class="checkout-row-icon">‚è±Ô∏è</div>
          <div class="checkout-row-body">
            <div class="checkout-row-label">–í—Ä–µ–º—è –¥–æ—Å—Ç–∞–≤–∫–∏</div>
            <div class="checkout-row-value" id="checkoutTime">~30 –º–∏–Ω</div>
          </div>
          <div style="color:var(--gray-text);">‚Ä∫</div>
        </div>
      </div>
      <div class="checkout-section">
        <div class="checkout-section-title">üí≥ –û–ø–ª–∞—Ç–∞</div>
        <div class="pay-method">
          <div class="pay-option selected" onclick="selectPay(this,'sbp')"><div class="pay-option-icon">‚ö°</div><div class="pay-option-name">–°–ë–ü</div></div>
          <div class="pay-option" onclick="selectPay(this,'card')"><div class="pay-option-icon">üí≥</div><div class="pay-option-name">–ö–∞—Ä—Ç–∞</div></div>
          <div class="pay-option" onclick="selectPay(this,'cash')"><div class="pay-option-icon">üíµ</div><div class="pay-option-name">–ù–∞–ª–∏—á–Ω—ã–µ</div></div>
        </div>
      </div>
      <div class="checkout-section">
        <div class="checkout-section-title">üìù –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</div>
        <input id="checkoutComment" style="width:100%;border:1px solid var(--gray-border);border-radius:10px;padding:10px 12px;font-size:14px;outline:none;background:var(--gray-bg);" placeholder="–î–æ–º–æ—Ñ–æ–Ω, —ç—Ç–∞–∂, –ø–æ–∂–µ–ª–∞–Ω–∏—è...">
      </div>
      <div class="checkout-section">
        <div class="checkout-section-title">üßæ –°–æ—Å—Ç–∞–≤ –∑–∞–∫–∞–∑–∞</div>
        <div id="checkoutItems"></div>
        <div class="summary-divider"></div>
        <div class="summary-row summary-total" style="margin-top:10px;">
          <span class="summary-label">–ò—Ç–æ–≥–æ</span>
          <span class="summary-value" id="checkoutTotal">0 ‚ÇΩ</span>
        </div>
      </div>
      <button class="place-order-btn" id="placeOrderBtn" onclick="placeOrder()">
        –ó–∞–∫–∞–∑–∞—Ç—å ¬∑ <span id="placeOrderTotal">0 ‚ÇΩ</span>
      </button>
    </div>

    <!-- ORDER -->
    <div class="screen" id="screen-order">
      <div class="order-status">
        <div class="order-check">‚úÖ</div>
        <div class="order-title">–ó–∞–∫–∞–∑ –ø—Ä–∏–Ω—è—Ç!</div>
        <div class="order-sub">–†–µ—Å—Ç–æ—Ä–∞–Ω –Ω–∞—á–∞–ª –≥–æ—Ç–æ–≤–∏—Ç—å –≤–∞—à –∑–∞–∫–∞–∑</div>
        <div class="order-nr">
          <div class="order-nr-label">–ù–æ–º–µ—Ä –∑–∞–∫–∞–∑–∞</div>
          <div class="order-nr-value" id="orderNr">‚Äî</div>
        </div>
        <div class="order-track">
          <div class="track-step">
            <div class="track-dot done" id="step1dot">‚úì</div>
            <div class="track-line"></div>
            <div class="track-text"><div class="track-label">–ó–∞–∫–∞–∑ –ø—Ä–∏–Ω—è—Ç</div><div class="track-time" id="step1time"></div></div>
          </div>
          <div class="track-step">
            <div class="track-dot active" id="step2dot">üç≥</div>
            <div class="track-line"></div>
            <div class="track-text"><div class="track-label">–†–µ—Å—Ç–æ—Ä–∞–Ω –≥–æ—Ç–æ–≤–∏—Ç</div><div class="track-time" id="step2time">~20 –º–∏–Ω</div></div>
          </div>
          <div class="track-step">
            <div class="track-dot pending" id="step3dot">üõµ</div>
            <div class="track-line"></div>
            <div class="track-text"><div class="track-label">–ö—É—Ä—å–µ—Ä –≤ –ø—É—Ç–∏</div><div class="track-time" id="step3time"></div></div>
          </div>
          <div class="track-step">
            <div class="track-dot pending" id="step4dot">üéâ</div>
            <div class="track-text"><div class="track-label">–î–æ—Å—Ç–∞–≤–ª–µ–Ω–æ</div><div class="track-time" id="step4time"></div></div>
          </div>
        </div>
        <button class="back-to-main" onclick="goTo('catalog');clearCart();">–ù–∞ –≥–ª–∞–≤–Ω—É—é</button>
      </div>
    </div>

    <!-- PROFILE -->
    <div class="screen" id="screen-profile">
      <div class="profile-header">
        <div style="display:flex;justify-content:flex-start;margin-bottom:12px;">
          <button class="back-btn" onclick="goTo('catalog')">‚Üê</button>
        </div>
        <div class="profile-avatar">üë§</div>
        <div class="profile-name" id="profileName">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
        <div class="profile-uid" id="profileUid"></div>
      </div>
      <div class="profile-menu">
        <div class="profile-item" onclick="showToast('–†–∞–∑–¥–µ–ª –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ')"><span class="profile-item-icon">üì¶</span><span class="profile-item-text">–ú–æ–∏ –∑–∞–∫–∞–∑—ã</span><span>‚Ä∫</span></div>
        <div class="profile-item" onclick="showToast('–†–∞–∑–¥–µ–ª –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ')"><span class="profile-item-icon">üìç</span><span class="profile-item-text">–ê–¥—Ä–µ—Å–∞ –¥–æ—Å—Ç–∞–≤–∫–∏</span><span>‚Ä∫</span></div>
        <div class="profile-item" onclick="showToast('–†–∞–∑–¥–µ–ª –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ')"><span class="profile-item-icon">üí≥</span><span class="profile-item-text">–°–ø–æ—Å–æ–±—ã –æ–ø–ª–∞—Ç—ã</span><span>‚Ä∫</span></div>
        <div class="profile-item" onclick="showToast('–†–∞–∑–¥–µ–ª –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ')"><span class="profile-item-icon">üè∑Ô∏è</span><span class="profile-item-text">–ü—Ä–æ–º–æ–∫–æ–¥—ã –∏ –±–æ–Ω—É—Å—ã</span><span>‚Ä∫</span></div>
        <div class="profile-item" onclick="showToast('–†–∞–∑–¥–µ–ª –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ')"><span class="profile-item-icon">üí¨</span><span class="profile-item-text">–ü–æ–¥–¥–µ—Ä–∂–∫–∞</span><span>‚Ä∫</span></div>
      </div>
    </div>

  </div>

  <div class="bottom-nav" id="bottomNav">
    <button class="nav-btn active" id="nav-catalog" onclick="goTo('catalog')">
      <span class="nav-icon">üè†</span><span class="nav-label">–ì–ª–∞–≤–Ω–∞—è</span>
    </button>
    <button class="nav-btn" id="nav-cart" onclick="goTo('cart')">
      <span class="nav-icon">üõí<span class="cart-badge" id="cartBadge"></span></span>
      <span class="nav-label">–ö–æ—Ä–∑–∏–Ω–∞</span>
    </button>
    <button class="nav-btn" id="nav-profile" onclick="goTo('profile')">
      <span class="nav-icon">üë§</span><span class="nav-label">–ü—Ä–æ—Ñ–∏–ª—å</span>
    </button>
  </div>
</div>

<script>
// ‚îÄ‚îÄ‚îÄ –ü–ê–†–ê–ú–ï–¢–†–´ (–±–æ—Ç –ø–µ—Ä–µ–¥–∞—ë—Ç —á–µ—Ä–µ–∑ URL) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const _p         = new URLSearchParams(location.search);
const TOKEN      = _p.get('token')     || '';
const DEVICE_ID  = _p.get('device_id') || '9B57D76B-908D-4504-915D-381D08676F44';
const PROXY_BASE = _p.get('proxy')     || 'http://localhost:8888';
const LAT = 56.34750920385357, LON = 43.934390690686854;
const CLIENT_SESSION = crypto.randomUUID();

// –ó–∞–≥–æ–ª–æ–≤–∫–∏ ‚Üí –Ω–∞—à –ø—Ä–æ–∫—Å–∏ ‚Üí –¥–æ–±–∞–≤–ª—è–µ—Ç –º–æ–±–∏–ª—å–Ω—ã–π UA ‚Üí –Ø–Ω–¥–µ–∫—Å –≤–∏–¥–∏—Ç –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
const HDRS = {
  'Content-Type':     'application/json',
  'X-Bearer':         TOKEN,
  'X-Device-Id':      DEVICE_ID,
  'X-Client-Session': CLIENT_SESSION,
};

let cart = {}, currentRest = null, currentScreen = 'catalog';
let modalItem = null, modalQty = 1, selectedOpt = null;
let selectedPay = 'sbp', profile = null;
let RESTS = [];

const CATS = [
  {e:'üçî',n:'–ë—É—Ä–≥–µ—Ä—ã'},{e:'üç£',n:'–°—É—à–∏'},{e:'üçï',n:'–ü–∏—Ü—Ü–∞'},
  {e:'üçó',n:'–ö—É—Ä–∏—Ü–∞'},{e:'ü•ó',n:'–ó–¥–æ—Ä–æ–≤–æ–µ'},{e:'üçú',n:'–ê–∑–∏—è'},
  {e:'üåÆ',n:'–§–∞—Å—Ç—Ñ—É–¥'},{e:'üç¶',n:'–î–µ—Å–µ—Ä—Ç—ã'}
];

// ‚îÄ‚îÄ‚îÄ –ì–õ–ê–í–ù–´–ô API –ú–ï–¢–û–î ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// –í—Å–µ –∑–∞–ø—Ä–æ—Å—ã –∏–¥—É—Ç —á–µ—Ä–µ–∑ –ø—Ä–æ–∫—Å–∏ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
// –ü—Ä–æ–∫—Å–∏ –¥–æ–±–∞–≤–ª—è–µ—Ç: User-Agent: Eats-iOS(8.94.0) com.appkode.foodfox/8.94.0...
// –Ø–Ω–¥–µ–∫—Å –≤–∏–¥–∏—Ç –Ω–∞—Ç–∏–≤–Ω–æ–µ iOS –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ ‚Üí –ø—Ä–æ–º–æ–∫–æ–¥—ã –∏ –≤—Å–µ —Ñ–∏—á–∏ —Ä–∞–±–æ—Ç–∞—é—Ç
async function api(path, body, method='POST') {
  try {
    const opts = { method, headers: HDRS };
    if (body) opts.body = JSON.stringify(body);
    const r = await fetch(PROXY_BASE + '/proxy' + path, opts);
    if (!r.ok) { console.warn('[API]', path, r.status); return null; }
    return await r.json();
  } catch(e) { console.error('[API]', path, e); return null; }
}

// ‚îÄ‚îÄ‚îÄ INIT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
window.addEventListener('load', async () => {
  document.getElementById('catsList').innerHTML = CATS.map((c,i) =>
    `<button class="cat-btn ${i===0?'active':''}" onclick="filterByCat(this,'${c.n}')">
      <span class="cat-emoji">${c.e}</span><span class="cat-name">${c.n}</span>
    </button>`
  ).join('');

  if (TOKEN) {
    loadProfile();
    loadRestaurants();
  } else {
    document.getElementById('restaurantsList').innerHTML =
      '<div style="text-align:center;padding:60px 32px;color:var(--gray-text);font-size:15px;">–í–æ–π–¥–∏—Ç–µ —á–µ—Ä–µ–∑ –±–æ—Ç–∞ —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å —Ä–µ—Å—Ç–æ—Ä–∞–Ω—ã</div>';
  }

  document.getElementById('addressText').textContent = TOKEN ? '–ú–æ–π –∞–¥—Ä–µ—Å' : '–£–∫–∞–∂–∏—Ç–µ –∞–¥—Ä–µ—Å';
  setTimeout(() => {
    const lo = document.getElementById('loading');
    lo.style.opacity = '0';
    setTimeout(() => lo.style.display = 'none', 400);
  }, 800);
});

// ‚îÄ‚îÄ‚îÄ –ü–†–û–§–ò–õ–¨ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function loadProfile() {
  const d = await api('/eats/v1/eats-launch/v1/welcome-features', {
    location: { latitude: LAT, longitude: LON },
    shipping_type: 'delivery',
  });
  if (d && d.user) {
    profile = d.user;
    document.getElementById('profileName').textContent = profile.name || profile.login || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';
    document.getElementById('profileUid').textContent  = profile.uid ? 'UID: ' + profile.uid : '';
  } else {
    // –ü—Ä–æ–±—É–µ–º launch v2
    const d2 = await api('/eats/v1/launch/v2/native', {
      experiments: {
        consumer: 'eda_ab_service',
        args: [
          {name:'application', type:'string', value:'eda_ios_app'},
          {name:'version',     type:'application_version', value:'8.94.0'},
          {name:'device_id',   type:'string', value: DEVICE_ID},
        ],
        user_agent: 'Eats-iOS(8.94.0) com.appkode.foodfox/8.94.0 (Apple; iPhone17,1; iOS 17.5)',
      }
    });
    if (d2 && d2.profile) {
      profile = d2.profile;
      document.getElementById('profileName').textContent = profile.name || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';
      document.getElementById('profileUid').textContent  = 'UID: ' + (profile.passport_uid || '‚Äî');
    } else {
      document.getElementById('profileName').textContent = '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';
      document.getElementById('profileUid').textContent  = TOKEN ? TOKEN.slice(0,20)+'...' : '';
    }
  }
}

// ‚îÄ‚îÄ‚îÄ –†–ï–°–¢–û–†–ê–ù–´ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function loadRestaurants() {
  document.getElementById('restaurantsList').innerHTML = '<div class="spinner"><div class="spin"></div></div>';

  // –û—Å–Ω–æ–≤–Ω–æ–π –∑–∞–ø—Ä–æ—Å ‚Äî layout-constructor –∫–∞–∫ –≤ —Å–Ω–∏—Ñ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
  const d = await api('/eats/v1/layout-constructor/v1/layout', {
    location:      { latitude: LAT, longitude: LON },
    filters:       [],
    page:          { limit: 40, offset: 0 },
    shipping_type: 'delivery',
  });

  if (d && d.payload && d.payload.foundPlaces && d.payload.foundPlaces.length) {
    RESTS = d.payload.foundPlaces.map(p => {
      const pl = p.place || {};
      return {
        slug:         pl.slug || '',
        name:         pl.name || '‚Äî',
        imageUrl:     pl.pictureUrl || pl.headerImageUrl || '',
        bg:           'linear-gradient(135deg,#FFE033,#F5C800)',
        rating:       pl.rating ? String(pl.rating) : '',
        time:         pl.deliveryTime ? String(pl.deliveryTime) : '',
        freeDelivery: pl.deliveryCost === 0,
        tags:         (pl.categories||[]).map(c=>c.name||c).filter(Boolean),
      };
    });
    renderRests(RESTS);
    return;
  }

  // Fallback ‚Äî multi-carts catalog
  const d2 = await api(`/eats/v1/cart/v2/multi-carts?screen=catalog&longitude=${LON}&latitude=${LAT}&soft_multi=true`, {});
  if (d2) {
    // –ï—Å–ª–∏ –∏ —ç—Ç–æ –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª–æ ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
  }

  document.getElementById('restaurantsList').innerHTML =
    '<div style="text-align:center;padding:40px;color:var(--gray-text);">–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ä–µ—Å—Ç–æ—Ä–∞–Ω—ã.<br>–ü—Ä–æ–≤–µ—Ä—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ.</div>';
}

// ‚îÄ‚îÄ‚îÄ –§–ò–õ–¨–¢–†–´ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function filterByCat(btn, cat) {
  document.querySelectorAll('.cat-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  const q = cat.toLowerCase();
  const f = RESTS.filter(r => r.tags.some(t => t.toLowerCase().includes(q)));
  renderRests(f.length ? f : RESTS);
}

function filterRestaurants(q) {
  if (!q) { renderRests(RESTS); return; }
  q = q.toLowerCase();
  renderRests(RESTS.filter(r =>
    r.name.toLowerCase().includes(q) ||
    r.tags.some(t => t.toLowerCase().includes(q))
  ));
}

// ‚îÄ‚îÄ‚îÄ –†–ï–ù–î–ï–† –†–ï–°–¢–û–†–ê–ù–û–í ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderRests(list) {
  const el = document.getElementById('restaurantsList');
  if (!list.length) {
    el.innerHTML = '<div style="text-align:center;padding:40px;color:var(--gray-text);">–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ üîç</div>';
    return;
  }
  el.innerHTML = list.map(r => `
    <div class="rest-card" onclick="openRest('${r.slug}')">
      <div class="rest-img-placeholder" style="background:${r.bg};overflow:hidden;">
        ${r.imageUrl
          ? `<img src="${r.imageUrl}" style="width:100%;height:100%;object-fit:cover;" onerror="this.style.display='none'">`
          : '<span style="font-size:60px">üçΩÔ∏è</span>'}
        ${r.freeDelivery ? '<div class="rest-badge free">–ë–µ—Å–ø–ª–∞—Ç–Ω–æ</div>' : ''}
      </div>
      <div class="rest-info">
        <div class="rest-name">${r.name}</div>
        <div class="rest-meta">
          ${r.rating ? `<span class="rest-rating">‚òÖ ${r.rating}</span>` : ''}
          ${r.time   ? `<span class="rest-time">‚è± ${r.time} –º–∏–Ω</span>` : ''}
          ${r.freeDelivery ? '<span class="rest-delivery">–ë–µ—Å–ø–ª–∞—Ç–Ω–∞—è –¥–æ—Å—Ç–∞–≤–∫–∞</span>' : ''}
        </div>
        <div class="rest-tags">${r.tags.slice(0,3).map(t=>`<span class="rest-tag">${t}</span>`).join('')}</div>
      </div>
    </div>
  `).join('');
}

// ‚îÄ‚îÄ‚îÄ –û–¢–ö–†–´–¢–¨ –†–ï–°–¢–û–†–ê–ù / –ú–ï–ù–Æ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function openRest(slug) {
  currentRest = RESTS.find(r => r.slug === slug);
  if (!currentRest) return;
  goTo('menu');

  // –†–∏—Å—É–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ —Å—Ä–∞–∑—É
  document.getElementById('menuRestName').textContent = currentRest.name;
  document.getElementById('menuHeroImg').innerHTML = currentRest.imageUrl
    ? `<img src="${currentRest.imageUrl}" style="width:100%;height:100%;object-fit:cover;">`
    : `<span style="font-size:70px">üçΩÔ∏è</span>`;
  document.getElementById('menuRestMeta').innerHTML = `
    ${currentRest.freeDelivery ? '<span class="menu-rest-badge delivery">–ë–µ—Å–ø–ª–∞—Ç–Ω–∞—è –¥–æ—Å—Ç–∞–≤–∫–∞</span>' : ''}
    ${currentRest.time   ? `<span class="menu-rest-badge time">‚è± ${currentRest.time} –º–∏–Ω</span>` : ''}
    ${currentRest.rating ? `<span class="menu-rest-badge time">‚òÖ ${currentRest.rating}</span>` : ''}
  `;
  document.getElementById('menuCatTabs').innerHTML = '';
  document.getElementById('menuItemsContainer').innerHTML = '<div class="spinner"><div class="spin"></div></div>';

  // –ó–∞–≥—Ä—É–∂–∞–µ–º –º–µ–Ω—é —Å —Ä–µ–∞–ª—å–Ω–æ–≥–æ API
  const d = await api(`/api/v2/catalog/${slug}/menu`, {
    latitude: LAT, longitude: LON, shipping_type: 'delivery'
  });

  if (!d || !d.payload || !d.payload.categories) {
    document.getElementById('menuItemsContainer').innerHTML =
      '<div style="text-align:center;padding:40px;color:var(--gray-text);">–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –º–µ–Ω—é</div>';
    return;
  }

  // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –∏ –ø–æ–∑–∏—Ü–∏–∏
  currentRest.cats = d.payload.categories.map(cat => ({
    n:     cat.name,
    items: (cat.items || []).map(item => ({
      id:  item.id,
      n:   item.name,
      d:   item.description || '',
      p:   item.price ? Math.round(item.price / 100) : 0,
      w:   item.weight || item.weightInGrams ? (item.weightInGrams||'') + ' –≥' : '',
      e:   'üçΩÔ∏è',
      img: item.pictureUrl || item.headerImageUrl || '',
      opts: (item.options||[]).map(og => ({
        g: og.name,
        i: (og.options||[]).map(o => ({
          id: o.id, n: o.name, p: o.price ? Math.round(o.price/100) : 0
        }))
      })),
    }))
  }));

  // –†–µ–Ω–¥–µ—Ä–∏–º —Ç–∞–±—ã –∫–∞—Ç–µ–≥–æ—Ä–∏–π
  document.getElementById('menuCatTabs').innerHTML = currentRest.cats.map((c,i) =>
    `<button class="menu-cat-tab ${i===0?'active':''}" onclick="scrollCat(${i},this)">${c.n}</button>`
  ).join('');

  // –†–µ–Ω–¥–µ—Ä–∏–º –ø–æ–∑–∏—Ü–∏–∏
  document.getElementById('menuItemsContainer').innerHTML =
    currentRest.cats.map((cat, ci) => `
      <div class="menu-section" id="ms${ci}">
        <div class="menu-section-title">${cat.n}</div>
        <div class="menu-items">${cat.items.map(item => renderMenuItem(item)).join('')}</div>
      </div>
    `).join('') + '<div style="height:80px;"></div>';
}

function renderMenuItem(item) {
  const q = getQty(item.id);
  return `
    <div class="menu-item" onclick='openModal(${JSON.stringify(item).replace(/'/g,"&#39;")})'>
      <div class="menu-item-img">
        ${item.img
          ? `<img src="${item.img}" style="width:100%;height:100%;object-fit:cover;border-radius:12px;" onerror="this.parentElement.textContent='üçΩÔ∏è'">`
          : item.e}
      </div>
      <div class="menu-item-body">
        <div class="menu-item-name">${item.n}</div>
        ${item.d ? `<div class="menu-item-desc">${item.d}</div>` : ''}
        ${item.w ? `<div class="menu-item-weight">${item.w}</div>` : ''}
        <div class="menu-item-footer">
          <div class="menu-item-price">${item.p} ‚ÇΩ</div>
          ${q > 0
            ? `<div class="qty-ctrl">
                <button class="qty-btn" onclick="event.stopPropagation();adjQty(${item.id},-1)">‚àí</button>
                <span class="qty-num">${q}</span>
                <button class="qty-btn" onclick="event.stopPropagation();adjQty(${item.id},1)">+</button>
               </div>`
            : `<button class="add-btn" onclick='event.stopPropagation();quickAdd(${JSON.stringify(item).replace(/'/g,"&#39;")})'>+</button>`}
        </div>
      </div>
    </div>`;
}

function scrollCat(i, btn) {
  document.querySelectorAll('.menu-cat-tab').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  document.getElementById('ms'+i)?.scrollIntoView({behavior:'smooth', block:'start'});
}

// ‚îÄ‚îÄ‚îÄ –ú–û–î–ê–õ–ö–ê –¢–û–í–ê–†–ê ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function openModal(item) {
  if (typeof item === 'string') item = JSON.parse(item);
  modalItem = item; modalQty = 1; selectedOpt = null;
  document.getElementById('modalImg').innerHTML =
    (item.img ? `<img src="${item.img}" style="width:100%;height:100%;object-fit:cover;">` : `<span style="font-size:80px">${item.e}</span>`) +
    `<button class="modal-close" onclick="closeModal()">‚úï</button>`;
  document.getElementById('modalName').textContent   = item.n;
  document.getElementById('modalDesc').textContent   = item.d || '';
  document.getElementById('modalWeight').textContent = item.w || '';
  document.getElementById('modalQty').textContent    = '1';
  const ow = document.getElementById('modalOptsWrap');
  if (item.opts && item.opts.length) {
    const g = item.opts[0];
    document.getElementById('modalOptsTitle').textContent = g.g;
    document.getElementById('modalOpts').innerHTML = g.i.map((o,idx) =>
      `<div class="modal-opt ${idx===0?'selected':''}" onclick='pickOpt(this,${JSON.stringify(o)})'>
        <span class="modal-opt-name">${o.n}</span>
        <span class="modal-opt-price">${o.p>0?'+'+o.p+' ‚ÇΩ':'–±–µ—Å–ø–ª–∞—Ç–Ω–æ'}</span>
       </div>`
    ).join('');
    selectedOpt = g.i[0];
    ow.style.display = 'block';
  } else {
    ow.style.display = 'none';
  }
  updateModalPrice();
  document.getElementById('itemModal').classList.add('open');
}

function pickOpt(el, opt) {
  if (typeof opt === 'string') opt = JSON.parse(opt);
  document.querySelectorAll('.modal-opt').forEach(e => e.classList.remove('selected'));
  el.classList.add('selected');
  selectedOpt = opt;
  updateModalPrice();
}

function updateModalPrice() {
  if (!modalItem) return;
  const p = modalItem.p + (selectedOpt && selectedOpt.p > 0 ? selectedOpt.p : 0);
  document.getElementById('modalAddPrice').textContent = (p * modalQty) + ' ‚ÇΩ';
}

function changeModalQty(d) {
  modalQty = Math.max(1, modalQty + d);
  document.getElementById('modalQty').textContent = modalQty;
  updateModalPrice();
}

function addFromModal() {
  if (!modalItem || !currentRest) return;
  const on = selectedOpt ? selectedOpt.n : '';
  const op = selectedOpt ? (selectedOpt.p || 0) : 0;
  for (let i = 0; i < modalQty; i++) addToCart(modalItem, on, op);
  closeModal();
  showToast(modalItem.n + ' –¥–æ–±–∞–≤–ª–µ–Ω –≤ –∫–æ—Ä–∑–∏–Ω—É ‚úì');
}

function closeModal() {
  document.getElementById('itemModal').classList.remove('open');
  modalItem = null;
}
document.getElementById('itemModal').addEventListener('click', e => {
  if (e.target === document.getElementById('itemModal')) closeModal();
});

function quickAdd(item) {
  if (typeof item === 'string') item = JSON.parse(item);
  if (item.opts && item.opts.length) { openModal(item); return; }
  addToCart(item, '', 0);
  showToast(item.n + ' –¥–æ–±–∞–≤–ª–µ–Ω ‚úì');
  // –ü–µ—Ä–µ—Ä–∏—Å—É–µ–º –∫–Ω–æ–ø–∫–∏ –≤ –º–µ–Ω—é
  if (currentRest && currentRest.cats) {
    document.getElementById('menuItemsContainer').innerHTML =
      currentRest.cats.map((cat,ci) => `
        <div class="menu-section" id="ms${ci}">
          <div class="menu-section-title">${cat.n}</div>
          <div class="menu-items">${cat.items.map(i => renderMenuItem(i)).join('')}</div>
        </div>
      `).join('') + '<div style="height:80px;"></div>';
  }
}

// ‚îÄ‚îÄ‚îÄ –ö–û–†–ó–ò–ù–ê ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function addToCart(item, optName, optPrice) {
  if (!cart.items) cart = { slug: currentRest.slug, restName: currentRest.name, items: [] };
  if (cart.slug !== currentRest.slug) {
    if (!confirm(`–û—á–∏—Å—Ç–∏—Ç—å –∫–æ—Ä–∑–∏–Ω—É –æ—Ç "${cart.restName}"?`)) return;
    cart = { slug: currentRest.slug, restName: currentRest.name, items: [] };
  }
  const key = item.id + '_' + optName;
  const ex  = cart.items.find(i => i.key === key);
  if (ex) ex.qty++;
  else cart.items.push({ key, iid: item.id, n: item.n, p: item.p + optPrice, e: item.e, on: optName, qty: 1 });
  updateBadge();
}

function adjQty(iid, d) {
  if (!cart.items) return;
  const idx = cart.items.findIndex(i => i.iid === iid);
  if (idx < 0) return;
  cart.items[idx].qty += d;
  if (cart.items[idx].qty <= 0) cart.items.splice(idx, 1);
  if (!cart.items.length) cart = {};
  updateBadge();
  // –û–±–Ω–æ–≤–∏—Ç—å –º–µ–Ω—é –µ—Å–ª–∏ –æ—Ç–∫—Ä—ã—Ç–æ
  if (currentScreen === 'menu' && currentRest && currentRest.cats) {
    document.getElementById('menuItemsContainer').innerHTML =
      currentRest.cats.map((cat,ci) => `
        <div class="menu-section" id="ms${ci}">
          <div class="menu-section-title">${cat.n}</div>
          <div class="menu-items">${cat.items.map(i => renderMenuItem(i)).join('')}</div>
        </div>
      `).join('') + '<div style="height:80px;"></div>';
  }
}

function getQty(iid)   { return cart.items ? cart.items.filter(i=>i.iid===iid).reduce((s,i)=>s+i.qty,0) : 0; }
function getTotal()    { return cart.items ? cart.items.reduce((s,i)=>s+i.p*i.qty,0) : 0; }
function getCount()    { return cart.items ? cart.items.reduce((s,i)=>s+i.qty,0) : 0; }
function updateBadge() { const c=getCount(); document.getElementById('cartBadge').textContent=c>0?c:''; }
function clearCart()   { cart={}; updateBadge(); }

function renderCartScreen() {
  if (!cart.items || !cart.items.length) {
    document.getElementById('cartEmpty').style.display  = 'flex';
    document.getElementById('cartFilled').style.display = 'none';
    return;
  }
  document.getElementById('cartEmpty').style.display  = 'none';
  document.getElementById('cartFilled').style.display = 'block';
  document.getElementById('cartRestName').textContent = 'üì¶ ' + (cart.restName || '');
  document.getElementById('cartItemsList').innerHTML  = cart.items.map(ci => `
    <div class="cart-item">
      <div class="cart-item-emoji">${ci.e}</div>
      <div class="cart-item-body">
        <div class="cart-item-name">${ci.n}</div>
        ${ci.on ? `<div class="cart-item-opt">${ci.on}</div>` : ''}
      </div>
      <div style="display:flex;flex-direction:column;align-items:flex-end;gap:6px;">
        <div style="font-size:14px;font-weight:800;">${ci.p*ci.qty} ‚ÇΩ</div>
        <div style="display:flex;align-items:center;gap:6px;">
          <button class="cart-qty-btn" onclick="adjQty(${ci.iid},-1);renderCartScreen()">‚àí</button>
          <span class="cart-qty-num">${ci.qty}</span>
          <button class="cart-qty-btn" onclick="adjQty(${ci.iid},1);renderCartScreen()">+</button>
        </div>
      </div>
    </div>`).join('');
  const sub=getTotal(), fee=Math.round(sub*0.05), total=sub+fee;
  document.getElementById('summaryItems').textContent      = sub   + ' ‚ÇΩ';
  document.getElementById('summaryFee').textContent        = fee   + ' ‚ÇΩ';
  document.getElementById('summaryTotal').textContent      = total + ' ‚ÇΩ';
  document.getElementById('checkoutBtnTotal').textContent  = total + ' ‚ÇΩ';
}

// ‚îÄ‚îÄ‚îÄ –ü–†–û–ú–û–ö–û–î ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function applyPromo() {
  const code = document.getElementById('promoInput').value.trim().toUpperCase();
  if (!code) return;
  if (!TOKEN) { showToast('‚ùå –ù—É–∂–Ω–æ –≤–æ–π—Ç–∏ —á–µ—Ä–µ–∑ –±–æ—Ç–∞'); return; }
  showToast('‚è≥ –ü—Ä–æ–≤–µ—Ä—è—é –ø—Ä–æ–º–æ–∫–æ–¥...');
  const d = await api('/api/v1/promotions/apply_code', {
    code,
    place_slug: cart.slug || '',
    location:   { latitude: LAT, longitude: LON },
  });
  if (d && (d.discount || d.applied)) {
    const disc = d.discount || {};
    const txt  = disc.amount  ? `‚àí${disc.amount} ‚ÇΩ`
               : disc.percent ? `‚àí${disc.percent}%`
               : '—Å–∫–∏–¥–∫–∞ –ø—Ä–∏–º–µ–Ω–µ–Ω–∞';
    showToast('‚úÖ –ü—Ä–æ–º–æ–∫–æ–¥: ' + txt);
  } else {
    showToast('‚ùå ' + (d && d.message ? d.message : '–ü—Ä–æ–º–æ–∫–æ–¥ –Ω–µ –Ω–∞–π–¥–µ–Ω'));
  }
}

// ‚îÄ‚îÄ‚îÄ –û–§–û–†–ú–õ–ï–ù–ò–ï ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderCheckoutScreen() {
  const sub=getTotal(), fee=Math.round(sub*0.05), total=sub+fee;
  document.getElementById('checkoutAddr').textContent  = '–í–æ–ª–∂—Å–∫–∞—è –Ω–∞–±–µ—Ä–µ–∂–Ω–∞—è, 8';
  document.getElementById('checkoutTotal').textContent = total + ' ‚ÇΩ';
  document.getElementById('placeOrderTotal').textContent = total + ' ‚ÇΩ';
  document.getElementById('checkoutItems').innerHTML   = (cart.items||[]).map(ci =>
    `<div class="summary-row">
       <span class="summary-label">${ci.n}${ci.on?' ('+ci.on+')':''} √ó ${ci.qty}</span>
       <span class="summary-value">${ci.p*ci.qty} ‚ÇΩ</span>
     </div>`
  ).join('');
}

function selectPay(el, method) {
  document.querySelectorAll('.pay-option').forEach(o => o.classList.remove('selected'));
  el.classList.add('selected');
  selectedPay = method;
}

async function placeOrder() {
  const btn = document.getElementById('placeOrderBtn');
  btn.disabled = true;
  btn.textContent = '‚è≥ –û—Ñ–æ—Ä–º–ª—è—é –∑–∞–∫–∞–∑...';
  let nr = null;
  if (TOKEN && cart.slug) {
    const reqId   = crypto.randomUUID().replace(/-/g,'') + '.' + crypto.randomUUID().replace(/-/g,'');
    const comment = document.getElementById('checkoutComment').value;
    const d = await api('/api/v1/orders', {
      courier_options:    [],
      persons_quantity:   1,
      request_id:         reqId,
      location:           { latitude: LAT, longitude: LON },
      comment,
      payment:            { recently_link_cards: false },
      payment_method_id:  selectedPay==='sbp' ? 5 : selectedPay==='card' ? 2 : 1,
      place_slug:         cart.slug,
      phone:              '+70000000000',
      extended_options:   [{ type: 'delivery_options' }],
      address: {
        house:'8', short_text:'–í–æ–ª–∂—Å–∫–∞—è –Ω–∞–±–µ—Ä–µ–∂–Ω–∞—è, 8',
        country:'–†–æ—Å—Å–∏—è', city:'–ù–∏–∂–Ω–∏–π –ù–æ–≤–≥–æ—Ä–æ–¥', street:'–í–æ–ª–∂—Å–∫–∞—è –Ω–∞–±–µ—Ä–µ–∂–Ω–∞—è',
        location:{ latitude: LAT, longitude: LON }, type:{ id: 0 }
      },
      payment_information: {
        type: selectedPay, id: selectedPay+'_qr',
        costForCustomer: String(getTotal())
      }
    });
    if (d && d.order_nr) nr = d.order_nr;
  }
  if (!nr) {
    const d = new Date();
    nr = `${String(d.getDate()).padStart(2,'0')}${String(d.getMonth()+1).padStart(2,'0')}${String(d.getFullYear()).slice(-2)}-${Math.floor(1000000+Math.random()*9000000)}`;
  }
  clearCart();
  showOrderStatus(nr);
  btn.disabled = false;
}

function showOrderStatus(nr) {
  document.getElementById('orderNr').textContent = nr;
  const fmt = d => d.getHours()+':'+String(d.getMinutes()).padStart(2,'0');
  document.getElementById('step1time').textContent = fmt(new Date());
  goTo('order');
  setTimeout(() => {
    document.getElementById('step2dot').textContent = '‚úì';
    document.getElementById('step2dot').className  = 'track-dot done';
    document.getElementById('step3dot').className  = 'track-dot active';
    document.getElementById('step3time').textContent = '~10 –º–∏–Ω';
  }, 6000);
  setTimeout(() => {
    document.getElementById('step3dot').textContent = '‚úì';
    document.getElementById('step3dot').className   = 'track-dot done';
    document.getElementById('step4dot').className   = 'track-dot active';
    document.getElementById('step4time').textContent = fmt(new Date(Date.now()+5*60000));
  }, 14000);
}

// ‚îÄ‚îÄ‚îÄ –ù–ê–í–ò–ì–ê–¶–ò–Ø ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function goTo(screen) {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  document.getElementById('screen-'+screen).classList.add('active');
  document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
  const nb = document.getElementById('nav-'+screen);
  if (nb) nb.classList.add('active');
  const top  = document.getElementById('mainTopbar');
  const tabs = document.getElementById('catalogTabs');
  const bnav = document.getElementById('bottomNav');
  if (screen==='catalog') {
    top.style.display='block'; tabs.style.display='flex'; bnav.style.display='flex';
  } else if (screen==='menu') {
    top.style.display='none'; tabs.style.display='none'; bnav.style.display='flex';
  } else if (screen==='cart') {
    top.style.display='none'; tabs.style.display='none'; bnav.style.display='flex';
    renderCartScreen();
  } else if (screen==='checkout') {
    top.style.display='none'; tabs.style.display='none'; bnav.style.display='none';
    renderCheckoutScreen();
  } else if (screen==='order') {
    top.style.display='none'; tabs.style.display='none'; bnav.style.display='none';
  } else if (screen==='profile') {
    top.style.display='none'; tabs.style.display='none'; bnav.style.display='flex';
    if (!profile) {
      document.getElementById('profileName').textContent = TOKEN ? '–ó–∞–≥—Ä—É–∑–∫–∞...' : '–ì–æ—Å—Ç—å';
      document.getElementById('profileUid').textContent  = TOKEN ? '' : '–í–æ–π–¥–∏—Ç–µ —á–µ—Ä–µ–∑ –±–æ—Ç–∞';
    }
  }
  currentScreen = screen;
  document.getElementById('mainContent').scrollTo(0, 0);
}

function selectTab(t, btn) {
  document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  if (t==='offline') showToast('–ö–∞—Ä—Ç–∞ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–æ–≤ —Å–∫–æ—Ä–æ –±—É–¥–µ—Ç');
}

let toastT;
function showToast(msg) {
  const el = document.getElementById('toast');
  el.textContent = msg;
  el.classList.add('show');
  clearTimeout(toastT);
  toastT = setTimeout(() => el.classList.remove('show'), 2800);
}

goTo('catalog');
</script>
</body>
</html>
